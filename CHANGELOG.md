### State
- Opened PR #50: versioned `StateBundle` schema (v1) with validation and deterministic source hash. Tracked in `FEATURE_CHECKLIST.md`. (develop-only admin update)
- Opened PR #51 (draft): atomic save/load with secure dir validation, quarantine on corruption, and coarse advisory lock. Tracked in `FEATURE_CHECKLIST.md`. (develop-only admin update)
- [ ] Tool: citation_pack — OPEN: https://github.com/hyperifyio/goagent/pull/40
- [ ] Tool: dedupe_rank — OPEN: https://github.com/hyperifyio/goagent/pull/39
- [ ] Tool: github_search — OPEN: https://github.com/hyperifyio/goagent/pull/38
- [ ] Tool: crossref_search — OPEN: https://github.com/hyperifyio/goagent/pull/37
- [ ] Tool: openalex_search — OPEN: https://github.com/hyperifyio/goagent/pull/36
- [ ] Tool: wiki_query — OPEN: https://github.com/hyperifyio/goagent/pull/35
- [ ] Tool: pdf_extract — OPEN: https://github.com/hyperifyio/goagent/pull/34
- [ ] Tool: searxng_search — OPEN: https://github.com/hyperifyio/goagent/pull/33
PR slicing plan (tracked on develop; code PRs will branch from main in `./work/main`):
  - [ ] Tool: img_create — OPEN: https://github.com/hyperifyio/goagent/pull/26
  - [ ] Tool: http_fetch — OPEN: https://github.com/hyperifyio/goagent/pull/27
  - [ ] Tool: robots_check — OPEN: https://github.com/hyperifyio/goagent/pull/28
  - [ ] Tool: readability_extract — OPEN: https://github.com/hyperifyio/goagent/pull/29
  - [ ] Tool: metadata_extract — OPEN: https://github.com/hyperifyio/goagent/pull/30
  - [ ] Tool: rss_fetch — OPEN: https://github.com/hyperifyio/goagent/pull/31
  - [ ] Tool: wayback_lookup — OPEN: https://github.com/hyperifyio/goagent/pull/32
- [ ] PR: Makefile wiring for tools (build-tools/clean)
- [ ] PR: scripts and CI utilities — OPEN: https://github.com/hyperifyio/goagent/pull/42
- [ ] PR: security & runbooks — OPEN: https://github.com/hyperifyio/goagent/pull/43
- [ ] PR: ADRs
  - [ ] ADR-0011: State bundle schema — OPEN: https://github.com/hyperifyio/goagent/pull/48
  - [ ] ADR-0012: State dir persistence — OPEN: https://github.com/hyperifyio/goagent/pull/49
- [ ] PR: diagrams
- [ ] PR: CLI features (version, print-config, timeouts/backoff, validator, enable/disable)
- [ ] PR: parallel tool calls (main loop)
- [ ] PR: audit logs and redaction
- [ ] PR: minimal integration test
- [ ] PR: README finalization and examples
- [ ] Post-migration cleanup

### Sandbox
- Opened PR #52: limits utilities (bounded output buffer, wall-time helper, JSON error helper). Tracked in `FEATURE_CHECKLIST.md`. (develop-only admin update)

* [x] Initialize repo with Go module and scaffolding: run `mkdir agentcli && cd agentcli && git init && go mod init github.com/<org>/agentcli`; add `LICENSE` (MIT), `README.md` (purpose, usage, examples), `.gitignore` (bin/, dist/, .DS_Store, go.work, .idea, .vscode); create directories `cmd/agentcli`, `internal/oai`, `internal/tools`, `docs/adr`, `docs/diagrams`; set default model id `oss-gpt-20b` and default OpenAI-compatible base URL `https://api.openai.com/v1` to be read from env or flags.
* [x] Implement `cmd/agentcli/main.go` non-interactive run loop: `package main` with `main()` reading flags, building initial messages `[system,user]`, calling the HTTP client, executing any returned tool calls, appending tool results as `role=tool` messages, repeating until the model returns a final assistant message with text, then printing to stdout and exiting 0; all failures print a concise error to stderr and exit non-zero (2 for CLI misuse like missing `-prompt`, 1 otherwise).
* [x] Implement full CLI flag set with defaults and env fallbacks: `-prompt (string, required)`, `-tools (path to tools.json, optional)`, `-system (string, default "You are a helpful, precise assistant. Use tools when strictly helpful.")`, `-base-url (string, default env OAI_BASE_URL or https://api.openai.com/v1)`, `-api-key (string, default env OAI_API_KEY)`, `-model (string, default env OAI_MODEL or oss-gpt-20b)`, `-max-steps (int, default 8)`, `-timeout (duration, default 30s, applies to HTTP and tool exec unless tool overrides)`, `-temp (float64, default 0.2)`, `-debug (bool, default false, dumps request/response JSON to stderr)`; precedence: flag > env > hard default; validate `-prompt` non-empty before running.
* [x] Implement OpenAI-compatible client (POST `/v1/chat/completions`): define request types `{model, messages[], tools[], tool_choice:"auto", temperature}` and response types `{choices[].message{role,content,tool_calls[]}, choices[].finish_reason}`; send `Authorization: Bearer <api-key>` if provided; `Content-Type: application/json`; use `http.Client{Timeout: <timeout>}`; treat any non-2xx as error with body included; support `finish_reason` but not required to stop if you already have final content; never stream in MVP.
* [x] Wire default config for oss-gpt-20b: honor `OAI_MODEL=oss-gpt-20b`, `OAI_BASE_URL=https://api.openai.com/v1`, and `OAI_API_KEY=<token>`; document that any OpenAI-compatible endpoint can be used by changing `-base-url` and `-model`; ensure no hard dependency on OpenAI SDKs (pure net/http).
* [x] Implement tool manifest loader `internal/tools/manifest.go`: load `tools.json`; schema per tool `{ "name": string (required, unique), "description": string, "schema": object (JSON Schema for params), "command": [string,...] (argv, required), "timeoutSec": int (optional per-call) }`; validate: name non-empty, command len>=1, names unique; build a registry `map[string]ToolSpec` and an OpenAI “tools” array `[{type:"function", function:{name,description,parameters}}]`; return both; on parse/validation error, fail fast with clear message including tool name.
* [x] Implement secure tool runner `internal/tools/runner.go`: execute tools via `exec.CommandContext(ctx, argv[0], argv[1:]...)`; pass function arguments string verbatim to tool stdin (JSON), capture stdout (string) and stderr; apply timeout: prefer per-tool `timeoutSec`, else global `-timeout`; scrub environment to a minimal allowlist (PATH and HOME only); never invoke a shell; return stdout as the tool result string; on timeout return error "tool timed out", on non-zero exit return error including stderr snippet.
* [x] Implement assistant tool-call loop in `main.go`: request includes `tool_choice:"auto"` and declared tools; when assistant message contains `tool_calls`, iterate each call with `type:"function"`, find spec by `function.name`; if unknown, synthesize a tool result `{"error":"unknown tool <name>"}`; for each executed call, append a message `{role:"tool", name:<function.name>, tool_call_id:<id>, content:<tool stdout or error JSON>}`; then immediately call the API again with the extended transcript; stop when assistant returns content and zero tool_calls; print content to stdout.
* [x] Map tool failures deterministically to JSON error content: on any runner error, set tool message content to a single-line JSON `{"error":"<sanitized message>"}` where message is JSON-escaped and truncated (e.g., to 1k chars) to avoid prompt bloat; do not exit on individual tool errors—let the model decide recovery; only exit non-zero if the overall run loop ends without producing final assistant text or if the HTTP call fails.
* [x] Provide example tool `tools/cmd/get_time` and build instructions: implements `stdin` JSON `{"tz":"Europe/Helsinki"}` (default `"UTC"` if omitted); outputs single-line JSON `{"tz":"...","iso":"RFC3339","unix":<seconds>}` to stdout; returns exit code 0 on success; build with `make build-tools` (emits `./tools/bin/get_time`); usage example prompt: “What’s the local time in Helsinki? If tools are available, call get_time.”; confirm tool respects `TZ` value strictly via `time.LoadLocation`.
* [x] Provide example `tools.json` colocated at repo root: `{ "tools":[ { "name":"get_time", "description":"Get current time for an IANA timezone", "schema":{ "type":"object", "properties":{ "tz":{"type":"string","description":"IANA timezone, e.g. Europe/Helsinki"} }, "required":["tz"], "additionalProperties":false }, "command":["./tools/bin/get_time"], "timeoutSec":5 } ] }`; document that `command` is relative to the working directory of `agentcli`.
* [x] Add build targets: root `Makefile` with `build: go build -o bin/agentcli ./cmd/agentcli`, `build-tools: make build-tools` (emits `tools/bin/*`), `lint`, `test`, `clean`; ensure `CGO_ENABLED=0` for reproducible static binaries; support `GOOS`/`GOARCH` overrides for cross-compilation; add `bin/` and built tools to `.gitignore`.
* [x] Write README quickstart that is fully runnable: prerequisites (Go 1.21+), `make build build-tools`, export `OAI_BASE_URL`, `OAI_MODEL=oss-gpt-20b`, `OAI_API_KEY` if required, then run `./bin/agentcli -prompt "What's the local time in Helsinki? Use get_time." -tools ./tools.json -debug`; explain expected behavior (model triggers function call, tool prints JSON, agent posts back, model replies with final text), and show sample output line and non-zero exit behavior on errors.
* [x] Add ADR-0001 documenting architecture and protocol: create `docs/adr/0001-minimal-agent-cli.md` containing context (non-interactive CLI agent with OpenAI-compatible API and local tools), options considered (Go vs Python vs local inference), decision (Go + Chat Completions tools + argv tools), rationale (static binary, process control, vendor-agnostic), consequences (no streaming in MVP, single-threaded tool calls), and a link to the canonical GitHub issue; include explicit contracts for CLI flags and tool I/O in the ADR.
* [x] Add Mermaid sequence diagram kept in repo: `docs/diagrams/agentcli-seq.md` with a `sequenceDiagram` that shows CLI → API → tool → API → final response; reference this file from both `README.md` and ADR-0001; require updates to diagram in any PR that changes the loop or message flow.
* [x] Implement unit tests (deterministic) for manifest, runner, and client: `internal/tools/manifest_test.go` verifies invalid/missing fields and uniqueness errors; `internal/tools/runner_test.go` includes a helper tool binary that sleeps to trigger timeout and asserts `"tool timed out"` mapping; `internal/oai/client_test.go` uses `httptest.Server` to return 500 and asserts error includes status and body; tests must run offline and pass on `go test ./...`.
* [x] Implement conversation-loop test using `httptest.Server` and a fake tool: server step 1 responds with assistant message containing `tool_calls=[{id:"1",type:"function",function:{name:"echo",arguments:"{\"text\":\"hi\"}"}}]`; fake tool reads stdin `{"text":"hi"}` and prints `{"echo":"hi"}`; server step 2 returns final assistant message `"done"`; run `agentcli` main via a small wrapper (or extract loop into testable function) and assert stdout equals `"done\n"` and exit code 0.
* [x] Document security posture and trust boundaries in README: tools are an explicit allowlist (`tools.json`); no shell invocation (argv only); stdin/stdout JSON contract; per-call timeouts; minimal environment; recommend running untrusted tools under containment (container/jail/user namespace) and setting a working directory with restricted permissions; clarify that the model is untrusted input—never pass its arguments to a shell; state that secrets must be supplied via env/CI secrets and never committed.
* [x] Output an error if any configured tool is missing and unavailable
* [x] Improve .cursor/rules/work-on-features.mdc to instruct that files must be deleted using `git rm ...` command
* [x] Implement `tools/exec.go` (unrestricted command exec) — stdin `{"cmd":"string","args":["..."],"cwd?:string,"env?:{K:V},"stdin?:string,"timeoutSec?:int}`; run via `exec.CommandContext` (no shell), full network allowed; stdout single-line JSON `{"exitCode":int,"stdout":"string","stderr":"string","durationMs":int}`; DoD: TDD unit + integ tests (success, non-zero, timeout, cwd/env, stdin), README example, traced to issue, CI green with coverage unchanged.
* [x] Implement `tools/fs_read_file.go` — stdin `{"path":"string","offsetBytes?:int,"maxBytes?:int}` (repo-relative); outputs `{"contentBase64":"string","sizeBytes":int,"eof":bool}`; DoD: tests (text, binary round-trip, ranges, NOT_FOUND), docs example, link to issue, CI green.
* [x] Implement `tools/fs_write_file.go` (atomic write) — stdin `{"path":"string","contentBase64":"string","createModeOctal?":"0644"}`; write via temp+rename; outputs `{"bytesWritten":int}`; DoD: tests (create, overwrite, binary, missing parent error), docs example, CI green.
* [x] Implement `tools/fs_append_file.go` — stdin `{"path":"string","contentBase64":"string"}`; append (create if missing) with advisory file lock; outputs `{"bytesAppended":int}`; DoD: tests (double append, concurrent writers), docs example, CI green.
  - [x] [S01] stub types and argument validation for fs_append_file (repo-relative path, base64 decode)
  - [x] [S02] failing contract test for double append (create-if-missing, then append)
  - [x] [S03] minimal passing implementation for single-writer append with advisory lock (no concurrency test yet)
  - [x] [S04] add concurrent writers test (two goroutines append deterministically; order-agnostic content length assertion)
  - [x] [S05] strengthen implementation to pass concurrency test and add README docs example
* [x] Implement `tools/fs_mkdirp.go` — stdin `{"path":"string","modeOctal?":"0755"}`; recursively create; outputs `{"created":bool}`; DoD: tests (deep path, idempotence), docs example, CI green.
  - [x] [S01] implement minimal mkdirp behavior and docs example; tests pass offline
* [x] Implement `tools/fs_rm.go` — stdin `{"path":"string","recursive?:bool,"force?:bool}`; remove file/dir; outputs `{"removed":bool}`; DoD: tests (file, dir tree, force on missing), docs example, CI green.
  - [x] [S01:rm-delete-file-test] failing unit test for deleting a regular file
  - [x] [S02:rm-delete-file-impl] minimal implementation to delete a regular file and pass S01
  - [x] [S03:rm-force-on-missing-test] unit test for force=true on missing path (expects exit 0 and removed=false)
  - [x] [S04:rm-readme-example] README example and Makefile build rule for fs_rm; tests pass
* [x] Implement `tools/fs_move.go` — stdin `{"from":"string","to":"string","overwrite?:bool}`; rename or copy+remove across devices; outputs `{"moved":bool}`; DoD: tests (rename, overwrite=false blocks, cross-device), docs example, CI green.
  - [x] [S03:move-overwrite-true] unit test for overwrite=true replacing existing destination; ensure implementation passes
* [x] Add docs/README.md as a short index and navigation for the docs tree with cross links to docs/adr/0001-minimal-agent-cli.md and docs/diagrams/agentcli-seq.md, smallest change is creating the index and adding links from the top level README and ADR, scope limited to documentation, low risk and independent, DoD includes tests unchanged and green with no coverage regression, build reproducible, static analysis type checks formatting linting security scanning and secret detection all green, backward compatibility unaffected, docs updated in the same change, at least one peer review completed and linked, verification by rendering links on GitHub, rollback by reverting the file and cross links, traceability 
  - [x] [S01:docs-index] create `docs/README.md` index with links to ADR-0001 and sequence diagram
  - [x] [S02:cross-links] add links from top-level `README.md` and ADR-0001 back to `docs/README.md`
* [x] Write docs/architecture/module-boundaries.md to define allowed imports and layering between cmd internal/oai internal/tools and tools binaries, include a simple Mermaid diagram and guidance for adding new packages, smallest change is adding this single document and linking it from docs/README.md and README, scope documentation, low risk, DoD includes tests unchanged and green with no coverage regression all quality gates green backward compatibility preserved docs and changelog updated as needed peer review completed verification by rendering diagram on GitHub and checking links rollback by reverting the doc and links, traceability 
  - [x] [S01:module-boundaries-doc] add module-boundaries doc and cross‑links from `README.md` and `docs/README.md`
* [x] Keep Makefile clean target symmetrical with build-tools by also removing tools/fs_search (currently omitted) so stale tool binaries are not left behind; smallest change is adding tools/fs_search to the clean recipe; scope Makefile; low risk; DoD includes running make build-tools then make clean leaves no built tool binaries (git status clean), tests unchanged and green, all quality gates green, peer review completed, verification by the described commands, rollback by reverting the Makefile change.
* [x] Reconcile minimum Go version by setting a single supported floor across go.mod and README.md (go.mod currently declares go 1.24.6 while README states Go 1.21+); smallest change is either lowering the go directive in go.mod to 1.21 to match docs or updating README (and future CI matrix) to 1.24+; scope limited to go.mod, docs, and CI config when added; low risk; DoD includes tests unchanged and green with no coverage regression, reproducible build, all quality gates green (vet/format/lint/security/secret detection) with no new findings, backward compatibility preserved, at least one peer review completed, verification by building on the declared floor version locally and in CI, rollback by reverting the version/doc change.
* [x] Update README.md fs_mkdirp example to remove the outdated note “until aggregated in Makefile” and use the existing make build-tools step consistently; smallest change is editing that section only; scope documentation; low risk; DoD includes tests unchanged and green, all quality gates green, README renders correctly on GitHub, peer review completed, verification by running the example from a clean clone after make build build-tools, rollback by reverting the edit.
* [x] Align the get_time tool contract across tools/timecli (expects {"timezone":"..."} and outputs {"timezone","iso8601"}), README.md (describes tz and unix seconds), and tools.json (declares required tz) by choosing one canonical schema (prefer timezone with optional alias tz) and updating code, tests, and docs accordingly; smallest change is adding a backward-compatible alias in code and adjusting docs/manifest; scope limited to this tool; low risk; DoD includes unit test covering both inputs and output fields, README quick start and tools.json updated, all quality gates green with no coverage regression, peer review completed, verification by running the quick start end-to-end, rollback by reverting the edits.
* [x] Normalize API key environment variable naming across the repo to OAI_API_KEY (scripts like scripts/smoke-test.sh currently reference OPENAI_API_KEY) and document the canonical variable in README.md while keeping the old name as a fallback for compatibility; smallest change is updating the script to prefer OAI_API_KEY with OPENAI_API_KEY fallback and adjusting docs; scope small; low risk; DoD includes tests unchanged and green, all gates green, verification by running the script with only OAI_API_KEY set and observing successful auth header injection, rollback by reverting the script and doc changes.
* [x] Create docs/reference/tools-manifest.md that precisely documents the tools.json schema required and optional fields validation rules examples and common mistakes and how schemas are exposed to the model, smallest change is a focused reference page and links from README usage and ADR-0001, scope documentation, low risk, DoD includes examples runnable locally tests unchanged and green all quality gates green backward compatibility unaffected peer review completed verification by running example commands and rendering on GitHub rollback by removing the doc and links, traceability 
  - [x] [S01:manifest-doc] create `docs/reference/tools-manifest.md` reference page
  - [x] [S01b:manifest-unblock-green] stabilize tools tests or restore missing tool packages so docs-only changes keep test suite green
    - [x] [S01b-a:restore-missing-tool-dirs] restore missing tool packages: `tools/fs_append_file`, `tools/fs_move`, `tools/fs_rm`, `tools/fs_write_file` (add minimal `main` stubs to compile; behavior tests to pass in later slices)
  - [x] [S02:manifest-links] add links from `README.md`, `docs/README.md`, and ADR-0001
* [x] Author docs/security/threat-model.md expanding on trust boundaries untrusted model output handling tool containment recommendations secrets handling logging and redaction expectations and audit considerations, smallest change is adding this page and linking it from README Security model, scope documentation, low risk, DoD includes tests unchanged and green all quality gates green backward compatibility unaffected peer review completed verification by reviewing content accuracy and link rendering rollback by reverting the doc and links, traceability 
* [x] Provide docs/runbooks/troubleshooting.md covering common errors and fixes including missing tool binaries repo relative path violations tool timeouts HTTP errors and golangci-lint installation path with copy paste commands, smallest change is adding this runbook and linking from README Troubleshooting, scope documentation, low risk, DoD includes steps verified on a clean clone tests unchanged and green all quality gates green peer review completed verification by following steps locally rollback by reverting the doc and links, traceability 
* [x] Fix tools/timecli error contract to write errors to stderr and exit non-zero instead of printing error JSON to stdout so the runner maps failures to {"error":"..."} deterministically; smallest change is adjusting error paths in tools/timecli/main.go and adding focused unit tests; scope limited to timecli and tests; low risk; DoD includes failing test first then passing after change, README examples still work, tests elsewhere unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by piping invalid input and observing non-zero exit with stderr JSON, rollback by reverting the edits.
* [x] Reconcile model identifier in README quick start with default OAI_MODEL by choosing one canonical value (currently README uses openai/gpt-oss-20b while defaults use oss-gpt-20b) and updating docs accordingly; smallest change is editing README only; scope documentation; low risk; DoD includes docs render correctly, examples runnable from a clean clone, tests unchanged and green, all quality gates green, peer review completed, verification by running the quick start with the documented model, rollback by reverting the edit.
* [x] Implement `tools/fs_search.go` — stdin `{"query":"string","regex?:bool,"globs?:["**/*.go"],"maxResults?:int}`; returns `{"matches":[{"path":"string","line":int,"col":int,"preview":"string"}],"truncated":bool}`; DoD: tests (literal, regex, glob filter, truncation), docs example, CI green.
  - [x] [S01:search-failing-literal-test] add failing unit test for literal search on a small fixture file (no regex, no globs)
  - [x] [S02:search-skeleton] scaffold minimal `tools/fs_search` program with argument parsing/types
  - [x] [S03:search-impl-literal] minimal implementation to pass literal search test
  - [x] [S04:search-regex-glob-tests] add tests for regex and glob filtering
  - [x] [S05:search-truncation] implement maxResults truncation and test
* [x] Update scripts/smoke-test.sh to remove goresearch and SearxNG checks and make it goagent-specific retaining only the OpenAI-compatible LLM health check and clarifying messages; smallest change is editing the script header and deleting the Searx section; scope scripts; low risk; DoD includes script runs locally and reports PASS/FAIL for LLM reachability without Docker or Searx, tests unchanged and green, all quality gates green, peer review completed, verification by executing the script on a clean clone, rollback by reverting the script change.
  - [x] [S01:build-tools-entries] include `fs_mkdirp` and `fs_apply_patch` in `build-tools` and `clean`; align README fs_mkdirp example to use `make build-tools`
* [x] Update README with “unrestricted tools” warning + examples — clear risk note, copy-paste examples for each fs/* and exec tool, troubleshooting; DoD: docs lint passes, examples exercised in CI script, CI green.
  - [x] [S01:adr-file-and-links] create ADR file and add links from `README.md` and `docs/README.md`
* [x] Add Mermaid diagram `docs/diagrams/toolbelt-seq.md` — sequence of CLI → API → tools → API → final; DoD: diagram renders on GitHub, referenced from README/ADR, updated test ensuring file exists, CI green.
* [x] Example prompts `examples/unrestricted.md` — prompts demonstrating `exec` + fs tools to write, build, and run code; DoD: examples validated by CI script, README link, CI green.
* [x] Implement `tools/fs_apply_patch.go` (unified diff) — stdin `{"unifiedDiff":"string","dryRun?:bool}`; strict apply (no fuzz), pre-validate with dry-run; outputs `{"filesChanged":int}`; DoD: tests (clean apply, conflict, idempotence, CRLF), docs example + cautions, CI green.
  - [x] [S01:fs-apply-patch-stub] add stub tool validating input and exiting with NOT_IMPLEMENTED; build and tests remain green; groundwork for strict apply
  - [x] [S02:fs-apply-clean-new-file] implement strict new-file unified diff apply and tests (clean apply creating a new file); umbrella remains open for conflict/idempotence/CRLF and docs
* [x] Implement tools/fs_edit_range.go — stdin {"path":"string","startByte":int,"endByte":int,"replacementBase64":"string","expectedSha256?":"string"}; atomically rewrite by splicing the range; output {"bytesReplaced":int,"newSha256":"string"}; DoD: TDD for mid-file edits, boundary cases (start=0, end=size), binary content, concurrent calls serialized, docs + CI green.
  - [x] [S01:fs-edit-mid] add failing mid-file splicing test ensuring bytes [start:end) replaced and SHA reported
  - [x] [S02:fs-edit-mid-impl] minimal implementation to pass mid-file splicing and boundary cases; tests green
  - [x] [S03:fs-edit-lock] serialize concurrent edits with advisory file lock and add concurrency test; tests green
* [x] Implement tools/fs_read_lines.go — stdin {"path":"string","startLine":int,"endLine":int,"maxBytes?":int}; output {"content":"string","startLine":int,"endLine":int,"eof":bool}; DoD: TDD for LF/CRLF, UTF-8 multibyte safety, large files, docs + CI green.
* [x] Implement `tools/fs_listdir.go` — stdin `{"path":"string","recursive?:bool,"globs?:["**/*"],"includeHidden?:bool,"maxResults?:int}`; outputs `{"entries":[{"path":"string","type":"file|dir|symlink","sizeBytes":int,"modeOctal":"string","modTime":"RFC3339"}],"truncated":bool}`; paths repo-relative, stable ordering (dirs first, then files, lexicographic); DoD: TDD (empty dir, files+dirs, hidden on/off, glob filters, recursion, truncation, symlink entry), README example, linked issue, CI green with coverage unchanged.
  - [x] [S02:listdir-readme-example] add README `fs_listdir` example section and ensure tests remain green
  - [x] [S01:listdir-tools-manifest] add `fs_listdir` tool entry to `tools.json` and ensure tests remain green
* [x] Implement `tools/fs_stat.go` — stdin `{"path":"string","followSymlinks?:bool,"hash?: "none"|"sha256"}`; outputs `{"exists":bool,"type":"file|dir|symlink|other","sizeBytes":int,"modeOctal":"string","modTime":"RFC3339","sha256?":"string"}`; error on paths outside repo; DoD: TDD (file/dir/symlink, missing path, follow vs no-follow, optional hash), README example, linked issue, CI green.
  - [x] [S01:fs-stat-file-test] add failing unit test for existing regular file reporting exists=true, type="file", and sizeBytes
  - [x] [S02:fs-stat-file-impl] minimal implementation to pass file test
  - [x] [S03:fs-stat-missing] add test for missing path returns exit 0 and exists=false
  - [x] [S04:fs-stat-symlink+hash-tests] add tests for symlink follow/no-follow and sha256 output
* [x] Extend `tools.json` with new tools — add entries (name, description, JSON Schema, `command`, `timeoutSec`); loader must validate and surface schemas to OpenAI tools; DoD: manifest unit test (schema validity, names unique), sample `tools.json` updated, CI green.
* [x] Add Makefile build rules for all new tools — `build-tools` compiles each `./tools/*.go` to deterministic static binaries; DoD: `make build build-tools` passes locally and CI, artifacts gitignored, docs updated.
  - [x] [S02:gitignore-binaries] ignore built tool binaries (`tools/*/*` and single-file outputs) and untrack existing ones; verify `git status` clean after `make build-tools` and `make clean`
* [x] Integrate tools into agent loop — ensure `agentcli` advertises schemas and executes tool calls end-to-end; DoD: integration test with fake API that triggers `fs_write_file` → `fs_read_file` → final message, README cross-referenced, CI green.
* [x] Add execution audit log in runner — append ndjson `{ts,tool,argv,cwd,exit,ms,stdoutBytes,stderrBytes,truncated}` to `.goagent/audit/YYYYMMDD.log`; DoD: unit test writes/rotates, redaction respected (see next), docs, CI green.
  - [x] [S01:audit-write-line] append NDJSON audit to `.goagent/audit/YYYYMMDD.log` and add unit test verifying a line is written with expected fields; CI green.
  - [x] [S02:audit-rotation] verify daily rotation behavior across date boundary with unit test; CI green.
  - [x] [S03:audit-redaction] implement sensitive-value redaction and document fields; tests and docs; CI green.
* [x] Provide “capabilities” CLI (`agentcli -capabilities`) — prints enabled tools from `tools.json` and explicit warning that enabled tools allow arbitrary command execution and network access; DoD: unit test, README usage, CI green.
* [x] Add ADR-0002 “Unrestricted toolbelt (files+network)” — context, options, decision, consequences, JSON contracts, link to issue; DoD: ADR committed, referenced from README, peer-reviewed, CI doc checks green.
* [x] Remove unused duplicate exec implementation by deleting tools/execcli and consolidating the exec tool under tools/cmd/exec to avoid drift and dual maintenance; smallest change is removing the tools/execcli directory with git rm and adjusting any references if present (tests currently use `tools/bin/exec`); scope tools; low risk; DoD includes a failing dead-code check first (build/grep) then passing after removal, tests unchanged and green with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security scanning and secret detection) with no new findings, reproducible builds, README exec example still runs end to end, peer review completed, verification by running go test ./... and make build-tools from a clean clone and confirming no references to execcli remain, rollback by restoring the directory from Git.
* [x] Remove the no-op jitter and unneeded math/rand import in internal/tools/runner.go to reduce accidental complexity and potential lint noise; smallest change is deleting the unused rand.Int() call and its import; scope internal/tools; low risk; DoD includes a focused unit test asserting deterministic stdout/stderr collection without flakiness, tests otherwise unchanged and green with race/coverage, all quality gates green with no new findings, peer review completed, verification by running the test suite repeatedly and observing stability, rollback by restoring the line if flakiness reappears.
* [x] Update scripts/wait-for-health.sh to drop SearxNG and Docker Compose checks and poll only the OpenAI-compatible LLM models endpoint to align with this repo’s scope; smallest change is editing that single script only; scope scripts; low risk; DoD includes reproducing the current mixed-scope behavior then passing after the edit with tests elsewhere unchanged and green and no coverage regression, all quality gates green (vet/format/lint/security/secret detection) with no new findings, verification by running the script with LLM_BASE_URL set and observing timely success/failure for the models endpoint, and rollback by reverting the script change.
* [x] Teach the CLI to accept OPENAI_API_KEY as a fallback when OAI_API_KEY is unset to improve compatibility with existing environments and scripts while keeping OAI_API_KEY canonical in docs, smallest change is adding an env fallback in cmd/agentcli/main.go only; scope CLI; low risk; DoD includes a focused unit test for env resolution precedence (flag > OAI_API_KEY > OPENAI_API_KEY > default), tests otherwise unchanged and green with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security scanning and secret detection) with no new findings, peer review completed, verification by running the CLI with only OPENAI_API_KEY set and observing the Authorization header present, rollback by reverting the change.
* [x] Normalize environment variable names across scripts to prefer OAI_BASE_URL and OAI_MODEL with fallback from existing LLM_BASE_URL so users have one canonical set while keeping compatibility, smallest change is editing scripts to read OAI variables first with LLM fallbacks and adjusting README wording, scope scripts and docs, low risk; DoD includes running smoke and health scripts with only OAI_* set and observing success, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by executing the scripts locally, rollback by reverting the edits.
  - [x] [S01:l98-submodule-update] Update `scripts` submodule to modify `wait-for-health.sh` and `smoke-test.sh` to prefer `OAI_*` with `LLM_*` fallback; commit in submodule and bump superproject pointer.
* [x] Unify tool hierarchy so each tool’s binary is in ./tools/bin/NAME, source in ./tools/cmd/NAME/NAME.go, and tests in ./tools/cmd/NAME/NAME_test.go, updating Makefile, tools.json, documentation, tests, and all other affected places to use a consistent unique naming format.
  - [x] [S01:l90-make-bin-outputs] Update `Makefile` to emit binaries under `tools/bin/NAME` while keeping legacy outputs for transition; tests green.
  - [x] [S54:l90-lint-wire-path-guard] Amend `Makefile` `lint` target to invoke `$(MAKE) check-tools-paths` after golangci-lint/vet/format so path hygiene is enforced locally and in CI; DoD: running `make lint` on current branch fails due to legacy `./tools/<name>` references and passes after migration slices, scope limited to `Makefile`, tests unchanged and green.
  - [x] [S54a:l90-unblock-tests-legacy-dirs] Unblock S54 by restoring legacy tool source dirs expected by tests (e.g., `tools/exec`, `tools/fs_write_file`, `tools/fs_append_file`, ...), or adjust tests to current layout so `go test ./...` is green before committing S54.
  - [x] [S55:l90-guard-single-file-builds] Extend `check-tools-paths` (Makefile) to also fail on single-file or direct tool builds outside the canonical layout using a search like `rg -n '(\./tools/[a-z_]+\.go|go\s+(build|run)\s+.*\./tools/[a-z_]+)' -g '!tools/cmd/**' -g '!tools/bin/**' -g '!FEATURE_CHECKLIST.md'` across the repo; DoD: `make check-tools-paths` fails before migration and passes after, no behavior changes elsewhere.
  - [x] [S56:l90-runbook-windows-examples] Update `docs/runbooks/troubleshooting.md` examples to include Windows variants using `./tools/bin/NAME.exe` alongside Unix `./tools/bin/NAME` so users on Windows can follow identical steps; DoD: doc renders on GitHub, and `rg -n '\.exe' docs/runbooks/troubleshooting.md` finds at least one tool invocation; tests unchanged and green.
  - [x] [S57:l90-manifest-doc-errors] Document new validator errors in `docs/reference/tools-manifest.md` under “Common mistakes” (messages for relative `command[0]` not starting with `./tools/bin/` and for normalized escapes like `./tools/bin/../hack`), aligning wording with `internal/tools/manifest.go`; DoD: docs render, and `rg -n 'start with \\./tools/bin|escapes \\./tools/bin' docs/reference/tools-manifest.md` matches; tests unchanged and green.
  - [x] [S49:l90-windows-bin-extensions] Update `Makefile` `build-tools` and `clean` recipes to emit `.exe` suffix when `GOOS=windows` for all binaries under `tools/bin/NAME(.exe)` and to remove them on `make clean`; verify by `GOOS=windows make build-tools` producing `tools/bin/{get_time,exec,fs_*}.exe` and `make clean` leaving `git status` clean; DoD: commands reproducible on Linux/macOS cross-compiling to Windows, tests unchanged and green.
  - [x] [S50:l90-docs-windows-exe] Document OS-specific binary names in `docs/reference/tools-manifest.md` and `README.md` (Quick start and tool examples): require relative `command[0]` to use `./tools/bin/NAME` on Unix and `./tools/bin/NAME.exe` on Windows, with a short note and dual JSON examples; DoD: docs render on GitHub, `rg "\.\/tools\/bin\/.*\.exe" -n README.md docs/reference/tools-manifest.md` finds at least one Windows example, tests unchanged and green.
  - [x] [S51:l90-guard-no-legacy-paths] Add a `Makefile` target `check-tools-paths` that fails if any `./tools/(get_time|fs_|exec)` invocation remains outside `tools/bin` or `tools/cmd` (excluding `FEATURE_CHECKLIST.md`); implement with `rg` and negative globs; DoD: `make check-tools-paths` passes after migration, and fails before when run on current branch; no code behavior changed.
  - [x] [S52:l90-manifest-escape-check] Harden `internal/tools/manifest.go` validation to reject relative `command[0]` that normalize (via `path.Clean` + `filepath.ToSlash`) to paths containing `..` segments or escaping `./tools/bin/` (e.g., `./tools/bin/../hack`), and add focused tests in `internal/tools/manifest_test.go`; DoD: new tests fail before change and pass after, `go test ./...` green across platforms.
  - [x] [S53:l90-buildtool-windows-suffix-test] Extend `tools/testutil/buildtool.go` (after [S29:l90-test-helper-buildtool]) with a unit test asserting the returned binary path ends with `.exe` when `runtime.GOOS == "windows"` and has no suffix otherwise; migrate one representative tool test to assert the suffix via `BuildTool`; DoD: `go test ./tools/...` green on Unix and Windows runners when available.
  - [x] [S30:l90-manifest-enforce-bin-prefix] Enforce in `internal/tools/manifest.go` that any relative `command[0]` starts with `./tools/bin/` (absolute paths allowed for tests); adapt existing tests under `internal/tools/manifest_test.go` to cover this validation; DoD: added validation causes a failing test before change and passing after, `go test ./...` green.
  - [x] [S31:l90-manifest-doc-bin-prefix] Update `docs/reference/tools-manifest.md` to explicitly require relative `command` entries to use `./tools/bin/NAME`, update the JSON example to match, and note absolute paths are only for tests; DoD: doc renders on GitHub, `rg "\./tools/bin/" docs/reference/tools-manifest.md -n` finds at least one match, tests unchanged and green.
  - [x] [S23:l90-bin-mkdir] Ensure `Makefile` creates `tools/bin` before builds by adding `mkdir -p tools/bin` (or equivalent) at the start of the `build-tools` recipe; DoD: from a clean clone `rm -rf tools/bin && make build-tools` succeeds and produces `tools/bin/{get_time,exec,fs_read_file,fs_write_file,fs_append_file,fs_rm,fs_move,fs_search,fs_mkdirp,fs_apply_patch,fs_read_lines,fs_edit_range,fs_listdir,fs_stat}`.
  - [x] [S24:l90-clean-transitional] Update `Makefile` `clean` to remove both legacy paths (`tools/<NAME>` and `tools/*/<NAME>`) and new `tools/bin/*` during the migration window (until S20 completes) to avoid stale artifacts; DoD: after `make build-tools`, `make clean` leaves `git status` clean with no leftover tool binaries.
  - [x] [S24b:l90-unblock-build-tools] Restore missing tool source directories referenced by `build-tools` (e.g., `tools/exec`, `tools/fs_write_file`) or adapt tests to current layout so `make build-tools` and `go test ./...` pass; then re-run S24 verification.
  - [x] [S25:l90-docs-diagrams-paths] Update `docs/diagrams/agentcli-seq.md` and `docs/diagrams/toolbelt-seq.md` to replace `./tools/<NAME>` with `./tools/bin/<NAME>` where tools are invoked; DoD: both diagrams render on GitHub and `rg "\./tools/(get_time|fs_|exec)" docs/diagrams -n` returns no matches.
  - [x] [S26:l90-runbook-troubleshooting-paths] Revise `docs/runbooks/troubleshooting.md` commands to build from `./tools/cmd/NAME` (post‑migration slices) and execute `./tools/bin/NAME`; DoD: copy‑pasted commands work on a clean clone after `make build build-tools`, and `rg "\./tools/(fs_|exec|get_time)" docs/runbooks -n` only shows `tools/bin` paths.
  - [x] [S27:l90-architecture-doc-alignment] Align examples in `docs/architecture/module-boundaries.md` to the canonical layout (sources under `tools/cmd/NAME/*.go`, binaries under `tools/bin/NAME`) and update any `go build -o tools/<name> ./tools/<...>` snippets; DoD: doc renders and `rg "go build -o tools/" docs/architecture -n` returns no matches.
  - [x] [S28:l90-toolsjson-path-validation] Add a focused unit test in `internal/tools/manifest_test.go` that asserts relative `command[0]` entries in `tools.json` start with `./tools/bin/` (allow absolute paths for test fixtures); DoD: test fails before S02 and passes after, with `go test ./...` green and coverage unchanged.
  - [x] [S29:l90-test-helper-buildtool] Introduce `tools/testutil/buildtool.go` providing `BuildTool(t, name string) (binPath string)` that builds from `./tools/cmd/<name>` into `t.TempDir()`; migrate one representative test (e.g., `tools/fs_listdir_test.go`) to use it as a pattern; DoD: tests pass locally (`go test ./...`), helper adopted without breaking other tests.
  - [x] [S01:l90-make-bin-outputs] Update `Makefile` `build-tools` and `clean` to emit/remove binaries under `tools/bin/NAME` while building from current sources (`tools/timecli`, `tools/exec`, `tools/fs_*`, and `tools/fs_read_file.go`), without moving sources yet; DoD: `make build-tools` creates `tools/bin/{get_time,exec,fs_read_file,fs_write_file,fs_append_file,fs_rm,fs_move,fs_search,fs_mkdirp,fs_apply_patch,fs_read_lines,fs_edit_range,fs_listdir,fs_stat}` and `make clean` removes them, `git status` clean, `go test ./...` green.
  - [x] [S02:l90-toolsjson-bin] Point `tools.json` `command` entries to `./tools/bin/NAME` for all tools (names exactly as current binaries), keeping schemas unchanged; DoD: `./bin/agentcli -prompt "time?" -tools ./tools.json -debug` works with `get_time`, integration tests unaffected, `go test ./...` green.
  - [x] [S03:l90-docs-build-path] Revise `README.md` and `docs/reference/tools-manifest.md` usage snippets to reference `tools/bin/NAME` and `make build-tools`; DoD: docs render, examples run from clean clone (`make build build-tools` then quickstart), tests unchanged and green.
  - [x] [S04:l90-gitignore-tighten] Narrow `.gitignore` to ignore `tools/bin/**` only (and keep sources under `tools/cmd/**` tracked), removing blanket `tools/*/*` ignores while preserving exceptions for `*.go`; DoD: creating `tools/cmd/demo/main.go` is tracked, `make build-tools` yields ignored `tools/bin/*`, `git status` clean, tests green.
  - [x] [S05:l90-test-discovery-update] Update test helpers that build tools to use canonical package paths once migrated (e.g., change build path comments and invocations from `./tools/bin/fs_mkdirp` or `./tools/cmd/fs_read_file` to `./tools/cmd/NAME` as each tool moves); DoD: targeted tests updated only when their tool migrates, all tests green.
  - [x] [S05a:l90-test-update-fs_mkdirp] After [S06:l90-migrate-fs_mkdirp], replace inline builder in `tools/fs_mkdirp_test.go` with `testutil.BuildTool(t, "fs_mkdirp")` and remove direct `go build ./fs_mkdirp`; DoD: `go test ./tools -run FsMkdirp` passes on Unix/Windows, full suite green.
   - [x] [S06:l90-migrate-fs_mkdirp] Move `tools/fs_mkdirp/main.go` to `tools/cmd/fs_mkdirp/fs_mkdirp.go`, update its tests to build from `./tools/cmd/fs_mkdirp`, and adjust `Makefile` source mapping for `fs_mkdirp`; DoD: `go test ./tools -run FsMkdirp` passes, `make build-tools` builds `tools/bin/fs_mkdirp` from new path, no other tests fail.
  - [x] [S07:l90-migrate-fs_read_file] Move single-file `tools/fs_read_file.go` to `tools/cmd/fs_read_file/fs_read_file.go`, update `tools/fs_read_file_test.go` build path, and update `Makefile` mapping; DoD: `go test ./tools -run FsReadFile` passes, `tools/bin/fs_read_file` builds from new path, suite green.
  - [x] [S08:l90-migrate-exec] Move `tools/exec/main.go` to `tools/cmd/exec/exec.go`, update `tools/exec_test.go` build path, and adjust `Makefile`; DoD: `go test ./tools -run Exec` passes, `tools/bin/exec` builds from new path, suite green.
  - [x] [S09:l90-migrate-get_time] Move `tools/timecli/main.go` to `tools/cmd/get_time/get_time.go` (binary remains `get_time`), update `tools/timecli_test.go` build path, and adjust `Makefile`; DoD: `go test ./tools -run Time` passes, `tools/bin/get_time` builds from new path, suite green.
  - [x] [S10:l90-migrate-fs_write_file] Move `tools/fs_write_file/main.go` to `tools/cmd/fs_write_file/fs_write_file.go`, update its test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S11:l90-migrate-fs_append_file] Move `tools/fs_append_file/main.go` to `tools/cmd/fs_append_file/fs_append_file.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S12:l90-migrate-fs_rm] Move `tools/fs_rm/main.go` to `tools/cmd/fs_rm/fs_rm.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S13:l90-migrate-fs_move] Move `tools/fs_move/main.go` to `tools/cmd/fs_move/fs_move.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S14:l90-migrate-fs_search] Move `tools/fs_search/main.go` to `tools/cmd/fs_search/fs_search.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S15:l90-migrate-fs_apply_patch] Move `tools/fs_apply_patch/main.go` to `tools/cmd/fs_apply_patch/fs_apply_patch.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S16:l90-migrate-fs_read_lines] Move `tools/fs_read_lines/main.go` to `tools/cmd/fs_read_lines/fs_read_lines.go`, update tests (`fs_read_lines*_test.go`) and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S17:l90-migrate-fs_edit_range] Move `tools/fs_edit_range/main.go` to `tools/cmd/fs_edit_range/fs_edit_range.go`, update tests and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S18:l90-migrate-fs_listdir] Move `tools/fs_listdir/main.go` to `tools/cmd/fs_listdir/fs_listdir.go`, update tests (`fs_listdir*_test.go`) and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S19:l90-migrate-fs_stat] Move `tools/fs_stat/main.go` to `tools/cmd/fs_stat/fs_stat.go`, update test and `Makefile`; DoD: targeted tests pass, binary builds from new path, suite green.
  - [x] [S20:l90-remove-legacy-paths] Delete legacy tool sources left under `tools/*` (e.g., `tools/fs_read_file.go`, `tools/*/main.go`) with `git rm` and update `Makefile`/`clean` to stop referencing old paths; DoD: `rg "\./tools/(fs_|exec|timecli)" -g '!tools/cmd/**'` finds no sources, `make build-tools clean` reproducible, suite green.
  - [x] [S21:l90-update-integration] Update `cmd/agentcli/tools_integration_test.go` and any examples to assume `tools/bin` layout and validate end-to-end tool invocation via `tools.json`; DoD: integration test passes with new paths, README quickstart verified, suite green.
  - [x] [S22:l90-final-sweep] Search-and-replace any remaining built-path references (`./tools/<NAME>`) across repo (code, docs, scripts) to `./tools/bin/<NAME>` and ensure links and examples resolve; DoD: workspace grep returns none, `make lint test build build-tools` all green, `git status` clean.
   - [x] [S22a:l90-final-sweep-lint] Ensure `make lint` (golangci-lint) and `make check-tools-paths` (ripgrep) run green in an environment with these tools installed; no code changes expected; mark S22 complete when both gates pass.
   - [x] [S22a-next:l90-install-deps] Blocked locally: ripgrep (rg) not installed and golangci-lint not on PATH. Next step: install `rg` and ensure `$(go env GOPATH)/bin` (or `GOBIN`) is on PATH so `golangci-lint` is discoverable; then rerun `make check-tools-paths` and `make lint`.
  - [x] [S22b:l90-final-sweep-lint-docs] Add README developer prerequisites for ripgrep and golangci-lint with install snippets and PATH note to unblock local lint/path checks without code changes.
  - [x] [S32:l90-manifest-crossplat-bin-prefix] In `internal/tools/manifest.go`, perform relative `command[0]` bin-prefix validation using `filepath.ToSlash` and `path.Clean` so Windows path separators are normalized; extend `internal/tools/manifest_test.go` with cases for `./tools/bin/name` and `..\\tools\\bin\\name` (normalized reject) to ensure cross‑platform correctness; DoD: new test fails before change and passes after, `go test ./...` green on Linux/macOS and Windows runners when available.
  - [x] [S33:l90-move-fs_read_file-tests] Relocate `tools/fs_read_file_test.go` to `tools/cmd/fs_read_file/fs_read_file_test.go` and refactor it to use `tools/testutil/buildtool.go::BuildTool(t,"fs_read_file")` after [S29:l90-test-helper-buildtool]; DoD: `go test ./tools/cmd/fs_read_file -run FsReadFile` passes in isolation and `go test ./...` remains green.
  - [x] [S34:l90-integration-relative-tools-bin] Amend `cmd/agentcli/tools_integration_test.go` to build `fs_write_file` and `fs_read_file` into `tools/bin/` under a temp working directory and write a manifest using relative `./tools/bin/<name>` paths to exercise the new convention end‑to‑end; DoD: test passes locally and in CI with no reliance on absolute paths, suite green.
  - [x] [S35:l90-move-fs_write_file-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_write_file_test.go` to `tools/cmd/fs_write_file/fs_write_file_test.go` using `tools/testutil/buildtool.go::BuildTool(t,"fs_write_file")`; DoD: `go test ./tools/cmd/fs_write_file -run FsWriteFile` and `go test ./...` are green.
  - [x] [S36:l90-move-fs_append_file-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_append_file_test.go` to `tools/cmd/fs_append_file/fs_append_file_test.go` with `BuildTool(t,"fs_append_file")`; DoD: targeted package test and full suite green.
  - [x] [S37:l90-move-fs_mkdirp-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_mkdirp_test.go` to `tools/cmd/fs_mkdirp/fs_mkdirp_test.go` using `BuildTool(t,"fs_mkdirp")`; DoD: targeted package test and full suite green.
  - [x] [S38:l90-move-fs_rm-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_rm_test.go` to `tools/cmd/fs_rm/fs_rm_test.go` using `BuildTool(t,"fs_rm")`; DoD: targeted package test and full suite green.
  - [x] [S39:l90-move-fs_move-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_move_test.go` to `tools/cmd/fs_move/fs_move_test.go` using `BuildTool(t,"fs_move")`; DoD: targeted package test and full suite green.
  - [x] [S40:l90-move-fs_search-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_search_test.go` to `tools/cmd/fs_search/fs_search_test.go` using `BuildTool(t,"fs_search")`; DoD: targeted package test and full suite green.
  - [x] [S41:l90-move-fs_listdir-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_listdir_test.go`, `tools/fs_listdir_glob_test.go`, and `tools/fs_listdir_symlink_test.go` to `tools/cmd/fs_listdir/` using `BuildTool(t,"fs_listdir")`; DoD: `go test ./tools/cmd/fs_listdir` and `go test ./...` green.
  - [x] [S42:l90-move-fs_read_lines-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_read_lines_test.go` and `tools/fs_read_lines_maxbytes_test.go` to `tools/cmd/fs_read_lines/` using `BuildTool(t,"fs_read_lines")`; DoD: targeted package test and full suite green.
  - [x] [S43:l90-move-fs_apply_patch-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_apply_patch_test.go` to `tools/cmd/fs_apply_patch/fs_apply_patch_test.go` with `BuildTool(t,"fs_apply_patch")`; DoD: targeted package test and full suite green.
  - [x] [S44:l90-move-fs_edit_range-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_edit_range_test.go`, `tools/fs_edit_range_binary_test.go`, and `tools/fs_edit_range_concurrency_test.go` to `tools/cmd/fs_edit_range/` using `BuildTool(t,"fs_edit_range")`; DoD: `go test ./tools/cmd/fs_edit_range` and `go test ./...` green.
  - [x] [S45:l90-move-fs_stat-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/fs_stat_test.go` to `tools/cmd/fs_stat/fs_stat_test.go` with `BuildTool(t,"fs_stat")`; DoD: targeted package test and full suite green.
  - [x] [S46:l90-move-exec-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/exec_test.go` to `tools/cmd/exec/exec_test.go` with `BuildTool(t,"exec")`; DoD: targeted package test and full suite green.
  - [x] [S47:l90-move-get_time-tests] (after [S29:l90-test-helper-buildtool]) Move `tools/timecli_test.go` (if present) to `tools/cmd/get_time/get_time_test.go` with `BuildTool(t,"get_time")`; DoD: targeted package test and full suite green.
  - [x] [S48:l90-untrack-legacy-binaries] (after [S04:l90-gitignore-tighten]) Remove any tracked legacy binaries under `tools/*` without extensions (e.g., `tools/fs_read_file`) via `git rm --cached` and ensure `.gitignore` only ignores `tools/bin/**`; DoD: `git status` shows removals, `make build-tools` produces only `tools/bin/*`, suite green.
   - [x] [S60:l90-make-tools-var] Introduce `TOOLS := get_time exec fs_read_file fs_write_file fs_append_file fs_rm fs_move fs_search fs_mkdirp fs_apply_patch fs_read_lines fs_edit_range fs_listdir fs_stat` in `Makefile` and refactor `build-tools` and `clean` to iterate deterministically over this list (no source moves yet), preserving current legacy source paths; DoD: `make build-tools` yields `tools/bin/{get_time,exec,fs_read_file,fs_write_file,fs_append_file,fs_rm,fs_move,fs_search,fs_mkdirp,fs_apply_patch,fs_read_lines,fs_edit_range,fs_listdir,fs_stat}` and `make clean` removes them all with a single list, tests unchanged and green.
  - [x] [S61:l90-make-build-tool-target] Add `Makefile` target `build-tool` that builds a single tool into `tools/bin/$(NAME)` from legacy sources using `make build-tool NAME=fs_read_file`; DoD: command works for at least `fs_read_file` and `fs_mkdirp`, errors clearly when `NAME` missing or unknown; tests unchanged and green.
  - [x] [S62:l90-verify-manifest-paths] Add `Makefile` target `verify-manifest-paths` that fails if `tools.json` has any relative `command[0]` not starting with `./tools/bin/` (allow absolute paths), implemented with `rg` and precise messaging; DoD: `make verify-manifest-paths` fails before S02 and passes after, message cites offending entries; tests unchanged and green.
   - [x] [S63:l90-docs-contrib-workflow] Update `README.md` Contributing to mention `make check-tools-paths`, `make verify-manifest-paths`, and `make build-tool NAME=<name>` as the local workflow during migration; DoD: doc renders on GitHub, commands copy‑paste, tests unchanged and green.
  - [x] [S64:l90-migration-guide-doc] Add `docs/migrations/tools-layout.md` describing migration from `./tools/<NAME>` to `./tools/bin/<NAME>` and new source layout `tools/cmd/<NAME>`, and link it from `docs/README.md`; DoD: docs render on GitHub, links resolve, tests unchanged and green.
  - [x] [S66:l90-clean-future-checklist-legacy] Replace legacy path references in `FUTURE_CHECKLIST.md` (e.g., `tools/timecli`, single-file `tools/*.go`) with canonical `tools/cmd/*` and `tools/bin/*` or remove obsolete bullets; verification: `rg -n 'tools/timecli|tools/[a-z_]+\.go' FUTURE_CHECKLIST.md` returns no matches; DoD: docs render, no functional code changes, `go test ./...` green.
  - [x] [S67:l90-buildtool-drop-legacy] After S33–S47 are complete, simplify `tools/testutil/buildtool.go` by removing legacy source fallbacks (`tools/<name>` dir, `tools/<name>.go` file, and the special-case `tools/timecli`), keeping only `tools/cmd/<name>`; update one representative test to continue using `BuildTool` (no behavior change); verification: `rg -n 'tools/timecli|filepath.Join\(repoRoot, "tools", name\)|tools/[a-z_]+\.go' tools/testutil/buildtool.go` finds no matches; DoD: `go test ./...` green.
  - [x] [S68:l90-ci-matrix] Add GitHub Actions workflow `.github/workflows/ci.yml` to run `make tidy lint test build build-tools` on a Go matrix across `ubuntu-latest`, `macos-latest`, and `windows-latest` (install ripgrep where needed); verification: `rg -n 'make (tidy|lint|test|build|build-tools)' .github/workflows/ci.yml` matches and the matrix includes the three OSes; DoD: CI passes on all platforms with no new findings.
  - [x] [S69:l90-ci-verify-tools-hygiene] Extend the CI workflow to run `make check-tools-paths` and (after S62) `make verify-manifest-paths` as distinct steps; verification: `rg -n 'check-tools-paths|verify-manifest-paths' .github/workflows/ci.yml` matches both; DoD: workflow fails when a legacy path or invalid manifest command is introduced and passes on current branch.
  - [x] [S70:l90-integ-use-buildtool] Refactor `cmd/agentcli/tools_integration_test.go` to use `tools/testutil/buildtool.go::BuildTool(t,"fs_write_file")` and `BuildTool(t,"fs_read_file")` instead of invoking `go build` manually; keep manifest relative `./tools/bin/*` and temp working directory behavior; verification: `go test ./cmd/agentcli -run AdvertisesSchemas` passes and diff limited to the single test file; DoD: full `go test ./...` green.
* [x] Standardize JSON error contract for all tools — on failure, write single-line stderr `{"error":"<escaped>","hint?":"<opt>"}` and exit non-zero; runner maps to tool message; DoD: negative-path tests per tool, docs snippet, CI green.
  - [x] [S03:l91-fs_listdir-error-json] add failing test for fs_listdir and implement standardized stderr JSON {"error":"..."}
  - [x] [S01:l90-fs_mkdirp-error-json] add failing test for fs_mkdirp and implement JSON stderr error contract
  - [x] [S02:l90-fs_read_file-error-json] add failing test for fs_read_file and implement JSON stderr error contract (preserve NOT_FOUND marker)
  - [x] [S04:l91-exec-error-json] add failing test and implement standardized stderr JSON + non-zero exit in `tools/cmd/exec` for invalid JSON input
  - [x] [S05:l91-fs_stat-error-json] add failing test for fs_stat and verify standardized stderr JSON {"error":"..."}
  - [x] [S06] fs_search: add stderr JSON error‑contract test for missing query; implement/verify behavior; suite green
  - [x] [S07] fs_append_file: add stderr JSON error‑contract test for missing fields; implement/verify behavior; suite green
* [x] Rename the get_time tool entrypoint to follow the canonical layout by moving tools/cmd/get_time/main.go to tools/cmd/get_time/get_time.go; context: canonical tools layout requires tools/cmd/NAME/NAME.go and this package currently uses main.go; scope: tools/cmd/get_time only; low risk and independent; DoD: make build-tools produces tools/bin/get_time (or .exe on Windows), go test -race -cover ./... remains green with no coverage regression and all quality gates (vet, format, lint, security, secret detection) green, documentation and tools.json unchanged, peer review completed; verification: build then run the tool with a sample stdin to confirm output, rollback by renaming the file back to main.go.
* [x] Rename the fs_write_file tool entrypoint to follow the canonical layout by moving tools/cmd/fs_write_file/main.go to tools/cmd/fs_write_file/fs_write_file.go; context: canonical tools layout requires tools/cmd/NAME/NAME.go and this package currently uses main.go; scope: tools/cmd/fs_write_file only; low risk and independent; DoD: make build-tools produces tools/bin/fs_write_file (or .exe on Windows), go test -race -cover ./... remains green with no coverage regression and all quality gates (vet, format, lint, security, secret detection) green, documentation and tools.json unchanged, peer review completed; verification: build then run the tool with a sample stdin to confirm output, rollback by renaming the file back to main.go.
* [x] Adjust .gitignore patterns to ignore only built tool binaries (for example tools/bin/**) while keeping all Go sources under tools/** tracked so future canonical layout tools/cmd/NAME/*.go are not accidentally ignored by the existing tools/*/* blanket ignore; smallest change: replace broad patterns with precise ignores and explicit unignores for .go files recursively; scope .gitignore; low risk; DoD: creating tools/cmd/demo/main.go shows as tracked while built binaries under tools/bin are ignored and git status is clean after make build-tools, all gates green; verify by the described steps; rollback by reverting the .gitignore edit.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/fs_write_file/fs_write_file_test.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make lint and make fmtcheck passing locally and in CI with no other diffs, tests unchanged and green with no coverage regression, all quality gates green (vet, golangci-lint, static analysis, security and secret detection) with no new findings, peer review completed; verification by running gofmt -s -l . and observing no output, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/exec/exec.go and tools/cmd/exec/exec_test.go so fmtcheck passes deterministically; smallest change is formatting those files only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI with no other diffs, tests unchanged and green with race and coverage enabled, all quality gates green with no new findings, peer review completed; verification by running gofmt -s -l . and observing these files disappear from the list, rollback by reverting the formatting edits.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/fs_append_file/fs_append_file_test.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI with no other diffs, tests unchanged and green with race and coverage enabled, all quality gates green, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/fs_move/fs_move_test.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI with no other diffs, tests unchanged and green with race and coverage enabled, all gates green, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/fs_search/fs_search_test.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI with no other diffs, tests unchanged and green with race and coverage enabled, all gates green, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting tools/cmd/fs_stat/fs_stat_test.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI with no other diffs, tests unchanged and green with race and coverage enabled, all gates green, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting cmd/agentcli/tools_integration_test.go so fmtcheck passes deterministically; smallest change is formatting that single file; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI, tests unchanged and green with race and coverage enabled, all gates green with no new findings, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Eliminate gofmt -s drift by formatting tools/testutil/buildtool.go so fmtcheck passes deterministically; smallest change is formatting that file only; scope formatting; low risk and independent; DoD includes make fmtcheck and make lint passing locally and in CI, tests unchanged and green with race and coverage enabled, all gates green with no new findings, peer review completed; verification by gofmt -s -l . showing no output for this path, rollback by reverting the formatting edit.
* [x] Amend the Makefile lint target to also run the existing verify-manifest-paths check after check-tools-paths so invalid relative command entries in tools.json are caught by default during local and CI lint runs; smallest change is editing the Makefile lint recipe only to invoke make verify-manifest-paths; scope Makefile; low risk and independent; DoD includes make lint failing before when tools.json has a bad relative command and passing after correction, tests unchanged and green with race and coverage enabled, all quality gates green with no new findings, peer review completed; verification by temporarily introducing an invalid ./tools/... path to observe failure then reverting, rollback by reverting the Makefile edit.
* [x] Add a shared test helper MakeRepoRelTempDir to tools/testutil and refactor tools/cmd/fs_write_file/fs_write_file_test.go to use it by removing its local duplicate, minimal change is adding one helper function and editing that single test file, scope tools/cmd/fs_write_file tests only, low risk and independent, DoD: go test -race -cover ./... remains green with no coverage regression and all quality gates pass, verification: repository search shows no makeRepoRelTempDir definition inside tools/cmd/fs_write_file and the test imports the shared helper, rollback: revert the helper addition and the test edit.
* [x] Refactor tools/cmd/fs_move/fs_move_test.go to use a shared MakeRepoRelTempDir helper under tools/testutil (create it if missing, otherwise reuse) and remove its local duplicate; smallest change is adding one helper function and editing that single test file; scope tests only; low risk and independent; DoD includes go test -race -cover ./... green with no coverage regression and all quality gates green; verification by searching that makeRepoRelTempDir is no longer defined locally and the test imports the shared helper; rollback by reverting the helper addition (if newly added) and the test edit.
* [x] Refactor tools/cmd/fs_append_file/fs_append_file_test.go to use a shared MakeRepoRelTempDir helper under tools/testutil (create it if missing, otherwise reuse) and remove its local duplicate; smallest change is adding one helper function and editing that single test file; scope tests only; low risk and independent; DoD includes go test -race -cover ./... green with no coverage regression and all quality gates green; verification by searching that makeRepoRelTempDir is no longer defined locally and the test imports the shared helper; rollback by reverting the helper addition (if newly added) and the test edit.
* [x] Refactor tools/cmd/fs_rm/fs_rm_test.go to use a shared MakeRepoRelTempDir helper under tools/testutil (create it if missing, otherwise reuse) and remove its local duplicate; smallest change is adding one helper function and editing that single test file; scope tests only; low risk and independent; DoD includes go test -race -cover ./... green with no coverage regression and all quality gates green; verification by searching that makeRepoRelTempDir is no longer defined locally and the test imports the shared helper; rollback by reverting the helper addition (if newly added) and the test edit.
* [x] Refactor tools/cmd/fs_mkdirp/fs_mkdirp_test.go to use a shared MakeRepoRelTempDir helper under tools/testutil (create it if missing, otherwise reuse) and remove its local duplicate; smallest change is adding one helper function and editing that single test file; scope tests only; low risk and independent; DoD includes go test -race -cover ./... green with no coverage regression and all quality gates green; verification by searching that makeRepoRelTempDir is no longer defined locally and the test imports the shared helper; rollback by reverting the helper addition (if newly added) and the test edit.
* [x] Remove dead test helper file tools/helpers_test.go that declares package main at the tools root and is unused (duplicate temp-dir helpers exist in tool package tests), minimal change is deleting this single file via git rm, scope tests only, low risk and independent, DoD: go test -race -cover ./... remains green with unchanged coverage and all quality gates (vet, format, lint, security, secret detection) pass, verification: searching the repository shows no references to helpers_test.go and go test ./tools reports no tests to run, rollback: restore the file from Git if needed.
* [x] Add a .gitattributes file to enforce LF line endings for Go, Markdown and shell scripts and to normalize text files to avoid CRLF-related failures and noisy diffs, smallest change is committing a single .gitattributes with patterns only; scope repository hygiene; low risk; DoD includes tests unchanged and green with no coverage regression, deterministic runs locally and in CI with no new findings from vet, format, lint, security scanning and secret detection, verification by creating a CRLF file then confirming Git normalizes to LF on checkout and go test ./... passes on Linux and Windows without spurious failures, rollback by reverting the .gitattributes file.
* [x] Add a make fmt target that runs gofmt -s -w over the repository and mention it briefly in README near lint so developers can apply formatting easily, smallest change is adding the target and a one line README note, scope Makefile and docs, low risk; DoD includes running make fmt with no unintended diffs, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by running the command locally, rollback by reverting the edits.
* [x] Document and automate submodule initialization by adding a Makefile bootstrap target that runs git submodule update --init --recursive and updating README Installation to include this step so a clean clone reliably fetches .cursor/rules and scripts without SSH keys, smallest change is one Makefile target and a brief README edit, scope Makefile and docs, low risk and independent with no code changes, DoD includes running from a clean clone on Linux and macOS to execute make bootstrap build build-tools successfully with all tests green and no coverage regression and all quality gates green in CI including vet format lint security and secret detection with no new findings, verification by following the updated steps locally and in CI where actions checkout with submodules true succeeds, rollback by reverting the Makefile target and README sentence.
* [x] Add lint/type checks and formatting gates: include `.golangci.yml` enabling `govet`, `gofmt`, `errcheck`, `staticcheck`, `gocyclo` (with reasonable thresholds), `gosimple`; add `make lint` that installs `golangci-lint` if missing and runs it; ensure `go vet ./...` and `gofmt -s -l` produce no output; fail CI if any lints fail.
* [x] Add a minimal .editorconfig (root=true) specifying utf-8, end_of_line=lf, insert_final_newline=true, indent_style=tab for Go and indent_style=space indent_size=2 for Markdown and YAML to reduce formatting drift across editors, smallest change is committing the single .editorconfig file; scope repository hygiene; low risk; DoD includes tests unchanged and green with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security scanning and secret detection) with no new findings, verification by saving files in common editors and observing no diffs beyond gofmt expectations, rollback by reverting the file.
  - [x] [S01:l207-unblock-lint] Implement Makefile lint PATH invocation by resolving `$(go env GOPATH)/bin/golangci-lint`; `golangci-lint` now runs headlessly. Next step: resolve goanalysis error by upgrading golangci-lint to a version compatible with Go 1.24+.
  - [x] [S02:l207-upgrade-golangci] Pin/upgrade golangci-lint to a version compatible with current Go toolchain so `make lint` passes locally and in CI; then re-run `make lint` and complete L207 DoD.
   - [x] [S02a:l207-lint-green-internal] Resolve existing `errcheck` and `gocyclo` findings in internal packages first to drive `make lint` toward green without weakening gates.
* [x] Add reports and coverage artifacts to .gitignore including reports/ tests directory and coverage outputs so running the test runner does not create noisy untracked files, smallest change is appending ignore patterns only, scope repository hygiene, low risk; DoD includes running scripts/test-runner.sh and verifying git status is clean, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by git status before and after, rollback by removing the new ignore lines.
* [x] Augment the root .gitignore to include standard entries for the dist directory, macOS .DS_Store, the Go go.work workspace file, and common IDE folders .idea and .vscode to prevent accidental commits of local artifacts, smallest change is appending those patterns only to the existing file, scope repository hygiene, low risk and independent, DoD includes running git status before and after creating those files locally to confirm they are ignored, tests unchanged and green with no coverage regression, all quality gates green (vet, format, lint, static and security scans, secret detection) with no new findings, peer review completed, verification by reproducing the ignore behavior on a clean clone, rollback by reverting the .gitignore addition.
* [x] Make builds reproducible by adding -trimpath and stripped ldflags to Makefile build and build-tools while keeping static CGO settings and documenting the change succinctly, smallest change is editing the build recipes only and a short README sentence, scope Makefile and docs, low risk; DoD includes two clean builds producing identical checksums for binaries, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by comparing shasums of repeated builds, rollback by reverting the Makefile edits.
* [x] CLI help: make `--help`/`-h`/`help` print full usage and exit 0 before any required-flag validation or side effects; DoD: `agentcli --help` prints all flags (names, defaults, env fallbacks, precedence) and examples, exits 0 on all OSes; `go test` adds a test that asserts help output and code path; CI and all gates green; one peer review completed.
* [x] Split timeouts and make HTTP configurable independently: add `-http-timeout` (env fallback `OAI_HTTP_TIMEOUT`) used exclusively for the OpenAI POST and keep `-tool-timeout` for tools (default 30s), wire `actions/setup-go` CI to exercise both, update README and docs/operations/ci-quality-gates.md, and add unit/integration tests that force a delayed fake server/tool to confirm each timeout triggers the correct error path; DoD: both flags honored, defaults sane (HTTP 60–120s), tests green, docs updated, CI gates green, peer review done.
* [x] Add resilient HTTP retries with backoff for transient failures: introduce `-http-retries` and `-http-retry-backoff` (cap, jitter) to retry on timeouts, network errors, 429, and 5xx, include `Idempotency-Key` header per request to avoid duplicate side effects, respect `Retry-After`, and log attempts to the audit file; DoD: unit tests simulate timeout then success and 429 with Retry-After, integration test with fake server passes, defaults conservative (e.g., 2 retries), docs updated, CI green, peer review done.
  - [x] [S01:retries-doc-flags] Update README "Common flags" to document `-http-retries` and `-http-retry-backoff`; tests already green.
  - [x] [S02:retries-audit-attempts] Emit per-attempt audit entries for HTTP retries including attempt number, status, and backoff; add unit test; docs/runbook note.
  - [x] [S03] Respect Retry-After header for 429/5xx with unit tests
  - [x] [S01] Introduce minimal retry policy with tests (timeouts and 5xx); no flags yet
  - [x] [S02] Wire `-http-retries` and `-http-retry-backoff` flags; add stable `Idempotency-Key` across retries with unit test
* [x] Emit precise HTTP timing and failure cause to the audit: record DNS/connect/TLS/write/read durations, status, and whether the context deadline fired vs server closed, and surface a concise user hint (“increase -http-timeout or reduce prompt/model latency”); DoD: new fields present in `.goagent/audit/*` with a passing test that asserts structure, performance unaffected, CI green, peer review done.
* [x] Runbook entry for `context deadline exceeded`: add a troubleshooting section that explains causes (slow model, proxy timeouts, too-small `-http-timeout`), mitigation steps (raise `-http-timeout`, tune proxy `proxy_read_timeout`, reduce prompt size), and an example of enabling retries; DoD: docs render on GitHub, copy-paste checks complete, CI docs gates green, peer review done.
* [x] Make relative paths in tools.json resolve against the directory containing that tools.json (not process CWD), preserving existing security checks that reject `..` escapes; update `internal/tools/manifest.go` to anchor, clean, and normalize paths cross-platform, adapt unit/integration tests to cover a manifest in a nested folder, adjust `make verify-manifest-paths` if needed, update `docs/reference/tools-manifest.md` to document the rule and absolute-path allowance for tests, and verify end-to-end that an agent run using a nested tools.json with relative `./tools/bin/*` works; DoD: unit/integration tests added and green on Linux/macOS/Windows, docs updated, CI and all quality gates green, one peer review completed.
* [x] Makefile: preserve the logs directory during the clean target by removing any deletion of logs while keeping other artifact removals; DoD: from a clean clone create a sentinel file under logs, build artifacts, run clean, verify the sentinel remains and artifacts are gone, repo status is clean, all gates (lint/vet/format/tests/security/secret) green, one peer review completed.
  - [x] [S01:clean-preserve-logs-verified] Verified `make clean` preserves `logs/` (sentinel survives) and removes artifacts (`tools/bin`, `bin`, `reports`, `.goagent`).
  - [x] [S02:clean-lint-fixes-tools] Resolve repo-wide `golangci-lint` findings (errcheck/gocyclo in `tools/cmd/*`) so quality gates are green for this item.
    - [x] [S02d:errcheck-encode-and-visits] Check json.Encode errors in `fs_listdir`, `fs_read_lines`, `fs_stat`; handle `WalkDir`/`Info`/visit errors deterministically; update tests to check Unmarshal and cleanup removes.
    - [x] [S02a:lint-errcheck-fs_read_write] Fix errcheck in `tools/cmd/fs_read_file` and `tools/cmd/fs_write_file`; tests green.
  - [x] [S02b:lint-errcheck-batch-2] Address remaining errcheck in `get_time`, `fs_append_file`, and `fs_apply_patch` (encode/close and unsafe ignores); re-run lint.
    - [x] [S02c:lint-errcheck-fs_move] Address errcheck in `tools/cmd/fs_move` and its tests (check json.Encode, close defers, test Unmarshal); tests green.
* [x] Makefile: add a guarded clean-logs target that deletes logs only when the file logs/STATE (trimmed of whitespace) equals DOWN and otherwise no-ops, add a clean-all target that runs clean then clean-logs, add a deterministic test target that exercises allowed (DOWN) and blocked (non-DOWN or missing) cases and wire it into CI, and document the behavior in README; DoD: local test target passes for all cases, CI runs it on all OSes and is green, logs are never deleted unless STATE is DOWN, all quality gates green, one peer review completed.
* [x] Diagnose and fix opaque `context deadline exceeded` on chat POST by instrumenting HTTP phase timings (DNS/connect/TLS/write/read/idle), verifying and wiring `-http-timeout`/`OAI_HTTP_TIMEOUT` is actually applied to the OpenAI POST (independent from tool timeouts) or adding it if missing, and upgrading the surfaced error to include base URL, phase, and configured timeout with actionable hints (e.g., server unreachable vs slow response); add table-driven unit tests and an integration test with a fake slow server and a refused connection to prove (a) correct timeout behavior, (b) clear error text and exit code 1 for network/timeout, 2 for CLI misuse, and (c) that raising `-http-timeout` resolves the slow-server case; update README and the troubleshooting runbook accordingly; DoD: failing tests first then passing, running the provided repro command yields a precise cause message (not a generic context deadline), CI and all quality gates green, one peer review completed.
* [x] Expand make clean to remove build/test artifacts like bin/coverage.out and reports/ to keep the working tree tidy after local runs, because currently these files remain and can cause noisy diffs; smallest change is editing the clean recipe only; scope Makefile; low risk; DoD includes running make build build-tools test to create artifacts then make clean to remove them with git status clean, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by reproducing the sequence on a clean clone, rollback by reverting the Makefile edit.
  - [x] [S00:clean-removes-artifacts] Verified current Makefile removes bin/, coverage.out, reports/, .goagent, and tools/bin; no recipe change needed for this slice.
  - [x] [S01:clean-gates] Lint gates currently fail due to pre-existing issues (errcheck/gocyclo). Next step: address lint findings to satisfy Definition of Done for this item.
  - [x] [S02:clean-errcheck-agentcli] Fix errcheck and gofmt findings under `cmd/agentcli` (unit + integration tests); reduce `runAgent` cyclomatic complexity below threshold by extracting helpers; DoD: tests green; lint passes for `cmd/agentcli/**` locally; full repo lint may still have findings to be addressed in follow-up slices; no gate weakening.
* [x] Bound tools/fs_search scanning by skipping known binary/output directories (e.g., .git, bin, logs, tools/* built binaries) and enforcing a sane per-file size limit with clear errors to prevent performance and memory spikes on large repositories; smallest change is editing tools/fs_search/main.go only; scope tools; moderate risk due to traversal changes; DoD includes unit tests covering directory exclusion, size limits, and unchanged matching semantics on text files, tests green locally and in CI with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security/secret detection) with no new findings, docs/runbooks updated with the exclusions, peer review completed, verification by searching a repo containing large/binary files and observing fast, bounded behavior, rollback by reverting the changes.
  - [x] [S01:fs_search-skip-binaries] Skip `bin/`, `logs/`, and `tools/bin/` during walking; add test
  - [x] [S02:fs_search-size-limit] Enforce 1MiB per-file size cap with clear error; add unit test
* [x] Centralize audit logs under repository root .goagent/audit/YYYYMMDD.log by resolving module root (walk up to go.mod) in internal/tools/runner.go instead of using current working directory so subpackage tests no longer create nested .goagent directories; smallest change: edit appendAuditLog to compute root and write there; scope internal/tools only; low risk; DoD: failing test first then passing implementation, go test -race -cover ./... green with quality gates and docs unchanged, verify only root path receives logs and they are ignored by Git, rollback by reverting the change.
* [x] Enforce flag > env > default precedence for `-http-timeout`, `-tool-timeout`, and `-timeout` and add table-driven tests that set env to 90s and flags to 300s verifying the effective values are 5m; DoD: tests green, CI gates green, peer review done.
* [x] Remove any `min()` clamping between global `-timeout` and `-http-timeout`; use `-http-timeout` exclusively for the chat POST context and `-timeout` only for overall run budget; DoD: unit/integration test proves a 300s HTTP timeout is honored even when global is shorter/longer, CI green, peer review done.
* [x] Make duration flags robust: accept plain seconds (int) as well as Go duration strings by parsing `300` as `300s`; DoD: tests cover `300`, `300s`, `5m`, invalid inputs; CI green, peer review done.
* [x] Print the **effective** timeouts and their **sources** (flag/env/default) under `-debug` and in timeout errors (e.g., `http-timeout=5m source=flag`); DoD: unit test asserts formatting, failing timeout shows accurate values, CI green, peer review done.
* [x] Add `--print-config` that exits 0 and dumps the resolved config (model, base URL, all timeouts with sources) so misconfigurations are obvious; DoD: unit test for output, docs updated, CI green, peer review done.
* [x] Integration test: fake slow server proves `-http-timeout 300` allows \~5m before cancel while default (90s) cancels \~1m30s; DoD: deterministic test with `httptest.Server` and sleep, CI green, peer review done.
* [x] Create ADR-0003 “Toolchain & Lint Policy (Go + golangci-lint)” documenting that CI must use the Go version declared by `go.mod` and that `golangci-lint` is pinned to a known-good version for that Go line; include upgrade policy (bump both together via PR), risks, and rollback. Smallest change: add `docs/adr/0003-toolchain-and-lint-policy.md` with context, options, decision, consequences, and a link to the canonical issue URL (created in this PR). DoD: ADR rendered on GitHub, linked from `docs/README.md` and `README.md` (Tooling section); all gates green; one peer review completed.
  - [x] [S01:l248-lint-green] Install ripgrep (rg) locally so `make check-tools-paths` can run, then rerun `make lint` to satisfy gates; next step: `sudo apt-get update && sudo apt-get install -y ripgrep` (Linux) or `brew install ripgrep` (macOS).
* [x] Pin CI to module Go version using `actions/setup-go` with `go-version-file: go.mod`. Smallest change: edit `.github/workflows/ci.yml` to configure `actions/setup-go@v5` with `go-version-file: go.mod` in every job (linux/macos/windows), print `go version` for traceability, and keep the existing matrix. DoD: a fresh CI run shows the same Go major.minor on all OSes (visible in logs), `make tidy lint test build build-tools` pass, gates green, peer review completed, rollback by reverting the workflow hunk.
* [x] Change the **default sampling temperature to 1.0** by updating the agent CLI’s flag default and the underlying request-option defaults, ensure the value propagates into the outbound payload when supported, add a unit test that asserts the resolved default is 1.0 when no overrides are provided, and update README’s “Common flags” so `-temp` shows “default 1.0” instead of 0.2 (also add a short rationale line in docs); DoD: unit tests green, `agentcli -h` displays 1.0, README/Docs updated. ([GitHub][1])
* [x] Implement a **model capability map** in the internal request-options layer to determine `SupportsTemperature` per model (e.g., GPT-5 variants → true; any known exceptions → false with inline comment), expose a simple lookup used at call time, and write a table-driven unit test that covers at least three model IDs and both outcomes; DoD: lookup used by payload builder, tests green, brief note added to docs “Model parameter compatibility”.
* [x] Update the **payload encoder** so that `temperature` is omitted entirely when `SupportsTemperature == false` and included (1.0 or user override) when true, preserving existing behavior for other params; add golden-file or snapshot tests for both branches; DoD: encoder tests green and logs confirm presence/omission in debug mode.
* [x] Add an **ADR (“Default LLM Call Policy”)** under `docs/` (create `docs/adr` if missing) capturing context, options considered, the decision to default temperature to 1.0 with capability-based omission, and the retry/guard policies; include a Mermaid sequence of the tool-call flow; DoD: ADR merged and diagram renders on GitHub.
* [x] Provide a **worked example** in `examples/` demonstrating a tool-call session that exercises: default temperature 1.0, parallel tool calls, and the corrected message sequencing; include a tiny fake tool and a transcript dump; DoD: `go test ./examples/...` (or your repo’s test convention) passes and README links to it.
* [x] Add **parallel tool-call support**: execute multiple `tool_calls[]` concurrently and append exactly one `tool` message per returned `tool_call_id` in any order acceptable to the API, then continue; include a concurrency unit test that simulates two tools with different latencies; DoD: tests green and docs example added.
* [x] Fix **message assembly** so the flow is always: user/assistant→assistant with `tool_calls[]`→one `tool` message per `tool_call_id` with the tool output→assistant (repeat as needed), never emitting a standalone `tool` message early; add an end-to-end mock test that exercises one and multiple tool calls; DoD: test green and README shows a minimal JSON example of correct sequencing. ([OpenAI Platform][2])
* [x] Document correct tool-call sequencing with a minimal JSON example in `README.md#tool-calls` (assistant with `tool_calls[]` → tool messages with matching `tool_call_id` → assistant), including note on parallel tool calls requiring one tool message per id. ([Microsoft Learn][8])
* [x] Implement a **message-sequence validator** that rejects any `role:"tool"` message unless it responds to a prior assistant message with `tool_calls[]` and a matching `tool_call_id`, and surface a pre-flight error that mirrors the API’s wording; add unit tests for valid/invalid transcripts; DoD: validator on by default, tests green, troubleshooting doc updated. ([OpenAI Platform][2])
* [x] Add a **regression test for the exact 400** you hit by crafting a transcript with a stray `role:"tool"` lacking a prior `tool_calls[]`; assert the validator blocks it locally with a helpful error and that the request is never sent; DoD: failing test first, then fix, then green, and an entry added to the Troubleshooting section.
* [x] CLI errors: when required flags (e.g., `-prompt`) are missing, print concise error followed by the usage synopsis and exit with code 2 (not 1); DoD: unit test verifies stderr contains error + usage, exit code is 2, no network or tool exec attempted; CI and all gates green; one peer review completed.
* [x] CLI version: add `--version`/`-version` to print semver + commit + build date and exit 0 without validating other flags; DoD: unit test asserts format and exit code; README “Usage” updated; CI and all gates green; one peer review completed.
* [x] Add `make check-go-version` that fails early if the active toolchain doesn’t match `go.mod`. Smallest change: in `Makefile`, add target that extracts `MOD_GO=$$(awk '/^go [0-9]+\\.[0-9]+/ {print $$2; exit}' go.mod)` and `SYS_GO=$$(go version | sed -E 's/.*go([0-9]+\\.[0-9]+).*/\\1/')`; compare and `exit 2` with a clear message if different. Document this target briefly in `README.md` under “Developer workflow”. DoD: running `make check-go-version` passes when versions match and fails with an actionable message when mismatched; CI invokes it (temporarily from a one-off verification commit) and stays green; peer review completed.
  - [x] [S01:l252-wire-lint] Prepend `check-go-version` to `lint` so it runs first; local `make lint` now fails fast on toolchain mismatch as intended.
  - [x] [S01b:l252-local-proof] Verified locally that `make lint` executes `check-go-version` first (observed "check-go-version: OK" before golangci-lint output); CI verification remains pending.
  - [x] [S02b:l252-robust-mod-parse] Harden `Makefile` `check-go-version` to parse Go major.minor via `go mod edit -json` for stability; `make lint` and `go test ./...` green locally.
  - [x] [S02e:l252-local-test-order] Add a deterministic unit test `internal/ci/ci_workflow_test.go::TestLintOrderLocallyAndInWorkflow` that inspects the Makefile lint recipe block to ensure `check-go-version` precedes `golangci-lint`, and asserts the CI workflow contains the explicit lint order assertion step. Suite green.
  - [x] [S02d:l252-blocked-note] Blocked locally: cannot push or open PR from this session to trigger CI. Next step: open a PR (or push to a tracked branch) to run the workflow and verify logs show `check-go-version: OK` before golangci-lint across the OS matrix.
  - [x] [S04:l252-ci-lint-step-name] Name the workflow step explicitly as `lint (includes check-go-version)` in `.github/workflows/ci.yml` so reviewers can spot the gate in logs quickly; DoD: CI run shows the named step and includes the `check-go-version: OK` line preceding linter output.
  - [x] [S05:l252-doc-ci-gate] Update `docs/operations/ci-quality-gates.md` to state that `make lint` enforces `check-go-version` first and that CI runs the same gate; include a short excerpt of the expected log line `check-go-version: OK (system X.Y matches go.mod X.Y)`; DoD: docs render on GitHub, links intact, tests unchanged and green.
  - [x] [S06:l252-readme-badge] Add a README CI badge pointing to `.github/workflows/ci.yml` and label it "CI (lint+test+build)"; DoD: badge renders and links to the workflow page, no broken images, tests unchanged and green.
  - [x] [S07:l252-ci-assert-order] Amend `.github/workflows/ci.yml` lint step to pipe output to `lint.log` and add a subsequent `bash` step that fails if `rg -n "^check-go-version: OK" lint.log` is absent or occurs after `rg -n "^golangci-lint version" lint.log`; DoD: CI logs show both lines in order and job stays green.
  - [x] [S08:l252-ci-upload-artifact] Add an `actions/upload-artifact@v4` step to publish `lint.log` as `lint-${{ matrix.os }}`; DoD: artifacts visible for ubuntu/macos/windows in the run.
  - [x] [S09:l252-readme-dev-hint] Update `README.md` Developer workflow to include the exact mismatch message `Go toolchain mismatch: system X.Y != go.mod X.Y` and remediation; DoD: `rg -n "Go toolchain mismatch" README.md` matches once, docs render.
  - [x] [S01:l242-exe-suffix] Resolve Windows suffix by referencing "golangci-lint$(EXE)" under GOPATH/bin in lint recipe so invocation works cross‑platform after on-demand install.
  - [x] [S01:l242-preexisting-lints] Resolve current golangci-lint and fmtcheck findings in tests to get `make lint` green; scope: fix errcheck on cleanup removes and gofmt -s formatting; no gate weakening.
  - [x] [S02b:l207-install-rg] Blocked locally: ripgrep (rg) not installed; `make check-tools-paths` fails in lint. Next step: install ripgrep and rerun `make lint`.
* [x] Pin `golangci-lint` deterministically and install to a known path. Smallest change: in `Makefile`, add `GOLANGCI_LINT_VERSION ?= v1.60.3` and `GOBIN ?= $(CURDIR)/bin`; an `install-golangci` target runs `curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(GOBIN) $(GOLANGCI_LINT_VERSION)`; update `lint` to call `$(GOBIN)/golangci-lint run` (no PATH assumptions). Add a short note to `README.md` and `docs/operations/ci-quality-gates.md` explaining the pin and location. DoD: on a clean machine `make lint` installs the pinned version into `./bin` and runs successfully; CI is green on all OSes; peer review completed; rollback by reverting `Makefile` and doc changes.
* [x] CLI flags order independence: make argument parsing accept flags in any order without requiring `-prompt` to appear first while preserving precedence (flag > env > default) and error semantics; add **table-driven local unit tests** that permute common orders (e.g., `-prompt` before/after other flags, mixed with `-debug`, `-tools`, `--help`) asserting identical parsed values, `--help` exits 0 regardless of position, and “-prompt is required” uses exit code 2 only when truly absent; update the user guide to state flags are order-insensitive; **DoD:** `go test ./...` passes locally and `./agentcli -h` behaves as documented.
* [x] Makefile lint reliability: update the lint recipe to guaranteedly invoke `golangci-lint` after on-demand install by either resolving the binary via `$(go env GOPATH)/bin/golangci-lint` or installing to `./bin` and prepending it to PATH inside the recipe; **DoD:** on a fresh shell with no `golangci-lint` in PATH, `make lint` installs the tool and succeeds locally.
* [x] Lint prerequisites: install `ripgrep` locally if missing and re-run `make lint` to confirm targets that depend on `rg` behave; **DoD:** `make lint` completes successfully on this machine after installing `ripgrep`.
* [x] Reference docs: add a CLI reference page enumerating every flag with default, environment fallback, precedence, and exit codes for `--help`/`--version`/missing-required; link from the main README; include a tiny local script/test that compares each documented flag to `./agentcli -h` output to ensure the page reflects the binary; **DoD:** docs render locally and the checker passes.
  - [x] Add a tiny checker that diffs `docs/reference/cli-reference.md` against `./bin/agentcli -h` and a local test that runs it.
* [x] LLM policy docs: update the policy page to state default `temperature=1.0`, show GPT-5 controls like `verbosity` (`low|medium|high`) and `reasoning_effort`, and note that some models restrict sampling knobs; **DoD:** page updated and reviewed locally (no external link checks required).
* [x] Config precedence for temperature: implement resolution order `--temperature` > `LLM_TEMPERATURE` env > config file > default 1.0, and when `--top-p` is provided unset `temperature` (with a one-line warning to stderr); add local flag-parsing table tests covering overlaps and edge cases; **DoD:** `go test ./...` green and manual runs show correct precedence.
* [x] Parameter-recovery retry: when the API returns HTTP 400 mentioning invalid/unsupported `temperature`, remove `temperature` from the payload and retry **once** before normal exponential backoff; log the recovery with a structured field; **DoD:** local integration test using a mock server that first 400s on `temperature` and then succeeds without it.
* [x] Temperature-nudge guard: make the nudge logic a no-op when the selected model does not support temperature and clamp adjustments within `[0.1, 1.0]` otherwise; include local unit tests that simulate repetition/format-failure to trigger −0.1 and diversity to trigger +0.1 without exceeding bounds; **DoD:** `go test ./...` passes locally.
* [x] ADR addendum: append an addendum to the default-policy ADR documenting the change to default `temperature=1.0` for API parity and GPT-5 compatibility with a concise rationale and rollout note; **DoD:** ADR renders locally and is linked from the docs index.
* [x] One-knob sampling rule: enforce that if the user passes `--top-p` then `temperature` is omitted from the payload, and when `--top-p` is absent send `temperature` (default 1.0) with `top_p` unset; add local tests for precedence and serialization and a one-sentence rule in the docs; **DoD:** tests pass locally and docs updated.
* [x] Prompt profile mapper: implement a mapper (`deterministic|general|creative|reasoning`) that sets temperature to `0.1` (if supported) for deterministic and `1.0` for the rest, omitting temperature if a model forbids it; add local unit tests for the mapping and a doc table with examples; **DoD:** `go test ./...` passes and docs updated.
* [x] Observability fields: emit `temperature_effective` (post-clamp/omission) and `temperature_in_payload` (bool) in structured logs; **DoD:** local unit test asserts both fields appear and manual run shows fields in debug logs.
* [x] Length backoff: on truncation (e.g., `finish_reason=="length"`), automatically double the completion cap once (bounded by remaining context) and retry; include local unit tests that simulate truncation; **DoD:** `go test ./...` passes and behavior described in the policy docs.
  - [x] [S01:request-max-tokens-field] Add `MaxTokens int` with `json:"max_tokens,omitempty"` to `internal/oai/types.go` struct `ChatCompletionsRequest`; add `internal/oai/types_serialization_test.go` to assert JSON includes `max_tokens` only when set; **DoD:** tests pass and no breaking changes to existing payload fields.
  - [x] [S02:agent-plumb-cap-field] In `cmd/agentcli/main.go` request assembly, include `req.MaxTokens` only when a local variable `completionCap > 0`; no behavior change yet (default `completionCap=0`); add unit test asserting absence when `completionCap=0`; **DoD:** tests pass and binary behavior unchanged.
  - [x] [S03:length-retry-core] In `cmd/agentcli/main.go` within the per-step call, detect `resp.Choices[0].FinishReason=="length"` and implement a one-time in-step retry guarded by `retriedForLength bool` that sets `completionCap = max(256, completionCap*2)` and resends with `req.MaxTokens=completionCap`; ensure we do not increment the agent step on the retry; **DoD:** logic compiles, guarded by unit tests in next slice.
  - BLOCKED: [S04:test-length-retry-mock] Spec expects second request `max_tokens:512`, but current implementation initializes `completionCap=0`, so first retry sets `max_tokens` to 256 (not 512); proceeding would fail deterministically.
    - Next: Edit this checklist to expect second request `max_tokens:256` (0→256 per S03), then add the test in `cmd/agentcli/main_test.go` asserting exactly two POSTs and `max_tokens:256` on the second request.
  - [x] [S05:context-window-map] Create `internal/oai/context_window.go` with `ContextWindowForModel(model string) int` (defaults to 128000; e.g., `oss-gpt-20b`→8192) and `internal/oai/context_window_test.go` covering the map; **DoD:** tests pass and function usable by clamp logic.
  - [x] [S06:naive-token-estimator] Add `internal/oai/token_estimate.go` with `EstimateTokens(messages []Message) int` using a simple heuristic (e.g., chars/4 + per-message overhead); include `internal/oai/token_estimate_test.go` asserting monotonic growth and rough scale; **DoD:** tests pass; no external deps.
  - [x] [S07:cap-clamp] Add `ClampCompletionCap(messages []oai.Message, cap, window int) int` in `internal/oai/context_window.go` to bound `cap` to `max(1, window-EstimateTokens(messages)-32)`; include unit tests; **DoD:** tests pass and clamp is deterministic.
  - [x] [S08:integrate-clamp] In `cmd/agentcli/main.go` length-retry path, compute `window := oai.ContextWindowForModel(cfg.model)` then set `completionCap = oai.ClampCompletionCap(messages, completionCap, window)` before resend; add `TestLengthBackoff_ClampDoesNotExceedWindow` to assert we never exceed remaining context by inspecting second request `max_tokens`; **DoD:** tests pass.
  - [x] [S09:audit-length-backoff] Emit an NDJSON audit entry on length backoff using existing `internal/oai/client.go:appendAuditLog` mechanism (event `"length_backoff"`, fields: `model`, `prev_cap`, `new_cap`, `window`, `estimated_prompt_tokens`); unit test writes to a temp module root by `chdir` and asserts one log line with expected fields; **DoD:** test passes on all platforms.
  - [x] [S10:edge-cases] Add tests in `cmd/agentcli/main_test.go` verifying (a) no retry when `FinishReason!="length"`, (b) only one retry even if the second response is also `"length"` (proceed without further retries), and (c) length backoff does not interfere with tool_call flow; **DoD:** tests pass and existing tool-call tests remain green.
* [x] Agent loop safety: ensure the default `-max-steps` is 8 with a hard ceiling of 15 and terminate with a clear “needs human review” message when the cap is hit; **DoD:** local unit test drives the loop to the cap and asserts the message, and the README mentions the guard.
* [x] HTTP timeouts and retries: wire jittered exponential backoff for 429/5xx/timeouts and use a sane default overall timeout (minutes, not seconds); add local unit tests that verify the retry schedule and backoff growth; **DoD:** `go test ./...` passes and the README’s defaults match observed behavior.
* [x] README defaults: update the “Common flags” table so defaults (notably `-temp 1.0` and `-max-steps 8`) match the binary, and add a short “Why you usually don’t need to change knobs” section pointing to the policy; **DoD:** README renders locally and manual `./agentcli -h` matches the table.
* [x] GPT-5 live smoke: add a local smoke test that runs `./agentcli --model gpt-5` with **no sampling flags** and asserts that the request includes `temperature:1` while allowing `verbosity`/`reasoning_effort` to be set; **DoD:** test passes locally when `GPT5_OPENAI_API_URL` and `GPT5_OPENAI_API_KEY` are exported.
* [x] GPT-5 mock smoke: add a local integration test using a mock OpenAI-compatible endpoint that asserts `temperature:1` is sent by default and that reasoning controls can be toggled without altering temperature; **DoD:** mock test passes locally and the docs include a “Zero-config with GPT-5” example.
* [x] Pre-stage timeouts: inherit `-prep-http-timeout` from the existing `-http-timeout` (and `OAI_PREP_HTTP_TIMEOUT` env) instead of falling back to deprecated `-timeout`. Remove any mention of `-timeout` in pre-stage. DoD: unit tests show `-prep-http-timeout` > `OAI_PREP_HTTP_TIMEOUT` > `-http-timeout` > default; help/README updated.
* [x] Pre-stage param knobs follow one-knob rule + capability map: add `-prep-top-p` and reuse the existing model capability map to omit `temperature` (or `top_p`) when unsupported; also reuse the 400 “parameter-recovery” retry once for the pre-stage. DoD: table tests cover presence/omission and the 400→retry flow; docs note parity with main call.
  - [x] Introduce a minimal pre-stage HTTP call before the main loop that builds an `oai.ChatCompletionsRequest` using `cfg.prepHTTPTimeout`, applies one‑knob logic (`-prep-top-p` vs temperature), and reuses the existing client (for 400 temperature recovery); return messages unchanged to keep behavior stable.
* [x] Pre-stage uses the same message-sequence validator: run the existing validator that forbids stray `role:"tool"` and enforces `tool_call_id` matching during the pre-processing loop, too. DoD: failing test with a stray tool message in pre-stage; passing after wiring; troubleshooting doc mentions both stages.
* [x] Parallel tool-calls in pre-stage: execute multiple `tool_calls[]` concurrently during pre-processing, just like the main loop. DoD: concurrency test with two pre-stage tool calls of different latency; transcript contains exactly one `tool` message per id.
* [x] Restrict pre-stage tools to built-in read-only adapters (no external commands by default): expose only in-process tools `fs.read_file`, `fs.list_dir`, `fs.stat`, `env.get`, `os.info` under a separate pre-stage tool registry; ignore `-tools` for pre-stage unless explicitly overridden by `-prep-tools-allow-external`. DoD: attempting to write or exec in pre-stage deterministically returns an error; security doc updated.
* [x] If `-prep-tools-allow-external` is enabled, reuse manifest rules: resolve the pre-stage manifest relative to its own file, require `./tools/bin/*` (Windows `.exe` honored), and enforce the existing escape/`..` rejection and cross-platform path normalization. DoD: unit tests mirror `internal/tools/manifest_*` for the pre-stage path.
* [x] Audit + structured logs include `stage:"prep"` with HTTP timings and idempotency key: reuse your current NDJSON audit schema and emit the same timing fields and `Idempotency-Key` for the pre-stage call. DoD: test asserts one prep entry with `{stage:"prep", timings..., idempotency_key}` at repo root `.goagent/audit/`.
* [x] Config dump shows pre-stage config: extend `-print-config` to include `prep` block (model, base URL, http timeout, retries/backoff, temperature/top_p resolved and sources). Env precedence: `OAI_PREP_*` > main flag/env where applicable; API key fallback chain `OAI_PREP_API_KEY` → `OAI_API_KEY` → `OPENAI_API_KEY`. DoD: unit test snapshots config; README examples updated.
* [x] Channel printing harmonized with current debug/quiet behavior: default print only `assistant{channel:"final"}` to stdout; `-verbose` prints `critic`/`confidence` to stderr without interleaving raw JSON; `-debug` continues to dump raw request/response JSON to stderr after any human-readable channel output; `-quiet` prints just the final text. DoD: formatter tests cover combinations and ordering; help/README table updated.
* [x] Pre-stage cache key expanded to include knobs + tool spec: hash `(prompt/system/developer inputs, prep model/base, temp/top_p effective, retries/backoff, pre-stage tool set or external manifest content hash)`; honor `-prep-cache-bust`. DoD: tests for hit/miss/TTL; docs updated.
* [x] ADR numbering + links: use ADR-0005 “Harmony pre-processing & channel-aware output” (ADR-0004 already exists). Link from README and docs index; include sequence diagram that reflects parallel tool calls, validator, and audit stages.
  - [x] [S04:harmony-prep-seq-diagram] Create `docs/diagrams/harmony-prep-seq.md` showing CLI → pre‑stage HTTP → parallel tool calls → `ValidateMessageSequence` → cache/audit → merge → main call; DoD: diagram file exists, is referenced from ADR‑0005 and docs index, and renders as Markdown.
  - [x] [S01:adr-0005-file] Author `docs/adr/0005-harmony-pre-processing-and-channel-aware-output.md` (Context/Decision/Consequences) documenting pre-stage flags and flow in `cmd/agentcli/main.go` (e.g., `-prep-*`, cache, parallel tool calls), validator `internal/oai/validator.go:ValidateMessageSequence`, channel routing, and audit `stage:"prep"`, and reference `docs/diagrams/harmony-prep-seq.md` (depends on S04 for link to resolve); DoD: file renders on GitHub and all relative links resolve.
  - [x] [S02:docs-index-adr-link] Insert ADR‑0005 entry in `docs/README.md` under ADRs with link `adr/0005-harmony-pre-processing-and-channel-aware-output.md` (depends on S01); DoD: link is clickable and resolves in GitHub UI.
  - [x] [S03:readme-adr-link] Add an ADR‑0005 bullet in root `README.md` “Documentation” section linking to `docs/adr/0005-harmony-pre-processing-and-channel-aware-output.md` (depends on S01); DoD: link renders and passes review.
  - [x] [S05:docs-index-diagram-link] Add `docs/diagrams/harmony-prep-seq.md` to the Diagrams list in `docs/README.md` (depends on S04); DoD: link is present and resolves.
  - [x] [S06:cli-reference-xref] In `docs/reference/cli-reference.md`, add a short “See ADR‑0005” cross‑link near the `-prep-*` flags pointing to `../adr/0005-harmony-pre-processing-and-channel-aware-output.md` (depends on S01); DoD: link resolves and headings remain intact.
  - [x] [S07:readme-prestage-xref] In `README.md` near “View refined messages (pre-stage and final)” or the `Common flags` block, add a parenthetical “See ADR‑0005” linking to `docs/adr/0005-harmony-pre-processing-and-channel-aware-output.md` (depends on S01); DoD: formatting consistent and link resolves.
  - [x] [S08:adr-0004-see-also] At the top of `docs/adr/0004-default-llm-policy.md`, add a “See also: ADR‑0005” cross‑link to `docs/adr/0005-harmony-pre-processing-and-channel-aware-output.md` (depends on S01); DoD: link resolves; no other content changes.
  * [x] [S09:verify-docs-ci] Run `go test ./...` and `make lint` locally; verify all new links clickable in GitHub preview and no docs build/lint checks regress (depends on S01, S04–S08 completed); DoD: tests/lint green and reviewers can navigate ADR‑0005 and its diagram from both READMEs.
  - [x] Next: Apply `gofmt -s` to flagged files and handle `errcheck` in tests (add checks or justified nolint) to get `make lint` green for S09.
  - [x] Next: Reduce `gocyclo` violations for `cmd/agentcli:parseFlags`, `cmd/agentcli:runPreStage`, `internal/tools:RunToolWithJSON`, and long test functions; perform no‑behavior‑change refactors until `make lint` passes.
  - [x] [S10:readme-diagram-link] In root `README.md` under “Diagrams”, add a bullet linking to `docs/diagrams/harmony-prep-seq.md` (depends on S04); DoD: link renders and resolves alongside existing diagram links.
  - Next: Use ADR-0005 for “Harmony pre-processing & channel-aware output”, link from README and docs index, and include the sequence diagram.
* [x] Windows suffix + path normalization everywhere: ensure printing/examples show `./tools/bin/NAME.exe` where applicable and path normalization uses `filepath.ToSlash` before validation (already in repo—just reuse). DoD: docs and tests show at least one Windows example; cross-platform tests green.
* [x] One-knob parity in docs and help: clarify that both stages obey “if `--top-p` is set, `temperature` is omitted” and defaults are 1.0 (main) and 1.0 (prep) unless the user selects a `--prep-profile deterministic` (sets temp 0.1 if supported). DoD: help text + docs reflect the rule; unit tests for profiles.
  - [x] Added `-prep-profile` flag with profile→temperature mapping (uses `internal/oai/profile.go`), reflected in help/README/CLI docs; tests added for deterministic profile and one‑knob precedence over profile.
* [x] Roles/precedence merge updated: when CLI provides `-developer`/`-developer-file`, those messages are prepended ahead of any pre-stage developer messages in the final array; system resolution is “CLI `-system` if present, else pre-stage system, else default string” (unchanged). DoD: merge tests for all permutations; README “Roles & precedence” examples updated.
* [x] Pre-stage enable/disable switch and fail-open fallback. Add `-prep-enabled` (default true). On any pre-stage error (network, schema/validator, tool failure, invalid roles), log `WARN:` once to stderr, skip pre-stage, and proceed with original `{system,user}`. DoD: table tests for each failure → fallback; docs show behavior; `-print-config` reflects `prep.enabled`.
* [x] Explicit pre-stage model/endpoint flags. Add `-prep-model`, `-prep-base-url`, `-prep-api-key`, `-prep-http-retries`, `-prep-http-retry-backoff`. Precedence: flag > `OAI_PREP_*` > main-call equivalents > defaults. DoD: unit tests for precedence; `-print-config` shows resolved prep block; README updated.
* [x] Role input flags not yet in CLI. Implement `-developer` (repeatable), `-developer-file` (repeatable), plus `-prompt-file` and `-system-file` (each mutually exclusive with their string counterpart; `-` means STDIN). DoD: parser tests (mutual exclusion, repeats, STDIN), help text, examples; merge logic matches your “Roles/precedence” bullet.
* [x] Pre-stage dry-run and message viewing. Add `-prep-dry-run` (run pre-stage only, print refined Harmony messages to stdout, exit 0) and `-print-messages` (pretty-print the final merged message array to stderr before the main call). DoD: snapshot tests; README examples.
* [x] Streaming for assistant\[final]. If server supports streaming, stream only `assistant{channel:"final"}` to stdout; buffer other channels for `-verbose`. DoD: mock streaming test; docs “Streaming” section; `-quiet` still prints just the streamed final.
* [x] Save/load refined messages. `-save-messages path` writes the final merged Harmony array to JSON; `-load-messages path` bypasses pre-stage and `-prompt` using that JSON verbatim (still validator-checked). DoD: round-trip tests; schema doc; conflict errors covered.
* [x] Custom channel routing. `-channel-route name=stdout|stderr|omit` (repeatable) to override defaults (final→stdout, critic/confidence→stderr). Invalid channel/destination → exit 2 with message. DoD: routing matrix tests; help/README updated.
* [x] Pre-stage tools manifest path. Add `-prep-tools path` to point to a (possibly different) manifest; honor all existing manifest validations (anchoring to manifest dir, `./tools/bin/*`, Windows `.exe`, `..` escapes). Works only with `-prep-tools-allow-external`. DoD: unit + integration tests with a nested manifest.
  - Implemented flag parsing, help/CLI docs, cache key preference, and pre-stage manifest selection with `-prep-tools` overriding `-tools` when external tools are allowed. Added unit test `TestPrep_UsesPrepToolsWhenProvided`. Added integration test `TestPrep_Integration_NestedManifestResolution` exercising nested manifest resolution under pre-stage using `httptest.Server`.
* [x] Harmony normalizer. In pre-stage, normalize/validate roles (`system|developer|user|assistant|tool`) and assistant `channel` tokens (ASCII, short). Unknown roles → hard error (triggers fallback); unknown channels → pass through but not auto-printed unless routed. DoD: validator tests and clear errors.
* [x] End-to-end acceptance test. One deterministic test that: (1) runs pre-stage using a mock server returning Harmony with two parallel tool calls (readonly), (2) validates channel routing and message merging, (3) runs the main call to completion. DoD: single test under `cmd/agentcli` green locally without network.
* [x] Implement `tools/cmd/img_create/img_create.go` binary: read stdin JSON `{"prompt":string,"n?:int(1..4 default 1)","size?:string(default \"1024x1024\", pattern ^\\d{3,4}x\\d{3,4}$)","model?:string(default \"gpt-image-1\")","return_b64?:bool(default false)","save?:{"dir":string(repo-relative, required when return_b64=false),"basename?:string(default \"img\"),"ext?:\"png\"}}`; POST `{"model","prompt","n","size","response_format":"b64_json"}` to `${OAI_IMAGE_BASE_URL:-$OAI_BASE_URL}/v1/images/generations` with `Authorization: Bearer $OAI_API_KEY`, `Content-Type: application/json`; on success, if `return_b64` true output `{"images":[{"b64":"..."},...]}` (truncate each b64 to 0 and include `{"hint":"b64 elided"}` unless `-debug-b64` env true), else decode each image, write as `save.dir/save.basename_{001..}.png` atomically and output `{"saved":[{"path":"...","bytes":int,"sha256":"..."}], "n":int,"size":"...","model":"..."}`; on error, write single-line stderr JSON `{"error":"<escaped>","hint?":"<opt>"}` and exit non-zero; strict repo-relative path enforcement, no shell exec; HTTP timeout from `OAI_HTTP_TIMEOUT` (default 120s) and 429/5xx/timeout backoff 2 attempts; DoD: unit tests (happy path with 1×1 PNG b64, missing prompt, invalid dir, API 400, timeout+retry), golden stdout schema, works offline via `httptest.Server` mocking Images API, docs example runnable, `make build-tools` emits `tools/bin/img_create`, lint/tests green.
* [x] Extend tool manifest schema to allow secrets safely: add optional `envPassthrough: ["OAI_API_KEY","OAI_BASE_URL","OAI_IMAGE_BASE_URL","OAI_HTTP_TIMEOUT"]` in `tools.json` per tool; update `internal/tools/manifest.go` to validate string array, normalize keys, and expose it; update `docs/reference/tools-manifest.md` with examples and security cautions (only explicit allowlist is passed to child process); DoD: unit tests for validation and JSON round-trip, docs updated, grep guard in `make verify-manifest-paths` remains green.
* [x] Wire runner to honor `envPassthrough`: in `internal/tools/runner.go` build child env as `PATH,HOME` + `envPassthrough` values from the parent process; add redaction in audit log so values are never logged; DoD: unit test asserts child sees allowed vars and not others, audit NDJSON shows keys but not values, race tests green, docs/security updated.
* [x] Add `img_create` to `tools.json` with JSON Schema: "name":"img_create","description":"Generate image(s) with OpenAI Images API and save to repo or return base64","schema":{"type":"object","required":["prompt"],"properties":{"prompt":{"type":"string"},"n":{"type":"integer","minimum":1,"maximum":4,"default":1},"size":{"type":"string","pattern":"^\\d{3,4}x\\d{3,4}$","default":"1024x1024"},"model":{"type":"string","default":"gpt-image-1"},"return_b64":{"type":"boolean","default":false},"save":{"type":"object","required":["dir"],"properties":{"dir":{"type":"string"},"basename":{"type":"string","default":"img"},"ext":{"type":"string","enum":["png"],"default":"png"}},"additionalProperties":false}},"additionalProperties":false}`, `"command":["./tools/bin/img_create"]`, `"timeoutSec":120`, `"envPassthrough":["OAI_API_KEY","OAI_BASE_URL","OAI_IMAGE_BASE_URL","OAI_HTTP_TIMEOUT"]`; DoD: manifest loads, `agentcli -capabilities` lists tool, reference doc updated, integration test uses this entry.
* [x] Add end-to-end agent integration test: in `cmd/agentcli/tools_integration_test.go`, spin an `httptest.Server` that expects POST `/v1/images/generations` with `{"model":"gpt-image-1","prompt":"tiny-pixel","n":1,"size":"1024x1024","response_format":"b64_json"}` and returns a valid 1×1 PNG `b64_json`; run agent in temp repo with tools.json (envPassthrough wired, fake base URL/key), script the model mock to first return `tool_calls:[{function:{name:"img_create",arguments:"{...save:{dir:\"out\"}}"}}]` then a final assistant text summarizing the saved path; assert: one PNG written under `out/`, stdout == final message, exit 0; DoD: deterministic, no network, Windows/macOS/Linux all green.
* [x] Add README section “Image generation tool (img_create)”: quickstart with `make build-tools`, sample `tools.json` entry, example prompt that instructs the assistant to call `img_create` and save under `assets/`, note on avoiding b64 in transcripts by default, pointer to troubleshooting; DoD: docs render on GitHub, copy-paste works on clean clone.
* [x] Author `docs/reference/img_create.md`: define stdin/out contracts, examples for saving files vs returning b64, parameter table (prompt, n, size, model), HTTP behavior (timeouts/retries), and safety notes; include a cURL of the underlying API for transparency, and link to OpenAI “Images & vision” and “gpt-image-1” docs; DoD: links render, schema matches tools.json, reviewed, CI docs gates green.
* [x] Create ADR for “Add minimal OpenAI image generation tool”: DoD: ADR committed, diagram renders, cross-linked from docs index.
* [x] Update `docs/diagrams/toolbelt-seq.md` (or add `docs/diagrams/img-create-seq.md`) to show: CLI → assistant(tool_calls: img_create) → img_create (HTTP to Images API) → files saved → assistant final; DoD: diagram renders on GitHub, referenced from README and ADR, test asserts file exists.
* [x] Makefile: add `img_create` to `TOOLS` variable so `make build-tools` emits `tools/bin/img_create` (with `.exe` on Windows) and `make clean` removes it; DoD: reproducible builds with `-trimpath`, shasums stable across two runs, CI matrix green.
* [x] Runner troubleshooting entry: add `docs/runbooks/troubleshooting.md` section for image errors (invalid API key, 429 with `Retry-After`, moderation refusal/body 400 mapping, timeout), with concrete remediation (export OAI_API_KEY, raise OAI_HTTP_TIMEOUT, reduce `n`/size); DoD: content verified via tests/mocks, docs links intact.
* [x] Security doc update: expand `docs/security/threat-model.md` with envPassthrough rationale, explicit list of whitelisted vars, note that `img_create` never logs prompts or base64 by default and writes only under repo-relative `save.dir`; DoD: doc renders, threat boundaries diagram updated if present.
* [x] Add example repo script `examples/image-gen/README.md` + small Go/Makefile snippet to invoke `img_create` directly for manual testing (no agent), storing under `assets/` and printing paths; DoD: copy-paste works, ignored by Git via existing patterns, no CI dependence.
* [x] Add negative-path contract tests for `img_create`: (a) `return_b64=false` and no `save.dir` ⇒ stderr JSON and exit≠0, (b) non-matching `size` pattern ⇒ stderr JSON, (c) API returns 400 with JSON error ⇒ tool maps to stderr JSON; DoD: tests green, coverage unchanged.
* [x] Optional pass-through extras (forward-compat): support optional `extras?:object` that is shallow-merged into the API body for known unsafe-to-omit keys (e.g., `"background":"transparent"` if/when supported); validate `extras` is a simple map of string→primitive, strip anything else; DoD: unit tests for include/strip behavior, docs note that extras are best-effort and may be ignored by the API.
* [x] `agentcli -capabilities` output: ensure `img_create` appears with its description and an explicit warning that it makes outbound network calls and can save files; DoD: unit test asserting printed line contains `img_create` and warning, README snippet updated.
* [x] Enforce transcript hygiene: add a pre-flight validator in `cmd/agentcli` that, when `-debug` is off, truncates any tool message content over 8KB (e.g., if a future config sets `return_b64=true`), replacing with `{"truncated":true,"reason":"large-tool-output"}` before sending to the API; DoD: unit test for truncation, docs mention safeguard.
* [x] Fix errcheck warnings by handling or asserting error returns in tests currently flagged by golangci-lint (e.g., internal/oai/client_test.go writes and cmd/agentcli/main_test.go json Encode/Setenv/Unsetenv), smallest change is editing only those tests to check errors or add narrowly justified nolint comments, scope lint hygiene (tests only), low risk, DoD includes `make lint` passing with errcheck clean and tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by running `make lint` and observing no errcheck diagnostics in those files, rollback by reverting the test edits.
* [x] Remove the inadvertently committed root-level `agentcli` binary and prevent reintroduction by adding `agentcli` (and Windows `agentcli.exe`) to `.gitignore`; smallest change is `git rm agentcli` and appending two ignore entries; scope repository hygiene; low risk; DoD includes `git ls-files --error-unmatch agentcli` failing, `make build` producing `bin/agentcli` as documented, `git status` clean after builds across OSes, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verification by running those commands; rollback by reverting the `.gitignore` edit and restoring the file if necessary.
* [x] Remove tracked lint artifacts `lint.err` and `lint_verify.err` and add ignore entries for them in `.gitignore` to keep the working tree clean after lint runs; smallest change is `git rm` those files and append two ignore lines; scope repository hygiene; low risk; DoD includes `git status` clean after `make lint`, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verification by running `make lint` and observing no new tracked `*.err` files; rollback by reverting the `.gitignore` edit and re-adding the files if required.
* [x] Fix errcheck warnings in production code by handling or asserting error returns currently flagged in non-test packages (e.g., cmd/agentcli/main.go writePrepCache calls, internal/oai/client.go resp.Body.Close/io.ReadAll, tools/cmd/img_create/*.go Encode/Close/Remove); smallest change is adding error checks or narrowly justified ignores where safe; scope limited to non-test packages and tool binaries; low risk and independent; DoD includes make lint passing with no errcheck diagnostics in these files, tests unchanged and green with no coverage regression, all quality gates green; verify by running make lint and confirming errcheck clean; rollback by reverting the edits.
* [x] Reduce cyclomatic complexity of tools/cmd/img_create/img_create.go function run (gocyclo=54) by extracting small helpers for input parse/validate, API request/response handling, file writes, and stdout JSON; no behavior change; scope single tool; low–moderate effort; DoD includes golangci-lint gocyclo no longer flagging run (>20), make lint and tests passing, coverage unchanged, peer review completed; verify via golangci-lint output and go test; rollback by reverting the refactor.
* [x] Reduce cyclomatic complexity of internal/tools/runner.RunToolWithJSON (gocyclo=21) by extracting environment construction and process execution into focused helpers without changing semantics; scope internal/tools only; low effort and independent; DoD includes golangci-lint gocyclo clean for this function, make lint and tests passing, coverage unchanged; verify via golangci-lint and go test; rollback by reverting the refactor.
* [x] Remove the staticcheck SA9003 empty branch in cmd/agentcli/main.go around the pre-stage block (~line 673) by deleting the no-op branch or consolidating logic; scope single file; low risk and independent; DoD includes make lint passing with no SA9003 warning, tests green with no coverage regression, all quality gates green; verify by rerunning make lint and confirming staticcheck clean; rollback by reverting the line-level change.
* [x] Ignore editor swap files and remove the stray .FEATURE_CHECKLIST.md.swp: append a *.swp entry to .gitignore (minimal change) and delete the existing file; scope repository hygiene; low risk and independent; DoD includes git status clean after editing with Vim (no new tracked *.swp), git ls-files --error-unmatch .FEATURE_CHECKLIST.md.swp fails, tests and lint unchanged and green with no coverage regression, all quality gates green; verify by creating and saving a file in Vim and observing no tracked swap file; rollback by reverting the .gitignore edit and restoring the file if necessary.
* [x] Correct the README fs_search example to match the tool schema: replace invalid keys (path, pattern, glob, caseInsensitive) with query (string), globs (array of file globs), and regex (boolean), and remove path since fs_search scans the repository root; smallest change is editing README only; scope documentation; low risk and independent; DoD includes the updated example running successfully on a clean clone (producing expected matches), tests and lint unchanged and green with no coverage regression, all quality gates green; verify by running the example exactly as shown; rollback by reverting the README edit.
* [x] **Tool: http_fetch (safe HTTP/HTTPS fetcher)** — File `tools/cmd/http_fetch/http_fetch.go`; **stdin** `{"url":string,"method?":"GET|HEAD","max_bytes?":1048576,"timeout_ms?":10000,"decompress?":true}`, **stdout** `{"status":int,"headers":object,"body_base64?":string,"truncated":bool}`; allow only http/https, stream with hard **byte cap**, ≤5 redirects, preserve `ETag/Last-Modified`, **SSRF guard** as above, UA `agentcli-http-fetch/0.1`; **env** optional `HTTP_TIMEOUT_MS`; **errors** stderr JSON; **audit** `{tool:"http_fetch",url_host,status,bytes,truncated,ms}`; **manifest** add entry with schema and `envPassthrough:["HTTP_TIMEOUT_MS"]`; **Makefile** add to `TOOLS`; **tests** redirects, gzip body, truncation, SSRF block, HEAD; **docs** ref page; **DoD:** build, tests, lint, capabilities OK, docs render.
* [x] **ADR-0010: Adopt SearXNG & network research toolbelt (CLI-only)** — Add `docs/adr/0010-research-tools-searxng.md` describing context (need credible web discovery + provenance), options (direct engine APIs vs meta-search vs scraping), **decision** (SearXNG + small CLI subtools), consequences (operate with SSRF guard, robots respect, retries), and a Mermaid flow (agentcli→tool_calls→fetch/parse→citation); link from `README.md` and `docs/README.md`; **DoD:** file renders on GitHub with diagram, links resolve, no code changes, `make lint test` green.
* [x] **Tool: searxng_search (meta search over the web)** — We have SarxNG running at http://localhost:8888. Create `tools/cmd/searxng_search/searxng_search.go` → `tools/bin/searxng_search(.exe)`; **stdin** `{"q":string,"time_range?":"day|week|month|year","categories?":[string],"engines?":[string],"language?":string,"page?":int,"size?":int<=50}`, **stdout** `{"query":string,"results":[{"title":string,"url":string,"snippet":string,"engine":string,"published_at?":string}]}`; GET `${SEARXNG_BASE_URL}/search?format=json&q=...` with 10s timeout, ≤5 redirects, **retries** 2 on timeout/429/5xx (respect `Retry-After`), **SSRF guard** (block loopback/RFC1918/link-local/IPv6 ::1 & DNS-rebinding), UA `agentcli-searxng/0.1`; **env** required `SEARXNG_BASE_URL`, optional `HTTP_TIMEOUT_MS`; **errors**: single-line stderr JSON `{"error":"...","hint?":"..."}` + exit≠0; **audit** append NDJSON `{ts,tool:"searxng_search",url_host,query,status,ms,retries}` under `.goagent/audit/YYYYMMDD.log` (redact query if >256 chars → `query_truncated:true`); **manifest**: append to root `tools.json` `"name":"searxng_search","description":"Meta search via SearXNG","schema":<stdin JSON Schema>,"command":["./tools/bin/searxng_search"],"timeoutSec":15,"envPassthrough":["SEARXNG_BASE_URL","HTTP_TIMEOUT_MS"]` (Windows uses `.exe`); **Makefile**: add to `TOOLS += searxng_search`; **tests**: offline using `httptest.Server` fixtures for success, 429 with `Retry-After`, 5xx then success, SSRF blocked, bad base URL; **docs**: `docs/reference/searxng_search.md` with examples; **DoD:** `make build-tools` produces binary, `go test ./...` & `make lint` green, `agentcli -capabilities` lists tool, docs render.
* [x] **Tool: robots_check (robots.txt evaluator)** — `tools/cmd/robots_check/robots_check.go`; **stdin** `{"url":string,"user_agent?":"agentcli"}`, **stdout** `{"allowed":bool,"crawl_delay_ms?":int,"group_rules":[string]}`; fetch `<origin>/robots.txt` with internal safe GET (5s), RFC 9309 precedence (UA-specific then `*`), no redirects to non-origin, cache in-process for test, **SSRF guard** applies; **env** none; **errors** stderr JSON; **audit** `{tool:"robots_check",origin,allowed,ms}`; **manifest** add entry; **Makefile** add; **tests** fixtures covering allow/deny precedence, UA match, Crawl-delay; **docs** page with examples; **DoD:** build/tests/lint green, doc render.
* [x] **Tool: readability_extract (article extraction)** — `tools/cmd/readability_extract/readability_extract.go`; **stdin** `{"html":string,"base_url":string}` (≤5 MiB), **stdout** `{"title":string,"byline?":string,"text":string,"content_html":string,"length":int}` using `github.com/go-shiori/go-readability`; **env** none; **errors** stderr JSON; **audit** `{tool:"readability_extract",length,ms}`; **manifest** add entry; **Makefile** add; **tests** article vs nav-heavy fixtures, large HTML rejected; **docs** page; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: metadata_extract (OG/Twitter/JSON-LD)** — `tools/cmd/metadata_extract/metadata_extract.go`; **stdin** `{"html":string,"base_url":string}`, **stdout** `{"opengraph":object,"twitter":object,"jsonld":[any]}`; **errors/audit/manifest/Makefile/docs/tests** similar pattern; **tests** cover all three metadata types; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: pdf_extract (PDF text, optional OCR)** — `tools/cmd/pdf_extract/pdf_extract.go`; **stdin** `{"pdf_base64":string,"pages?":[int]}` (≤20 MiB), **stdout** `{"page_count":int,"pages":[{"index":int,"text":string}]}` via `github.com/ledongthuc/pdf`; if `ENABLE_OCR=true` and page is image-only, shell to `tesseract` (if absent emit stderr JSON `"OCR_UNAVAILABLE"`), 10s/page cap; **SSRF** N/A; **audit** `{tool:"pdf_extract",page_count,ms}`; **manifest** include `envPassthrough:["ENABLE_OCR"]`; **Makefile** add; **tests** normal text PDF, image-only PDF without OCR, with OCR (mock), oversize rejects; **docs**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: rss_fetch (RSS/Atom)** — `tools/cmd/rss_fetch/rss_fetch.go`; **stdin** `{"url":string,"if_modified_since?":string}`, **stdout** `{"feed":{"title":string,"link":string},"items":[{"title":string,"url":string,"published_at?":string,"summary?":string}]}`; conditional GET (pass If-Modified-Since), 5s timeout, **SSRF guard**; **errors/audit/manifest/Makefile/docs/tests**; **tests** RSS, Atom, 304 path; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: wayback_lookup (Internet Archive)** — `tools/cmd/wayback_lookup/wayback_lookup.go`; **stdin** `{"url":string,"save?":false}`, **stdout** `{"closest_url?":string,"timestamp?":string,"saved?":bool}`; call `https://web.archive.org/save/` when `save=true` and `.../available?url=...` for lookup, 3s timeout, 1 retry w/ jitter on 5xx; **audit** `{tool:"wayback_lookup",saved:boolean,ms}`; **manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: wiki_query (MediaWiki summaries/search)** — `tools/cmd/wiki_query/wiki_query.go`; **stdin** `{"titles?":string,"search?":string,"language?":"en"}`, **stdout** `{"pages":[{"title":string,"url":string,"extract":string}]}`; call MediaWiki action API extracts/opensearch per input, 5s timeout, language fallback to `"en"` if miss; **errors/audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: openalex_search (scholarly works)** — `tools/cmd/openalex_search/openalex_search.go`; **stdin** `{"q":string,"from?":string,"to?":string,"per_page?":10}`, **stdout** `{"results":[{"title":string,"doi?":string,"publication_year":int,"open_access_url?":string,"authorships":[...],"cited_by_count":int}],"next_cursor?":string}`; GET `https://api.openalex.org/works?...` (no key), 8s timeout, retries 1; **audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] **Tool: crossref_search (DOI metadata)** — `tools/cmd/crossref_search/crossref_search.go`; **stdin** `{"q":string,"rows?":10}`, **stdout** `{"results":[{"title":string,"doi":string,"issued":string,"container":string,"title_short?":string}]}`; require `CROSSREF_MAILTO` (send polite header), 8s timeout; **audit/manifest (envPassthrough:["CROSSREF_MAILTO"])/Makefile/docs/tests** including quota handling; **DoD:** build/tests/lint green.
* [x] **Tool: github_search (repos/code/issues/commits)** — `tools/cmd/github_search/github_search.go`; **stdin** `{"q":string,"type":"repositories|code|issues|commits","per_page?":10}`, **stdout** `{"results":[...minimal per type...],"rate":{"remaining":int,"reset":int}}`; optional `GITHUB_TOKEN` (bearer), inspect `X-RateLimit-Remaining`, map 0 to stderr JSON `{"error":"RATE_LIMITED","hint":"use GITHUB_TOKEN"}`; 8s timeout, 1 retry on 5xx; **audit/manifest (envPassthrough:["GITHUB_TOKEN"])/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] **Tool: dedupe_rank (near-duplicate detector)** — `tools/cmd/dedupe_rank/dedupe_rank.go`; **stdin** `{"docs":[{"id":string,"url?":string,"title?":string,"text?":string,"published_at?":string}]}`, **stdout** `{"groups":[{"representative_id":string,"members":[string],"score":number}]}`; MinHash (3-shingles) + TF-IDF tie-break; optional `AUTHORITY_HINTS_JSON` to bias ranking; **errors/audit/manifest/Makefile/docs/tests** with deterministic golden; **DoD:** build/tests/lint green.
* [x] **Tool: citation_pack (normalize + archive)** — `tools/cmd/citation_pack/citation_pack.go`; **stdin** `{"doc":{"title?":string,"url":string,"published_at?":string},"archive?":{"wayback?":bool}}`, **stdout** `{"title?":string,"url":string,"host":string,"accessed_at":string,"archive_url?":string}`; if `archive.wayback`, call Wayback lookup (3s), otherwise skip network; **errors/audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] Update `wiki_query` tool schema in `./tools.json` to remove the top-level `oneOf` (OpenAI requires the root to be `{ "type": "object" }` with no `oneOf/anyOf/allOf/enum/not` at the top); set `parameters` **exactly** to `{ "type":"object", "additionalProperties": false, "properties": { "titles": { "type":"string", "description":"Exact page title to fetch summary for (mutually exclusive with 'search')" }, "search": { "type":"string", "description":"Full-text search term to find pages (mutually exclusive with 'titles')" }, "language": { "type":"string", "default":"en", "description":"MediaWiki language code, e.g. en, fi" } } }` and remove the previous `oneOf`; if your tool handlers require mutual exclusivity, enforce it **at runtime** in the `wiki_query` executor (reject when both/neither provided with a clear error string returned as the tool result); verify the JSON with `jq -e '.tools[] | select(.function.name=="wiki_query") | .function.parameters as $p | ($p.type=="object") and (has("oneOf")|not) and (has("anyOf")|not) and (has("allOf")|not) and (has("not")|not) and (has("enum")|not)' ./tools.json >/dev/null`; DoD: running `./bin/agentcli -prompt "ping" -base-url http://api.openai.com.hg.fi/v1 -model gpt-5 -tools ./tools.json -max-steps 1` no longer returns `invalid_function_parameters` and the chat request is accepted (HTTP 200), and the `jq` check passes.
* [x] **Reference & contracts (single page for all research tools)** — Add `docs/reference/research-tools.md` enumerating **each tool’s** stdin/out JSON, required envs, exit codes (0 ok; non-zero with stderr JSON), SSRF/timeout/retry rules, and copy-paste examples; link from main README; **DoD:** page renders with anchors to all tools; `make lint` green.
* [x] **Security posture for research tools** — Add `docs/security/research-tools.md` detailing SSRF allowlist/denylist (block loopback, RFC1918/4193, link-local, `.onion`), robots compliance expectations, outbound UA strings, audit NDJSON fields and **redaction policy**, and guidance for sandboxing tools when used with untrusted prompts; link from `docs/security/threat-model.md`; **DoD:** page renders, links resolve, `make lint` green.
* [x] **Research pipeline diagram** — Add `docs/diagrams/research-pipeline.md` (Mermaid `flowchart`) showing `agentcli → tool_calls → (searxng_search → http_fetch → readability/metadata/pdf/rss) → dedupe_rank → citation_pack → assistant(final)`; link from ADR-0010 and `docs/README.md`; **DoD:** diagram renders on GitHub; links resolve.
* [x] **Runbook: troubleshooting research tools** — Extend `docs/runbooks/troubleshooting.md` with a new section covering: missing envs (`SEARXNG_BASE_URL`, `CROSSREF_MAILTO`), SSRF block messages, 429 with `Retry-After` handling, robots disallow, response truncation (`max_bytes`), and network timeouts (raising `HTTP_TIMEOUT_MS`); **DoD:** content renders; `rg` finds section header; lint green.
* [x] **Examples (manual, no agent)** — Add `examples/research/README.md` with commands like `echo '{"q":"golang"}' | ./tools/bin/searxng_search` and `echo '{"url":"https://..." }' | ./tools/bin/http_fetch | jq .status`, plus a **fixtures-only** test command pinned to `httptest.Server` scripts (commented to avoid network in CI); **DoD:** examples render; no CI network usage.
* [x] **Makefile wiring per tool** — For each tool you implement, append its name to `TOOLS += ...`, ensure `make build-tools` emits `tools/bin/<name>(.exe)` with `-trimpath` and deterministic flags, ensure `make clean` removes it; **DoD:** running `make build-tools clean` leaves `git status` clean, build repeatable (same shasum across two builds).
* [x] Add a link to the main README.md about following the project by following the author at Linkedin (https://www.linkedin.com/in/jheusala/)
* [x] Add global HTTP retry knobs: implement `-http-retries int` (env `OAI_HTTP_RETRIES`, default `2`) and `-http-retry-backoff duration` (env `OAI_HTTP_RETRY_BACKOFF`, default `500ms`) in `cmd/agentcli/flags.go`; wire into the main OpenAI client in `internal/oai/client.go` so all chat/completions use these values; keep precedence `flag > env > default`; update `--help` text in `cmd/agentcli/main.go`; DoD: `go run ./cmd/agentcli --help` shows both flags with precedence notes and defaults, unit test `cmd/agentcli/flags_test.go` table-driven verifies precedence and defaulting.
* [x] Add image API endpoint flags: implement `-image-base-url string` (env `OAI_IMAGE_BASE_URL`, default inherit `-base-url`) and `-image-api-key string` (env `OAI_IMAGE_API_KEY`, default inherit `-api-key` with fallback to `OPENAI_API_KEY`) in `cmd/agentcli/flags.go`; define a new `ImageConfig` struct in `internal/oai/config.go` with resolved values; ensure `-print-config` redacts keys (show last 4 chars only); DoD: `--help` lists both flags and inheritance, `-print-config` prints redacted `image.api_key`, test `internal/oai/config_test.go` verifies inheritance and redaction.
* [x] Add image HTTP behavior flags: implement `-image-http-timeout duration` (env `OAI_IMAGE_HTTP_TIMEOUT`, default inherit `-http-timeout`), `-image-http-retries int` (env `OAI_IMAGE_HTTP_RETRIES`, default inherit `-http-retries`), and `-image-http-retry-backoff duration` (env `OAI_IMAGE_HTTP_RETRY_BACKOFF`, default inherit `-http-retry-backoff`) in `cmd/agentcli/flags.go`; ensure `internal/tools/image/client.go` (or HTTP wrapper) uses these resolved values; DoD: `--help` shows three flags and inheritance, unit tests verify inheritance chain and concrete values applied to HTTP client.
* [x] Expose common Images API parameters as flags (pass-through): add `-image-n int` (env `OAI_IMAGE_N`, default `1`), `-image-size string` (env `OAI_IMAGE_SIZE`, default `1024x1024`), `-image-quality string` (env `OAI_IMAGE_QUALITY`, enum `standard|hd`, default `standard`), `-image-style string` (env `OAI_IMAGE_STYLE`, enum `natural|vivid`, default `natural`), `-image-response-format string` (env `OAI_IMAGE_RESPONSE_FORMAT`, enum `url|b64_json`, default `url`), `-image-transparent-background` (env `OAI_IMAGE_TRANSPARENT_BACKGROUND`, default `false`); map 1:1 to request payload in the image driver; DoD: `--help` lists all with defaults/enums, unit tests assert payload fields equal CLI/env values.
* [x] [S01:image-model-flag-parse] In `cmd/agentcli/main.go::{cliConfig,parseFlags,printUsage}` add `-image-model string` (env `OAI_IMAGE_MODEL`, default `"gpt-image-1"`) stored as `cliConfig.imageModel` and documented in help; DoD: precedence `flag > env > default` is enforced, `agentcli --help` includes the flag line, `make lint && go test ./cmd/agentcli -run TestImageModelFlagPrecedence` green.
* [x] [S03:image-options-scaffold] Create `internal/tools/image/options.go` with `package image` and `type Options struct { Model string }` plus `func NewOptions(model string) Options`; add `internal/tools/image/options_test.go` verifying `NewOptions("foo").Model=="foo"`; DoD: `go test ./internal/tools/image` green and no new linter findings.
* [x] Add missing pre-stage sampling knobs for parity: implement `-prep-temp float` (env `OAI_PREP_TEMP`, default inherit `-temp`) and `-prep-top-p float` (env `OAI_PREP_TOP_P`, conflicts with `-prep-temp`; default unset); reuse the existing capability map to omit unsupported params; reuse the 400 “parameter-recovery” one-time retry path for pre-stage when server rejects an unsupported knob; DoD: `--help` shows both with conflict note, unit tests verify omission logic per capability map and retry path invoked on 400.
* [x] Normalize precedence/inheritance rules across chat/prep/image: centralize resolution in `internal/oai/resolve.go` with helpers `ResolveString`, `ResolveDuration`, `ResolveInt`, `ResolveBool` supporting chains like `flag → env → inheritFrom → default`; refactor chat and prep to use the same helpers; DoD: unit tests achieve 100% branch coverage for all helper functions and representative fields across three phases.
* [x] Update the Harmony messages saver/loader to carry image prompts: when `-save-messages` is used and an image prompt is present, embed an auxiliary `"image_prompt"` field; when `-load-messages` is used, if `"image_prompt"` exists and `-image-prompt*` flags are unset, populate `ImageConfig.Prompt`; DoD: round-trip test saves then loads and preserves image prompt verbatim.
* [x] Documentation update: edit `README.md` and the CLI usage section to document all new flags, environment variables, inheritance and precedence, conflict rules (`-temp` vs `-top-p`, `-prep-temp` vs `-prep-top-p`, prompt vs prompt-file), and examples (e.g., separate image backend via `-image-*` while chat goes to another); include copy-paste examples; DoD: README contains a dedicated “Image generation flags” table and an “Inheritance and precedence” matrix; `markdownlint` passes.
* [x] Add deterministic tests for `--help` output: snapshot test `cmd/agentcli/help_test.go` that renders `--help` and asserts presence of all new flags and key phrases (inheritance, conflicts, defaults) to prevent regressions; DoD: test green locally and fails if any flag doc is removed/changed unexpectedly.
* [x] Example configs and smoke scripts: add `examples/image/README.md` with two working commands demonstrating (1) same backend for chat+image and (2) split backends (e.g., OSS chat + OpenAI images); include a `make smoke-image` target that runs the CLI with `-image-response-format b64_json` and verifies a non-empty output stub from the image driver (use a stubbed driver in tests); DoD: `make smoke-image` exits 0 locally and examples copy-paste work with a valid key.
* [x] Concatenation and normalization of pre-stage prompt: if multiple `-prep-file` or `-prep-prompt` are provided, concatenate in the order seen with `\n\n` separators; trim trailing whitespace; store as `PrepConfig.Prompt` in `internal/oai/config.go`; DoD: unit test `internal/oai/config_test.go::TestPrepPromptConcat` verifies exact joined content and whitespace rules.
* [x] Embed a default “smart prep” prompt: create `assets/prompts/prep_default.md` (content describes goals: derive system prompt, optional developer prompts, tool hints including image generation guidance, and examples; output must be Harmony messages JSON); use `//go:embed assets/prompts/prep_default.md` into `internal/oai/prompts.go`; DoD: file exists with ≥150 lines of clear instructions and one minimal example; unit test asserts non-empty default is loaded when no overrides.
* [x] Backward compatibility and error messages: ensure that existing invocations without new flags behave identically (no behavior change); add explicit error messages for conflicting flags and mixed prompt sources; DoD: a small suite in `cmd/agentcli/compat_test.go` runs legacy invocations (no `-image-*`, no `-http-retries`) and asserts identical resolved config vs pre-change baselines; conflict tests assert precise error strings.
* [x] Resolution logic for pre-stage source: implement `ResolvePrepPrompt()` in `internal/oai/resolve.go` that returns (source: `override|default`, text string); order: (1) `-prep-prompt` joined, (2) `-prep-file` joined, (3) embedded default; DoD: unit tests cover all three branches and verify deterministic results.
* [x] Wire pre-stage prompt into execution: modify `internal/oai/prestage/runner.go` to send `ResolvePrepPrompt()` text as the user message to the pre-stage call (keeping the existing pre-stage system message empty unless capability map requires one); keep existing knobs `-prep-profile`, `-prep-temp`, `-prep-top-p`, `-prep-model`, timeouts, retries; DoD: integration test stubs HTTP and asserts the first pre-stage request’s user content equals resolved prompt.
* [x] Define pre-stage output contract (Harmony): in `docs/harmony-prestage.md`, specify the model must return valid Harmony messages array with optional `system`, zero-or-more `developer`, and optional `tool_config` (names and basic params), and optional `image_instructions`; validator rejects tool calls or `role:"tool"`; DoD: doc committed, validator updated to enforce roles and schema; tests include positive/negative examples.
* [x] Merge pre-stage results into main-call configuration: implement `internal/oai/prestage/merge.go` to (a) replace system prompt if present, (b) append developer prompts, (c) register tool enable/disable hints (respect `-prep-tools-allow-external` safety), (d) capture optional `image_instructions` to pass into image tool as defaults unless overridden by `-image-*`; DoD: unit tests verify each merge behavior and that CLI flags still override merged hints.
* [x] Honor `-prep-dry-run` with new overrides: when `-prep-dry-run` is set, print to stdout the final Harmony messages array that would feed the main call after merging (not just the raw pre-stage output); DoD: golden snapshot test verifies structure and that it reflects overrides and merge rules.
* [x] Extend `-print-messages` and `-save-messages` metadata: include a `"prestage":{"source":"override|default","bytes":N}` field (no prompt text) in the printed/saved JSON; ensure API keys remain redacted; DoD: running with `-print-messages` shows the metadata, tests assert presence and redaction.
* [x] Add `-prep-system` and `-prep-system-file` (optional) for advanced users: allow providing a system message specifically for the pre-stage (repeatable files allowed; exclusivity with `-prep-system` same as prompt/file); precedence `flag > env(OAI_PREP_SYSTEM / OAI_PREP_SYSTEM_FILE) > empty`; DoD: help/docs updated, tests verify precedence and exclusivity; if unset, pre-stage runs without system message (relying on the embedded prompt).
* [x] Capability-map enforcement for pre-stage: reuse main capability map to omit unsupported sampling params (`temperature`/`top_p`) and to opt into `response_format` if server supports JSON mode; DoD: unit tests simulate capability sets and assert omitted/kept fields.
* [x] ADR: add `docs/adr/ADR-00XX-prestage-overrides.md` documenting context, options (no override vs files vs flags), decision (flags + embedded default), rationale (maintain simplicity, reproducibility, and DX), and migration (no breaking changes); link to canonical issue; DoD: ADR merged with diagram of flow.
* [x] Mermaid diagram of execution flow: add `docs/diagrams/prestage_flow.md` with a GitHub-compatible Mermaid sequence diagram showing: CLI parse → ResolvePrepPrompt → Pre-stage call → Validate/merge → Main call → Optional image tool usage; DoD: diagram renders in GitHub and matches implementation.
* [x] Help/snapshot tests: update `cmd/agentcli/help_test.go` snapshot to include new flags and key phrases (repeatable, `'-'` for STDIN, exclusivity, precedence); DoD: test fails on doc drift.
* [x] Implement tool and handler for `code.sandbox.js.run`: create `internal/tools/jsrun/handler.go` to accept `{source:string,input:string,limits:{wall_ms:int,output_kb:int}}`; embed Goja VM, `vm.Set("read_input", func() string {…})`, `vm.Set("emit", func(s string){…})`, run via `vm.RunString(source)`; cap output with a bounded buffer; DoD: unit test shows `emit(read_input())` returns input and output > limit is truncated with error. 
* [x] Timeouts with interruption: implement wall-time cancel by running the VM in a goroutine and stopping it via Goja’s interrupt mechanism (set `vm.Interrupt` / supported pattern) or cooperative check wrapper; ensure an interrupt yields a standardized `TIMEOUT`; DoD: test with `for(;;){}` halts within configured `wall_ms` and returns `TIMEOUT`.
* [x] Deny-by-default capability model: do not bind `require`, `console`, timers, or any FS/net; expose only `emit` and `read_input`; add negative tests proving absent globals; DoD: tests verify `typeof require === 'undefined'`, `typeof console === 'undefined'`.
* [x] Structured errors & schema parity with Starlark: map Goja exceptions to `{code:"EVAL_ERROR",message}`; preserve `TIMEOUT` and `OUTPUT_LIMIT` semantics; DoD: tests assert identical error shapes to Starlark tool for analogous failures.
* [x] Docs & examples: add `docs/interfaces/code.sandbox.js.run.md` with usage, security notes, and pitfalls (no timers/Promise unless explicitly added); DoD: doc linked from README; example works via CLI.
* [x] Observability: add logs and span attributes (tool name, wall_ms, bytes_out); DoD: local run shows structured logs and a span `tools.js.run`.
  - [x] [S01:wasmrun-validate-limits] Validate that `limits.output_kb`, `limits.wall_ms`, and `limits.mem_pages` are strictly > 0 with structured `INVALID_INPUT` errors; add table tests.
* [x] Deny WASI by default: do not instantiate WASI; provide only `env.emit` as host import; add negative test that a WASI-dependent module fails with a clear error (`MISSING_IMPORT`); DoD: test passes and error is documented.
* [x] Host memory read correctness: implement helper to locate the guest memory (`api.Module.Memory()`), bounds-check `[ptr:ptr+len)` before reading, and error on OOB; add unit tests for valid and OOB reads; DoD: tests pass and OOB returns standardized `OOB_MEMORY`.
* [x] Observability: log and span attributes (module size bytes, wall_ms, mem_pages_used, bytes_out); DoD: local run shows structured logs and span `tools.wasm.run`.
* [x] Shared limits & sanitizer: create `internal/sandbox/limits.go` with `BoundedBuffer(maxKB) io.Writer`, wall-time helper, and standard error helpers; vendor (or copy) per tool so each task is independent; DoD: each tool compiles with its own copy and tests verify size/time caps.
* [x] Security notes & examples: for each tool, add a “Security Model” section to its interface doc stating deny-by-default capabilities and no ambient FS/net/clock; include a minimal example and a malicious loop example that times out; DoD: docs exist and examples execute locally with the respective tool CLI invocation.
* [x] Introduce `-state-dir` flag (and `AGENTCLI_STATE_DIR` env) to persist and restore generated execution state (prompts, prep_settings, context notes, tool capability decisions); precedence: CLI > env > empty (=disabled); expand `~`, normalize path, create directory with 0700 (respect `umask 077`); update `cmd/agentcli/main.go` flag parsing, config struct, and `-h` help to describe “stores/loads generated execution state across runs”; DoD: `agentcli -h` shows the flag, table-driven test verifies precedence, empty disables persistence, and directory is created with 0700.
* [x] Define a versioned on-disk “state bundle” schema and filenames; single JSON file per snapshot named `state-<RFC3339UTC>-<8charSHA>.json` containing `{version:"1", created_at, tool_version, model_id, base_url, toolset_hash, scope_key, prompts:{system,developer}, prep_settings:any, context:any, tool_caps:any, custom:any, source_hash}`; maintain atomic pointer file `latest.json` with `{version:"1", path:"state-*.json", sha256}`; permissions 0600 for files; DoD: `internal/state/schema.go` with `StateBundle` type + validation helpers committed and ADR drafted describing schema.
* [x] Implement atomic save `SaveStateBundle(dir, bundle)`; steps: ensure dir 0700; write temp file in same FS, fsync file, `os.Rename` to final `state-*.json`, write `latest.json` to temp + fsync + rename, fsync directory; never log bundle contents at info level; DoD: unit test using tmpfs/tmdir asserts two files exist, perms are 0600, directory fsync path used, and rename pattern prevents torn writes.
* [x] Implement safe load `LoadLatestStateBundle(dir)`; read `latest.json`, verify `version=="1"`, open referenced snapshot, validate schema, return `*StateBundle`; on missing/corrupt/unknown-version or permission errors, return `(nil, ErrStateInvalid)` and log at debug; DoD: table tests for ok/missing/corrupt/unknown-version/EPERM with zero panics and clear error values.
* [x] Add optional `-state-scope` flag (and `AGENTCLI_STATE_SCOPE`) to partition state; compute default `scope_key = sha256(model_id + "|" + base_url + "|" + toolset_hash)`; on save/load only consider bundles whose `scope_key` matches; DoD: unit test shows different model/base or toolset hash yields different scopes and prevents cross-contamination.
* [x] Wire restore-before-prep behavior; if `-state-dir` is set, load latest matching bundle by `scope_key`; when loaded and `-state-refine` is not set, reuse `prompts.*`, `prep_settings`, `context`, and `tool_caps` instead of calling pre-stage LLM; explicit CLI `-prep-prompt/-prep-file` still override reused prompts; DoD: integration test with a fake LLM shows second run performs zero pre-stage calls and uses restored values.
* [x] Introduce refinement controls: `-state-refine` (bool), `-state-refine-text` (string), and `-state-refine-file` (path; wins over text if both provided); when set, call pre-stage LLM with deterministic instruction to refine the loaded bundle using the refine input and current user prompt; on success, write a new snapshot and update `latest.json`; mutual exclusivity is enforced between refine-file/text and empty `-state-dir`; DoD: flags visible in help, invalid combos error with exit code 2 and message, unit tests cover matrix.
* [x] Implement `RefineStateBundle(prev *StateBundle, refineInput string, userPrompt string) (*StateBundle, error)`; requirements: preserve unspecified fields, update `created_at`, recompute `source_hash`, and record `prev_sha`; return new bundle; DoD: unit test with fake LLM verifies prompts/settings changed predictably, fields preserved, `prev_sha` set, and a new file written.
* [x] Enforce effective-source precedence; compute final values with strict order: explicit CLI (`-prep-prompt/-prep-file`) > refined/restored bundle > built-in defaults; if CLI fully overrides prompts while `-state-refine` is set, warn and proceed (no hard error); DoD: table tests verify resulting source for each field and that warnings are logged once.
* [x] Security hardening; reject world-writable `-state-dir` and non-owned directories on Unix; apply lightweight redaction before save (strip `Authorization:` header values, 64+ char base64-like tokens, common API key patterns), and never store raw request/response bodies unless `-debug` and `-state-allow-raw` are explicitly set; DoD: unit tests simulate dir perms (0707) causing refusal, and redaction removes secrets from serialized bundles.
* [x] UX & logging polish; add concise debug logs on save/restore/refine including basename and 8-char SHA; add `--dry-run` to print intended actions (restore/refine/save decisions) without touching disk; DoD: `agentcli --dry-run -debug -state-dir=$TMP` outputs plan and leaves directory empty.
* [x] E2E scenario test (local, deterministic); 1) Run with `-state-dir=$TMP -state-scope=testscope` to generate and save; 2) Run again with same args to confirm restore (no pre-stage calls); 3) Run with `-state-refine -state-refine-text="tighten temperature to 0.2"` to confirm refinement and new snapshot; assert `latest.json` points to newest, file count increments, and effective prompts follow precedence; DoD: a single `go test ./...` passes and prints no secrets.
* [x] Backpressure & corruption handling; when `latest.json` points to a missing file or JSON is partially written, auto-quarantine bad files by renaming to `*.quarantined` and continue with regeneration; never delete originals; DoD: unit test seeds corrupt files and verifies quarantine + successful regeneration path.
* [x] Concurrency & locking; implement coarse-grained advisory file lock (`state.lock`) during save/load to avoid concurrent writers; on lock contention, wait up to 2s with jitter then proceed without crashing; DoD: race test spawns two writers, only one succeeds per snapshot and no partial files are observed.
* [x] Public docs & ADR; write ADR “Persist and refine execution state via `-state-dir`” with context (need reproducible runs and continuity), options (no persistence vs file store vs DB), decision (file-based JSON bundles with scopes), and rationale (simplicity, testability); include a Mermaid sequence diagram for first-run/restore/refine and copy-pastable CLI examples; update README with usage and security notes; DoD: ADR and README committed, diagram renders on GitHub.
