* [ ] Switch submodule URLs in .gitmodules from SSH to HTTPS to simplify CI clones without SSH keys (public submodules .cursor/rules and scripts), smallest change is editing .gitmodules and running git submodule sync; scope repository hygiene; low risk; DoD includes actions/checkout with submodules enabled succeeding in a new CI workflow, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by observing CI clone success without extra SSH setup and local git submodule update --init works, rollback by reverting the .gitmodules change and syncing.
* [ ] Strengthen the Makefile test target to run go test -race -cover ./... and write a coverage profile under bin/coverage.out so local testing matches planned CI gates, smallest change is editing the Makefile test recipe only; scope Makefile; low risk; DoD includes running make test from a clean clone succeeds with race detector enabled and coverage file produced, tests otherwise unchanged and green with no coverage regression, all quality gates green with no new findings, peer review completed, verification by observing race-enabled run and generated coverage file, rollback by reverting the Makefile edit.
* [ ] Add a make vuln target that installs and runs govulncheck ./... and wire it into CI after unit tests to fail builds on known vulnerabilities, smallest change is adding the target in the Makefile and a CI step once workflows exist; scope security scanning; low risk; DoD includes make vuln passing locally on a clean tree, CI green with the new step and no new findings, tests unchanged and green with no coverage regression, all gates green, peer review completed, verification by introducing a known vulnerable transient dependency in a branch to see CI fail then removing it restores green, rollback by reverting the Makefile and CI edits.
* [ ] Add secret detection with gitleaks via a make secrets target and a CI step using the official action with a minimal .gitleaks.toml allowlist to reduce false positives, smallest change is adding the config, target and CI step; scope security hygiene; low risk; DoD includes make secrets passing locally on a clean tree, CI green with no new leaks, tests unchanged and green with no coverage regression, all gates green, peer review completed, verification by committing a fake test secret in a branch to observe CI fail then removing it restores green, rollback by reverting the config and CI step.
* [ ] Standardize all Bash scripts under scripts to use env bash shebang and strict mode set -euo pipefail and add a make shellcheck target with a minimal configuration plus a CI step to run it, because several scripts currently lack pipefail or only set -u which weakens detection of failures; smallest change is editing script headers, adding one Makefile target, and a short workflow step; scope scripts, Makefile, CI; low risk; DoD includes an initial failing run then passing with zero shellcheck warnings, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by running shellcheck locally and observing CI green, rollback by reverting the script, Makefile, and workflow edits.
* [ ] CI smoke job for tools — workflow builds tools, runs each binary with sample stdin, and runs an agent loop against a fake API; no external network dependence; DoD: green in PRs, artifacts attached, linked to issue.
* [ ] Add docs/operations/ci-quality-gates.md mapping each quality gate to exact local commands and expected outputs for lint vet fmt unit and integration tests and coverage including a note on fixing golangci-lint not found by adding the Go bin directory to PATH, smallest change is one runbook file and a link from README Tests, low risk, DoD includes commands verified from a clean clone tests unchanged and green with no coverage regression all gates green in CI peer review completed verification by following steps locally rollback by reverting the doc and links, traceability https://github.com/hyperifyio/goagent/issues/213.
* [ ] Document the release process in docs/releasing.md including tagging artifact naming checksums and verification and rollback guidance aligned with the planned release workflow, smallest change is a single page and links from README and the future release workflow, scope documentation, low risk, DoD includes dry run steps validated locally without publishing tests unchanged and green all quality gates green peer review completed verification by executing the documented commands in dry run rollback by removing the doc and links, traceability https://github.com/hyperifyio/goagent/issues/214.
* [ ] Add release workflow for static binaries and checksums: `.github/workflows/release.yml` triggered on tags like `v*`; build `agentcli` for `linux,darwin,windows` × `amd64,arm64` with `CGO_ENABLED=0`; name outputs `agentcli_<os>_<arch>` (Windows `.exe`); generate `SHA256SUMS` and `SHA256SUMS.sig` (optional GPG); create GitHub Release and upload artifacts and checksums; document in README how to download and verify.
* [ ] Add a make sbom target that uses syft (or cyclonedx-gomod as a fallback if syft is unavailable) to produce a CycloneDX SBOM at reports/sbom.json from the current module and wire it into the release workflow to upload as an asset, because the repo currently lacks an SBOM which weakens supply-chain visibility; smallest change is adding one Makefile target and a short CI step with a docs sentence; scope Makefile and CI; low risk; DoD includes failing first when the tool is missing then passing with deterministic output on a clean clone, tests unchanged and green with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security and secret scans) with no new findings, backward compatibility preserved, peer review completed, verification by running make sbom locally and seeing reports/sbom.json and by confirming the asset on a tagged release, rollback by reverting the Makefile and workflow edits.
* [ ] Tag and publish `v0.1.0` once CI is green and docs/tests are complete: ensure `README.md` has usage, examples, and limitations (no streaming, sequential tool calls only); ADR-0001 and sequence diagram present; unit and integration tests passing; create annotated tag `git tag -a v0.1.0 -m "MVP non-interactive agent CLI with OpenAI-compatible tools"` and `git push --tags`.
* [ ] Add GitHub Dependabot at .github/dependabot.yml to update Go modules weekly and GitHub Actions monthly so dependencies and CI actions stay current with minimal noise; smallest change is committing a single dependabot.yml file; scope repository hygiene; low risk and independent; DoD includes Dependabot PRs opening on schedule with passing CI and no coverage regression, all quality gates green (vet, format, lint, security and secret detection) with no new findings, peer review completed; verification by observing the first PRs or running a local preview, rollback by removing the configuration file.
* [ ] CLI errors: when required flags (e.g., `-prompt`) are missing, print concise error followed by the usage synopsis and exit with code 2 (not 1); DoD: unit test verifies stderr contains error + usage, exit code is 2, no network or tool exec attempted; CI and all gates green; one peer review completed.
* [ ] CLI version: add `--version`/`-version` to print semver + commit + build date and exit 0 without validating other flags; DoD: unit test asserts format and exit code; README “Usage” updated; CI and all gates green; one peer review completed.
* [ ] Reference docs: add `docs/reference/cli.md` that enumerates every flag with default, env fallback, precedence, and exit codes for `--help`/`--version`/missing-required; link from README; DoD: doc renders on GitHub, content matches current binary (checked by a small test that scans `--help` output for each documented flag), CI and all gates green; one peer review completed.
* [ ] Add CODEOWNERS at .github/CODEOWNERS to automatically request reviews from maintainers; smallest change is committing one CODEOWNERS file mapping paths to the maintainers team; scope repository hygiene; low risk; DoD includes PRs auto-requesting reviews from owners, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by opening a test pull request and observing requested reviewers; rollback by removing the CODEOWNERS file.
* [ ] Add SECURITY.md under .github with a concise vulnerability disclosure policy including contact, supported versions, and response expectations, and link it from README; smallest change is a single Markdown file and one README sentence; scope security documentation; low risk; DoD includes the GitHub Security tab surfacing the policy, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by visiting the repository Security page, rollback by removing the file and README link.
* [ ] Add pull request template at .github/PULL_REQUEST_TEMPLATE.md prompting for canonical issue URL, intent, Definition of Done checklist, and test plan; smallest change is committing one template file; scope contribution workflow; low risk; DoD includes new pull requests prefilled with the template, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by opening a draft pull request and seeing the template, rollback by removing the template file.
* [ ] Add issue templates at .github/ISSUE_TEMPLATE/bug_report.yml and .github/ISSUE_TEMPLATE/feature_request.yml plus config.yml to disable blank issues; smallest change is committing two minimal YAML templates and one config; scope issue hygiene; low risk; DoD includes the New issue page showing the templates with required fields, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by clicking New issue and observing the choices, rollback by removing the templates.
* [ ] Upload coverage profile and summary in CI by attaching bin/coverage.out as an artifact and printing total coverage using go tool cover func; smallest change is adding two steps in .github/workflows/ci.yml after the test step; scope CI; low risk; depends on the Makefile test target producing a coverage profile as already planned; DoD includes CI artifacts containing coverage.out and logs showing total coverage percentage, tests otherwise unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by inspecting CI artifacts and logs, rollback by removing the new steps.
* [ ] Add GitHub CodeQL code scanning for Go by committing .github/workflows/codeql.yml using the official CodeQL action with default queries on push and pull_request so security analysis runs automatically; evidence: no CodeQL workflow exists today; scope .github/workflows only; low risk and independent; DoD: CodeQL job runs green with zero new alerts, tests unchanged and green with no coverage regression, all quality gates green (vet, gofmt, golangci-lint, staticcheck, security and secret detection) with no new findings, peer review completed; verify by viewing the Security > Code scanning alerts page and the workflow run logs; rollback by deleting the workflow file.
* [ ] Add jq to README Installation prerequisites with OS-specific install snippets (apt, brew, choco) because README examples and runbooks pipe tool output to jq but prerequisites omit it; smallest change is editing README only; scope documentation; low risk and independent; DoD: README renders correctly on GitHub, examples run from a clean clone with jq installed, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by executing one README example end-to-end with jq and observing the pretty-printed JSON; rollback by reverting the README edit.
* [ ] Add a primary CI workflow at .github/workflows/ci.yml that runs make tidy lint test build build-tools on a Go matrix (linux, macOS, windows) using actions/setup-go with go-version-file: go.mod and installs ripgrep where required; evidence: no workflows exist under .github/workflows; scope CI only; low risk and independent; DoD includes green runs on all OSes with all quality gates passing (vet, gofmt, golangci-lint, static analysis, security and secret detection), tests unchanged and green with race and coverage where configured, coverage artifacts uploaded when present, one peer review completed; verify by viewing successful workflow runs and artifacts in GitHub Actions; rollback by deleting ci.yml.
* [ ] Fix gofmt -s formatting drift by running make fmt and committing the resulting changes for the currently flagged files (e.g., cmd/agentcli/*.go, internal/oai/*.go, tools/cmd/fs_read_file/fs_read_file.go, tools/cmd/fs_write_file/fs_write_file.go) so fmtcheck is green; scope code formatting only; low risk and independent; DoD includes gofmt -s -l . returning no files, make fmtcheck and make lint passing locally and in CI, tests otherwise unchanged and green with no coverage regression, all quality gates green, one peer review completed; verify by running make fmtcheck; rollback by reverting the formatting commit.
* [ ] **ADR-0004: Budgeted IO & Loop Control** — Add `docs/adr/0004-budgeted-io-and-loop-control.md` describing: (a) per-connection transport timeouts (connect=3s, TLS=3s, responseHeader=10s) vs. per-request **stepBudget=45s** vs. **conversationBudget=120s**; (b) no use of `http.Client.Timeout` for long reads; (c) bounded retries only on 429/5xx, `"prediction-error"`, and `"Model is unloaded"` (warm-up then one retry); (d) duplicate tool-call breaker (K=3, normalized `{name, canonicalArgsJSON}`); (e) optional SSE streaming on localhost with idle timeout 15s; (f) exit codes: OK=0, LIMIT=75, SERVICE=69, CONFIG=78, GENERIC=1; (g) loop/timeout logging; **DoD:** ADR renders on GitHub, linked from `docs/README.md` and `README.md`; includes context/options/decision/rationale and canonical issue URL; no code changes; CI/tests unaffected; one reviewer approved.
* [ ] **Create transport with fine-grained timeouts; remove global client timeout** — In `internal/oai/client.go` (or equivalent): build `http.Transport{ DialContext: (&net.Dialer{Timeout:3s}).DialContext, TLSHandshakeTimeout:3s, ResponseHeaderTimeout:10s, ExpectContinueTimeout:1s }`; construct `http.Client{Transport: tr}` and **delete** any `http.Client.Timeout` usage; keep-alives enabled; **DoD:** Unit test with `httptest.Server` that never sends headers → request fails within \~10s; lints/type checks pass; no flags added; commit links the issue; one reviewer; `go test ./...` green.
* [ ] **Per-request step budget via context** — In `internal/oai/*` call sites, wrap each request with `ctx, cancel := context.WithTimeout(conversationCtx, 45*time.Second)` and pass to `NewRequestWithContext`; ensure body fully read within this context (no lingering goroutines); **DoD:** Integration tests: server sends headers quickly, streams body for 40s → success; streams >45s → client cancels with clear error; deterministic (no sleeps >100ms), lints green, issue linked, reviewer approved.
* [ ] **Conversation-wide budget** — In `cmd/agentcli/main.go`, create `conversationCtx, cancel := context.WithTimeout(context.Background(), 120*time.Second)` for the whole loop; when exceeded, exit with code **75** and message `LIMIT: conversation budget 120s exceeded after <n> steps (base=<url>, stream=<on|off>)`; **DoD:** Table-driven tests forcing long sequence to exceed 120s (using fake clock or controllable server) → proper exit code/message; docs unchanged; lints/tests green; issue link; review done.
* [ ] **Honor `-max-steps` as a hard cap** — In the run loop, if steps hit the configured `-max-steps`, exit with **75** and message `LIMIT: step limit <N> reached (base=<url>, stream=<on|off>)`; **DoD:** Unit test with server returning non-final responses for N iterations → exits at N with code 75; lints/tests green; issue link; review done.
* [ ] **Duplicate tool-call breaker (K=3)** — After receiving assistant tool calls, normalize each to `{name, canonicalArgsJSON}` (canonical JSON: sorted keys, no whitespace); keep a sliding window of last K sets; if same set repeats K times consecutively, abort with **75** and print `LIMIT: repeating identical tool calls (K=3) for <normalized set>`; **DoD:** Integration test server always returns same tool call → breaker triggers on 3rd repeat; variant test with differing args does **not** trigger; deterministic; lints/tests green; issue link; review done.
* [ ] **Retry classifier for LM Studio errors + warm-up** — In `internal/oai`, when response body contains `"prediction-error"`: retry **once**; when `"Model is unloaded"`: perform `GET /v1/models` then retry **once**; also retry on 429/5xx up to 3 attempts with exponential backoff (e.g., 100ms, 200ms, 400ms; jitterless); never retry DNS/dial/TLS/context errors; return final error `SERVICE: <status> <<=256-char body>` with attempt count; **DoD:** `httptest.Server` cases covering both strings and 5xx/429; asserts number of attempts and that warm-up endpoint was hit; no global sleeps (use controllable clock/backoff injection); lints/tests green; issue link; review done.
* [ ] **Optional SSE streaming on localhost** — Implement `stream: true` path in `internal/oai` that accumulates deltas; auto-enable when `base` host is `localhost|127.0.0.1|RFC1918` unless `OAI_DISABLE_STREAM=1`; abort stream if no event for **15s** (idle timeout) even if stepBudget not reached; if server rejects stream (400/405), fall back to non-stream automatically; support streamed tool calls (close stream once a full tool\_call is formed); **DoD:** SSE fake server tests (success within budgets; idle silence triggers LIMIT=75; fallback path exercised); no user flags added; lints/tests green; issue link; review done.
* [ ] **Per-step telemetry to stderr** — Print one line per step (suppressed by `-quiet`) to **stderr**: `step=<i> duration=<s> tool_calls=[names] tokens_in=<n|n/a> tokens_out=<n|n/a> result=<ok|timeout|error> base=<url> stream=<on|off>`; **DoD:** Integration test captures stderr and matches regex; `-quiet` hides output; lints/tests green; issue link; review done.
* [ ] **Write-guard for `fs_write_file` (expectedSha256)** — In `tools/cmd/fs_write_file/fs_write_file.go`, accept optional `"expectedSha256"`; if file exists and SHA-256 != expected, write stderr JSON `{"error":"precondition failed: expectedSha256 mismatch"}` and exit non-zero; if file missing and expected provided, error `{"error":"precondition failed: file does not exist"}`; on success unchanged behavior; **DoD:** Unit tests for match/mismatch/missing; README tool section updated with example; lints/tests green; issue link; review done.
* [ ] **Standardize exit codes & final messages** — Centralize exit mapping in `cmd/agentcli`: OK=0, LIMIT=75, SERVICE=69, CONFIG=78, GENERIC=1; ensure all exits print a single concise line including `base=<url> steps=<n> stream=<on|off> reason=<text>`; update `-h` to document codes; **DoD:** Unit tests for each path; help text snapshot test; lints/tests green; issue link; review done.
* [ ] **`agentcli doctor` (reachability + budgets echo)** — Add `doctor` subcommand printing: resolved `base`, streaming heuristic state, transport timeouts, `stepBudget`, `conversationBudget`; perform `GET /v1/models` and report OK or `SERVICE(69)` with status/body snippet; no tools executed; **DoD:** `httptest.Server` tests (success and failure); README adds a short usage snippet; lints/tests green; issue link; review done.
* [ ] **Runbook: LM Studio specifics** — In `docs/runbooks/troubleshooting.md` add a section “LM Studio: JIT loading & ‘Client disconnected’”: explain why it appears when the client cancels reads; show how budgets avoid it; document the one-time warm-up behavior; include copy-paste commands: `./bin/agentcli doctor` and an example `./bin/agentcli -prompt 'hi' -debug` with expected outcomes; **DoD:** Docs render; commands validated locally; linked from `README.md` Troubleshooting; issue link; one reviewer.
* [ ] **ADR-0003: Adopt Harmony rendering path for gpt-oss;** add `docs/adr/0003-harmony-support.md` with context (gpt-oss requires Harmony; roles+channels; function tools), options (status quo Chat Completions vs direct Harmony renderer vs hybrid), decision (hybrid: keep Chat Completions but render Harmony-conformant system/developer content and filter CoT), rationale, consequences, links to the official Harmony guide; **DoD:** ADR committed and linked from `README.md` + `docs/README.md`; includes a Mermaid sequence of messages with channels; one peer review; CI green. ([OpenAI Cookbook][1])
* [ ] **Add Harmony mode flag + defaults;** extend CLI with `-harmony` (bool, default auto when `-model` contains `gpt-oss`) and `-reasoning {low|medium|high}` (default `medium`), and new `-instructions` (string) for developer instructions (keep `-system` for model identity and meta); **DoD:** flags parsed with precedence (flag > env > default), help text updated, unit tests for flag/env resolution, `README` usage updated, CI green. ([OpenAI Cookbook][1])
* [ ] **Implement `internal/harmony/system.go` renderer;** function `RenderSystem(knowledgeCutoff string, now time.Time, reasoning string, withFunctions bool) string` that emits the exact format shown in the cookbook (identity “You are ChatGPT…”, “Knowledge cutoff:”, “Current date:”, `Reasoning: <level>`, valid channels line; add “Calls to these tools must go to the commentary channel: 'functions'.” when tools present); **DoD:** golden-file unit test asserting output text matches spec (including newlines); time injected via clock interface; CI green. ([OpenAI Cookbook][1])
* [ ] **Implement `internal/harmony/developer.go` renderer;** function `RenderDeveloper(instructions string, toolSchemas []oai.ToolSpec, responseFormats []ResponseFormat) string` that emits `# Instructions` followed by instructions, then (if tools) a `# Tools` section using a `namespace functions { … }` TypeScript-style signature per the cookbook (arg name `_`, return `any`, comments above fields), and optionally `# Response Formats` with JSON Schemas as shown; **DoD:** property-based tests for schema→TS type conversion (round-trip names, required/optional, enums), fixture test for a tool producing byte-for-byte expected output; CI green. ([OpenAI Cookbook][1])
* [ ] **Allow “developer” role in Chat payloads with graceful fallback;** extend `internal/oai/types.go` to permit `role:"developer"` in messages; when the server rejects unknown roles (non-2xx or schema error), fallback to embedding developer text into the `system` message while keeping tools array; **DoD:** httptest server simulating both behaviors (accept/400) proves fallback; unit tests assert both paths; CI green. ([OpenAI Cookbook][1])
* [ ] **Inject Harmony system+developer messages automatically when `-harmony` on;** in `cmd/agentcli/main.go`, before first API call, build messages: `system=RenderSystem(...)`, `developer=RenderDeveloper(...)`, then `user`; continue to advertise OpenAI `tools[]` as today (for providers that map tools); **DoD:** integration test using `httptest.Server` asserts first request contains both messages and unchanged tools array; docs updated; CI green. ([OpenAI Cookbook][1])
* [ ] **Drop chain-of-thought from history and output;** when `-harmony` is enabled, never print assistant content that includes Harmony CoT markers (lines starting with `<|channel|>analysis`), and when appending previous turns, only persist assistant messages that are `final` (or messages without explicit Harmony markers); **DoD:** unit test feeds a response containing analysis+final; printed output includes only final; history compaction test ensures analysis is not re-sent unless tool-calling is active (documented exception); CI green. ([OpenAI Cookbook][1])
* [ ] **Normalize `<|return|>` to `<|end|>` when persisting;** intercept assistant text that ends with `<|return|>` and store it as `<|end|>` per cookbook note (only when `-harmony`); **DoD:** unit test verifies normalization; comment references spec; CI green. ([OpenAI Cookbook][1])
* [ ] **Tool-calling channel note;** when tools are present and `-harmony` is on, append to the rendered system message: “Calls to these tools must go to the commentary channel: 'functions'.”; **DoD:** golden test on `RenderSystem(..., withFunctions=true)` contains the sentence; docs mention why; CI green. ([OpenAI Cookbook][1])
* [ ] **Type-safe response-format hook (optional schemas);** add `-response-format-name` and `-response-format-schema-path` flags; when set and `-harmony` is on, load JSON Schema and include under `# Response Formats` with that name; **DoD:** file-read error handling with stderr JSON `{"error":...}` and non-zero exit; unit test with a small schema fixture; README example; CI green. ([OpenAI Cookbook][1])
* [ ] **Reasoning level tests + defaults;** ensure `-reasoning` wires into `RenderSystem` (`low|medium|high`); default `medium`; **DoD:** table-driven tests for each level; README clarifies safety note about not displaying `analysis`; CI green. ([OpenAI Cookbook][1])
* [ ] **Harmony quickstart doc;** add `docs/prompting/harmony.md` showing exact wires: CLI flags, rendered system/developer examples, why we hide `analysis`, and a minimal “hello world (fs\_write\_file)” run; **DoD:** doc linked from README; commands runnable on a clean clone (`make build build-tools`); screenshot or snippet of rendered system/developer text; peer review; CI docs check green. ([OpenAI Cookbook][1])
* [ ] **Update sequence diagram;** add `docs/diagrams/harmony-seq.md` Mermaid showing `system+developer → assistant(analysis) → tool(commentary) → assistant(final)` with the `<|call|>` / `<|return|>` decision points; **DoD:** diagram renders on GitHub, referenced from ADR-0003 and harmony doc; CI green. ([OpenAI Cookbook][1])
* [ ] **Server-compat test shim;** add an integration test that **does not** depend on LM Studio by faking a server that verifies we send a `developer` role when accepted and verifies fallback when rejected; **DoD:** `go test ./cmd/agentcli -run Harmony` passes offline; coverage unchanged; CI green.
* [ ] **Safety gate for accidental CoT leakage;** add a regression test that fails if any printing path writes text containing `<|channel|>analysis` to stdout; **DoD:** test in `cmd/agentcli` with a fake completion body; CI green. ([OpenAI Cookbook][1])
* [ ] **Configuration runbook;** extend `docs/runbooks/troubleshooting.md` with a Harmony section: how to detect providers that already render Harmony for you (LM Studio/Ollama) vs when to enable `-harmony`, common errors (unknown role `developer`, schema parse), and expected logs; **DoD:** doc updates included; links to ADR-0003 and harmony doc; CI green. ([OpenAI Cookbook][1])
* [ ] **Telemetry breadcrumbs;** when `-debug`, log a single line before first request indicating Harmony mode (on/off), reasoning level, and whether developer role was sent or inlined; **DoD:** unit test asserts log line content; respects existing debug flag; CI green.
* [ ] **Backwards-compat toggle;** add env var `GOAGENT_HARMONY=0|1` overriding auto-detect; **DoD:** precedence tests (flag > env > auto), README table updated; CI green.
* [ ] **Add `-reasoning-effort` flag and wire it into request JSON.** Implement a new CLI flag `-reasoning-effort` with allowed values `auto|low|medium|high` (default: `medium`). In the chat request payload, set `reasoning.effort` to the chosen value unless `auto` (omit field). **DoD:** TDD: unit test for flag parsing and for HTTP body containing `"reasoning":{"effort":"medium"}` by default; test for `auto` omits the field; README updated with flag; all linters/formatters pass; CI green.
* [ ] **Default to hiding chain-of-thought safely, with an escape hatch.** Add `-show-cot` (bool, default: `false`). If `false`, include `"reasoning":{"exclude":true}` in the request; if `true`, omit `exclude`. Never print internal reasoning in logs. **DoD:** Unit tests for both paths asserting request JSON; doc note linking to Harmony/CoT guidance; static analysis, security scan clean; CI green.
* [ ] **Inject Harmony ‘Reasoning: …’ line into the system message.** Before sending, if `-reasoning-effort != auto`, prefix the system content with a single line `Reasoning: <effort>` unless a `Reasoning:` line already exists (idempotent). Works regardless of other prompt formatting. **DoD:** Unit test that verifies the system message contains `Reasoning: medium`; test that double-injection does not occur; docs include snippet showing both API param + Harmony line; CI green.
* [ ] **Add `-prompt-format` option (`plain|harmony`) and make the injection conditional.** Introduce `-prompt-format` (default `plain`). When `harmony`, keep the `Reasoning:` line and preserve other Harmony conventions; when `plain`, still send the JSON `reasoning` object but skip the `Reasoning:` line unless user explicitly set `-reasoning-effort` (then include it). **DoD:** Unit tests covering both formats; README shows examples; no coverage drop; CI green.
* [ ] **Request-builder refactor for testability.** Extract a pure function `BuildChatRequest(opts) -> (bodyBytes, messagesPreview)` that assembles both the JSON request and final system content (with/without Harmony). **DoD:** Pure unit tests for this function (golden tests for: default, `-show-cot`, all `-reasoning-effort` values, both prompt formats); 100% branch coverage on the new function; CI green.
* [ ] **Add an HTTP recorder test to guarantee wire-format correctness.** Use `httptest.Server` to capture the outbound body and assert both the `reasoning` object and the `Reasoning:` line appear exactly as intended; verify unknown fields don’t break when server echoes 200. **DoD:** Integration test passes locally and in CI; flakiness ≤ 0 failures in 50 runs; no new linter findings.
* [ ] **UX failsafe: warn once if backend seems to ignore `reasoning`.** If the server returns 200 but the response headers/body include a known sentinel that means “param ignored” (or model name doesn’t advertise reasoning), log a single INFO: “Backend may ignore `reasoning`—Harmony `Reasoning:` line still applied.” **DoD:** Unit test using a fake response; docs mention the warning; CI green.
* [ ] **Examples & docs.** Add `examples/reasoning/` with: (1) `curl.json` like above; (2) a `goagent` command showing Harmony format + effort; (3) note about safe default (medium, CoT excluded). **DoD:** Examples runnable; README section links to OpenAI Harmony article and GPT-OSS HF page; docs spell out defaults and flags; CI lint/docs checks pass.
