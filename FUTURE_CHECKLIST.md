* [x] Ensure `check-go-version` is enforced in CI and locally by wiring it into `make lint`. Smallest change: prepend `$(MAKE) check-go-version` in the `lint` recipe before any linter runs. DoD: `make lint` fails fast on version drift (manual test by temporarily exporting an older/newer Go on a dev machine), passes otherwise; CI shows the check executed before golangci-lint; all gates green; peer review completed.
      - [x] [S02a1c0:l252-ci-push-preflight-blocked] Preflight on this headless runner indicates GitHub authentication is missing. Next step: on a browser-capable host run `gh auth login -h github.com --git-protocol ssh --scopes admin:public_key --device`, verify `ssh -T git@github.com` greets successfully, then execute `scripts/ci_push_pr.sh`. Capture the PR and CI run URLs and verify lint logs show `check-go-version: OK` before `golangci-lint version` across the matrix.
    - [x] [S02u0a1b:l252-gh-device-login-blocked] Preflight on this runner shows `gh auth status` invalid token, `git_protocol=ssh`, `ssh -T git@github.com` fails with publickey, and `GH_TOKEN` absent. Next: on a machine with a browser, run `gh auth login -h github.com --git-protocol ssh --scopes admin:public_key --device`, complete the device flow, then re-run `gh auth status -h github.com` and proceed to add the SSH key.
    - [x] [S02u0a1c0:l252-gh-device-login-web-preflight] Verified local gates are green (go test, make lint), `gh auth status -h github.com` reports invalid/absent token and `gh config get -h github.com git_protocol` is `ssh`; blocked awaiting browser-based device flow on a capable host. Next: perform the device-flow login on a browser host per S02u0a1c, then return to verify and proceed to add the SSH key.
    - [x] [S02a1b0:l252-ci-green-auth-blocked-preflight] Local gates green (go test, make lint); authentication remains absent on this headless host. Recorded BLOCKED state and next step in `logs/coding.log` and `logs/gh_auth_status.*`. Next: complete device-flow login on a browser-capable machine, add SSH key, verify `ssh -T git@github.com`, then push branch and open PR to trigger CI.
    - [x] [S02u1:l252-ssh-keygen] Generate an SSH key pair and surface the public key for account enrollment; DoD: `~/.ssh/id_ed25519.pub` exists, fingerprint recorded in `logs/coding.log`, and instructions included to add the key via GitHub Web or `gh ssh-key add` so a subsequent `ssh -T git@github.com` can succeed.
  - [x] [S11:l252-ci-skeleton-file] Create `.github/workflows/ci.yml` (new) containing a single job `lint-test-build` with a step named exactly `lint (includes check-go-version)` that runs `make tidy && make lint | tee lint.log` and a subsequent step named exactly `Assert lint order (check-go-version before golangci-lint)` that compares line numbers of `^check-go-version: OK` and `^golangci-lint version` in `lint.log` (fail if absent or out of order); DoD: `go test ./internal/ci -run TestLintOrderLocallyAndInWorkflow` passes locally reading the workflow file and finding both expected step names.
  - [x] [S12:l252-ci-matrix-gover] Expand the workflow to a matrix over `{ubuntu-latest, macos-latest, windows-latest}` and use `actions/setup-go@v5` with `go-version-file: go.mod` in the `lint-test-build` job; DoD: workflow syntax validates, unit test still passes, and a PR run shows the same Go major.minor across OSes in logs.
  - [x] [S13:l252-windows-install-rg] Add a Windows-only step before lint to install ripgrep (e.g., `choco install ripgrep -y`) so `make lint`’s `check-tools-paths`/`verify-manifest-paths` do not fail due to `ensure-rg`’s Linux/macOS-only installer; DoD: on `windows-latest`, the `lint (includes check-go-version)` step completes and finds `rg` on PATH.
  - [x] [S14:l252-windows-shell-bash] For `windows-latest`, force GNU bash for all `run` steps that invoke `make` (set `defaults.run.shell: bash` at the job level or `shell: bash` per step) to satisfy Makefile’s bashisms and `SHELL := /bin/bash`; DoD: Windows lint step executes successfully without PowerShell/`/bin/sh` path errors, and the unit test remains green.
* [x] Add `make lint-precheck` to fail fast on analyzer/export-data mismatches. Smallest change: implement a shell precheck used by `lint` that (1) validates `$(GOBIN)/golangci-lint` exists, (2) extracts `GCL=$$($(GOBIN)/golangci-lint version | sed -nE 's/.*version ([v0-9\\.]+).*/\\1/p')`, (3) compares against `MIN=v1.60.0` using `sort -V`, and (4) prints an explicit hint if too old: “golangci-lint $GCL < $MIN with Go \$\$(go version)… update GOLANGCI\_LINT\_VERSION”. DoD: with a forced older version, `make lint` fails before analysis with the hint; with the pinned version, it proceeds; CI green; peer review completed.
* [ ] Strengthen the Makefile test target to run go test -race -cover ./... and write a coverage profile under bin/coverage.out so local testing matches planned CI gates, smallest change is editing the Makefile test recipe only; scope Makefile; low risk; DoD includes running make test from a clean clone succeeds with race detector enabled and coverage file produced, tests otherwise unchanged and green with no coverage regression, all quality gates green with no new findings, peer review completed, verification by observing race-enabled run and generated coverage file, rollback by reverting the Makefile edit.
* [ ] Switch submodule URLs in .gitmodules from SSH to HTTPS to simplify CI clones without SSH keys (public submodules .cursor/rules and scripts), smallest change is editing .gitmodules and running git submodule sync; scope repository hygiene; low risk; DoD includes actions/checkout with submodules enabled succeeding in a new CI workflow, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by observing CI clone success without extra SSH setup and local git submodule update --init works, rollback by reverting the .gitmodules change and syncing.
* [ ] Add a make vuln target that installs and runs govulncheck ./... and wire it into CI after unit tests to fail builds on known vulnerabilities, smallest change is adding the target in the Makefile and a CI step once workflows exist; scope security scanning; low risk; DoD includes make vuln passing locally on a clean tree, CI green with the new step and no new findings, tests unchanged and green with no coverage regression, all gates green, peer review completed, verification by introducing a known vulnerable transient dependency in a branch to see CI fail then removing it restores green, rollback by reverting the Makefile and CI edits.
* [ ] Add secret detection with gitleaks via a make secrets target and a CI step using the official action with a minimal .gitleaks.toml allowlist to reduce false positives, smallest change is adding the config, target and CI step; scope security hygiene; low risk; DoD includes make secrets passing locally on a clean tree, CI green with no new leaks, tests unchanged and green with no coverage regression, all gates green, peer review completed, verification by committing a fake test secret in a branch to observe CI fail then removing it restores green, rollback by reverting the config and CI step.
* [ ] Standardize all Bash scripts under scripts to use env bash shebang and strict mode set -euo pipefail and add a make shellcheck target with a minimal configuration plus a CI step to run it, because several scripts currently lack pipefail or only set -u which weakens detection of failures; smallest change is editing script headers, adding one Makefile target, and a short workflow step; scope scripts, Makefile, CI; low risk; DoD includes an initial failing run then passing with zero shellcheck warnings, tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by running shellcheck locally and observing CI green, rollback by reverting the script, Makefile, and workflow edits.
* [ ] CI smoke job for tools — workflow builds tools, runs each binary with sample stdin, and runs an agent loop against a fake API; no external network dependence; DoD: green in PRs, artifacts attached, linked to issue.
* [ ] Add GitHub CodeQL code scanning for Go by committing .github/workflows/codeql.yml using the official CodeQL action with default queries on push and pull_request so security analysis runs automatically; evidence: no CodeQL workflow exists today; scope .github/workflows only; low risk and independent; DoD: CodeQL job runs green with zero new alerts, tests unchanged and green with no coverage regression, all quality gates green (vet, gofmt, golangci-lint, staticcheck, security and secret detection) with no new findings, peer review completed; verify by viewing the Security > Code scanning alerts page and the workflow run logs; rollback by deleting the workflow file.
* [ ] Document the release process in docs/releasing.md including tagging artifact naming checksums and verification and rollback guidance aligned with the planned release workflow, smallest change is a single page and links from README and the future release workflow, scope documentation, low risk, DoD includes dry run steps validated locally without publishing tests unchanged and green all quality gates green peer review completed verification by executing the documented commands in dry run rollback by removing the doc and links, traceability https://github.com/hyperifyio/goagent/issues/214.
* [ ] Add release workflow for static binaries and checksums: `.github/workflows/release.yml` triggered on tags like `v*`; build `agentcli` for `linux,darwin,windows` × `amd64,arm64` with `CGO_ENABLED=0`; name outputs `agentcli_<os>_<arch>` (Windows `.exe`); generate `SHA256SUMS` and `SHA256SUMS.sig` (optional GPG); create GitHub Release and upload artifacts and checksums; document in README how to download and verify.
* [ ] Add a make sbom target that uses syft (or cyclonedx-gomod as a fallback if syft is unavailable) to produce a CycloneDX SBOM at reports/sbom.json from the current module and wire it into the release workflow to upload as an asset, because the repo currently lacks an SBOM which weakens supply-chain visibility; smallest change is adding one Makefile target and a short CI step with a docs sentence; scope Makefile and CI; low risk; DoD includes failing first when the tool is missing then passing with deterministic output on a clean clone, tests unchanged and green with no coverage regression, all quality gates green (vet, format, golangci-lint, static analysis, security and secret scans) with no new findings, backward compatibility preserved, peer review completed, verification by running make sbom locally and seeing reports/sbom.json and by confirming the asset on a tagged release, rollback by reverting the Makefile and workflow edits.
* [ ] Tag and publish `v0.1.0` once CI is green and docs/tests are complete: ensure `README.md` has usage, examples, and limitations (no streaming, sequential tool calls only); ADR-0001 and sequence diagram present; unit and integration tests passing; create annotated tag `git tag -a v0.1.0 -m "MVP non-interactive agent CLI with OpenAI-compatible tools"` and `git push --tags`.
* [ ] Add GitHub Dependabot at .github/dependabot.yml to update Go modules weekly and GitHub Actions monthly so dependencies and CI actions stay current with minimal noise; smallest change is committing a single dependabot.yml file; scope repository hygiene; low risk and independent; DoD includes Dependabot PRs opening on schedule with passing CI and no coverage regression, all quality gates green (vet, format, lint, security and secret detection) with no new findings, peer review completed; verification by observing the first PRs or running a local preview, rollback by removing the configuration file.
* [ ] Add CODEOWNERS at .github/CODEOWNERS to automatically request reviews from maintainers; smallest change is committing one CODEOWNERS file mapping paths to the maintainers team; scope repository hygiene; low risk; DoD includes PRs auto-requesting reviews from owners, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by opening a test pull request and observing requested reviewers; rollback by removing the CODEOWNERS file.
* [ ] Add SECURITY.md under .github with a concise vulnerability disclosure policy including contact, supported versions, and response expectations, and link it from README; smallest change is a single Markdown file and one README sentence; scope security documentation; low risk; DoD includes the GitHub Security tab surfacing the policy, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by visiting the repository Security page, rollback by removing the file and README link.
* [ ] Add pull request template at .github/PULL_REQUEST_TEMPLATE.md prompting for canonical issue URL, intent, Definition of Done checklist, and test plan; smallest change is committing one template file; scope contribution workflow; low risk; DoD includes new pull requests prefilled with the template, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by opening a draft pull request and seeing the template, rollback by removing the template file.
* [ ] Add issue templates at .github/ISSUE_TEMPLATE/bug_report.yml and .github/ISSUE_TEMPLATE/feature_request.yml plus config.yml to disable blank issues; smallest change is committing two minimal YAML templates and one config; scope issue hygiene; low risk; DoD includes the New issue page showing the templates with required fields, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by clicking New issue and observing the choices, rollback by removing the templates.
* [ ] OBSOLETE: Add GitHub CodeQL code scanning for Go by committing .github/workflows/codeql.yml using the official CodeQL action with default queries on push and pull_request so security analysis runs automatically; evidence: no CodeQL workflow exists today; scope .github/workflows only; low risk and independent; DoD: CodeQL job runs green with zero new alerts, tests unchanged and green with no coverage regression, all quality gates green (vet, gofmt, golangci-lint, staticcheck, security and secret detection) with no new findings, peer review completed; verify by viewing the Security > Code scanning alerts page and the workflow run logs; rollback by deleting the workflow file.
* [ ] Add jq to README Installation prerequisites with OS-specific install snippets (apt, brew, choco) because README examples and runbooks pipe tool output to jq but prerequisites omit it; smallest change is editing README only; scope documentation; low risk and independent; DoD: README renders correctly on GitHub, examples run from a clean clone with jq installed, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by executing one README example end-to-end with jq and observing the pretty-printed JSON; rollback by reverting the README edit.
* [ ] Upload coverage profile and summary in CI by attaching bin/coverage.out as an artifact and printing total coverage using go tool cover func; smallest change is adding two steps in .github/workflows/ci.yml after the test step; scope CI; low risk; depends on the Makefile test target producing a coverage profile as already planned; DoD includes CI artifacts containing coverage.out and logs showing total coverage percentage, tests otherwise unchanged and green with no coverage regression, all quality gates green, peer review completed; verify by inspecting CI artifacts and logs, rollback by removing the new steps.
Blocked: SSH handshake fails with "Permission denied (publickey)"; next step is to configure GitHub authentication (add SSH key or run gh auth login with write access), then push this branch and open a PR to trigger CI and capture the run URL for verification.
Next: authenticate the GitHub CLI for github.com using device flow with SSH protocol and admin:public_key scope, add the existing SSH public key to the account, verify ssh -T git@github.com succeeds, then push the branch and open a PR to trigger CI.
* [ ] Document and operationalize the specific failure mode you hit: “golangci-lint: unsupported export data (internal/goarch version: 2)”. Smallest change: add a subsection to `docs/runbooks/troubleshooting.md` and `docs/operations/ci-quality-gates.md` titled exactly that with symptoms, cause (Go/golangci-lint mismatch), and the resolution steps: run `make check-go-version`, ensure ADR-0003 policy, run `make install-golangci`, rerun `make lint`. DoD: docs render on GitHub, steps verified, CI green, peer review completed.
* [ ] (Contingency, removable later) Add a temporary CI lint job that runs with Go 1.23.x if the pinned linter still fails on 1.24.x; tests and build jobs stay on `go-version-file: go.mod`. Smallest change: duplicate the `lint` job as `lint-compat`, set `actions/setup-go@v5` `go-version: "1.23.x"`, run `make lint`, mark with a TODO comment referencing the issue to remove once ADR-0003 policy is fully green with 1.24.x. DoD: CI green with both lint jobs; issue description captures the intent to delete this path; peer review completed; rollback by deleting the `lint-compat` job.
* [ ] Add a one-shot verifier in CI that prints versions for traceability. Smallest change: in the `lint` job, after setup and install, run `go version && $(GOBIN)/golangci-lint version` and emit them as step outputs (name the step “toolchain-versions”); no functional changes. DoD: CI logs show versions on all OSes; no gate regressions; peer review completed.
* [x] Add Windows/macOS/Linux path tests for `save.dir` correctness and SHA-256 reporting (use `tools/testutil/MakeRepoRelTempDir`), and verify image bytes are identical to decoded b64; DoD: platform-agnostic tests green across CI matrix.
  - [x] [S11:adr-0006-file] Create `docs/adr/0006-image-generation-tool-img_create.md` documenting `img_create` (Context/Decision/Consequences) with explicit links to `tools/cmd/img_create/img_create.go`, `docs/reference/img_create.md`, `internal/tools/manifest.go`, `internal/tools/runner.go`, and `docs/diagrams/toolbelt-seq.md`; include security/envPassthrough and transcript‑hygiene rationale; DoD: file renders on GitHub and all relative links resolve.
  - [x] [S12:docs-index-adr-0006] Add ADR‑0006 entry to `docs/README.md` under ADRs with link `adr/0006-image-generation-tool-img_create.md`; DoD: link clickable and resolves in GitHub UI.
  - [ ] [S18:verify-docs-ci-0006] Run `go test ./...` and `make lint`; verify ADR‑0006 links render and resolve via GitHub preview; DoD: tests/lint green and all links verified.
* [ ] Add Windows ripgrep install snippet to README Developer prerequisites (Chocolatey: choco install ripgrep -y) because README currently lists apt/brew only and local Windows developers hit ensure-rg unsupported OS; smallest change is adding a Windows bullet; scope documentation only; low risk and independent; DoD includes README rendering with the new Windows example, local Windows setup succeeds (rg --version prints) and make lint/test remain green with no coverage regression, all quality gates green; verify by following the snippet on a Windows dev machine; rollback by reverting the README edit.
* [ ] Deduplicate the duplicated CodeQL checklist entry in FUTURE_CHECKLIST.md by deleting one of the two identical lines so only a single CodeQL task remains; smallest change is to remove one duplicate line; scope documentation hygiene limited to FUTURE_CHECKLIST.md; low risk and independent; DoD includes the file showing only one unchecked CodeQL task, tests and lint unchanged and green with no coverage regression, all quality gates green, verification by searching the file and observing exactly one CodeQL line, rollback by reverting the edit
* [ ] Add a Windows make installation snippet to the README developer prerequisites using Chocolatey choco install make -y because README uses make commands but Windows setup omits this requirement; smallest change is adding one Windows bullet near the ripgrep and golangci-lint instructions; scope documentation only; low risk; DoD includes README rendering correctly and a successful make --version and make lint test build on a Windows environment with all quality gates green and no coverage regression, verification by running make --version and executing a sample make target on windows-latest, rollback by reverting the README edit
* [ ] Ignore generated image outputs by adding assets/ to .gitignore so img_create examples do not accidentally commit large binaries; smallest change is appending a single ignore entry under a clear comment; scope .gitignore only; low risk and independent; DoD includes saving an output under assets then seeing git status clean, tests and lint unchanged and green with no coverage regression, all quality gates green, verification by creating an image under assets and observing no tracked changes, rollback by removing the ignore entry
* [ ] Remove the tracked stray root-level rss_fetch binary and prevent reintroduction by adding rss_fetch and rss_fetch.exe to .gitignore; evidence: git ls-files --error-unmatch rss_fetch succeeds and file rss_fetch identifies an ELF built outside tools/bin; scope .gitignore and repository hygiene only; low risk and independent; DoD: git rm rss_fetch so the path is untracked, append two ignore lines, make build-tools produces only tools/bin/rss_fetch, git status stays clean after builds across OSes, tests and lint unchanged and green with no coverage regression, all quality gates green; verification: rerun git ls-files --error-unmatch rss_fetch (should fail) and confirm tools/bin/rss_fetch exists while the root-level binary is ignored; rollback: revert the .gitignore edit and restore the file if needed

# Starlark tool — `code.sandbox.starlark.run`  (pure Go, deterministic, hermetic)

(Starlark is designed for hermetic, deterministic execution; `go.starlark.net/starlark` executes from a string with no FS/net/clock unless you expose it.

* [ ] Implement tool contract and handler for `code.sandbox.starlark.run` that executes source from memory: create `internal/tools/starlarkrun/handler.go` exposing `Name() string { return "code.sandbox.starlark.run" }` and `Call(ctx, json.RawMessage) (ToolResult, error)` which accepts `{source:string,input:string,limits:{wall_ms:int,output_kb:int},caps:{}}`; parse JSON, run Starlark with `ExecFile` using a `Thread` and `predeclared` functions `read_input()->str` and `emit(str)`; enforce wall-time via `context.WithTimeout` and cap emitted bytes with a bounded buffer; return `{stdout:string}`; DoD: unit test passes showing a script `emit(read_input())` returns input, times out on `while True: pass`, and output > limit is truncated with a clear error.
* [ ] Add dependency and wiring: append `require go.starlark.net vX` to `go.mod`, create `internal/tools/starlarkrun/module.go` registering the tool into the tool registry (constructor + dependency-free init), and update `README.md` “Tools” table with usage and example input/output; DoD: `go build ./...` succeeds locally, registry lists the tool, README shows a runnable curl example.
* [ ] Harden capabilities (deny-by-default): ensure only `emit` and `read_input` are available (no FS, net, clock); do not bind any `os`, `time`, or custom builtins; add negative tests that attempt to import or access such capabilities and expect failure; DoD: tests demonstrate no ambient side effects are reachable and only declared builtins exist.
* [ ] Determinism test: add a table test running the same `source+input` 100× and asserting identical output and errors; DoD: flaky rate 0/100 locally; test name includes “deterministic”; comment cites Starlark determinism; tests green locally; DoD documented in test.
* [ ] Structured errors & shared schema: return standardized errors `{code:string,message:string,details?:object}` for timeouts (`TIMEOUT`), output limit exceeded (`OUTPUT_LIMIT`), and evaluation failures (`EVAL_ERROR`); update shared error schema doc and example in README; DoD: unit tests assert JSON shape for each failure mode and README section is present.
* [ ] Observability: add structured logs (trace id, tool name, wall\_ms, bytes\_out) and emit OpenTelemetry span attributes; DoD: local run shows JSON logs with those fields and a span named `tools.starlark.run`.
* [ ] Contract examples: add `docs/interfaces/code.sandbox.starlark.run.md` with request/response examples (valid, timeout, error), security notes, and performance caveats; DoD: doc renders and is linked from main docs.

## Review 2025-08-19
* [ ] Align img_create manifest schema with implementation and docs by adding an extras object parameter to tools.json under the img_create tool (matches the Extras field in tools/cmd/img_create/img_create.go and the docs reference) so models can declare and use it; smallest change is to add properties.extras with type object under the existing schema without touching other fields; scope tools.json only; low risk and independent; Definition of Done: jq shows extras present and type object for img_create, make verify-manifest-paths OK, go build and make lint test green with no coverage regression, all quality gates green with no new findings, peer review completed; verification by running a local agent call that passes extras and succeeds; rollback by reverting the tools.json edit.
* [ ] Harmonize image HTTP timeout environment variables for the img_create tool by supporting OAI_IMAGE_HTTP_TIMEOUT (duration) and HTTP_TIMEOUT_MS (milliseconds) in addition to the current OAI_HTTP_TIMEOUT with precedence OAI_IMAGE_HTTP_TIMEOUT over OAI_HTTP_TIMEOUT over HTTP_TIMEOUT_MS; smallest change is updating the httpTimeout function in tools/cmd/img_create/img_create.go to read the new envs, adding both variables to tools.json envPassthrough for img_create, and updating docs/reference/img_create.md to describe the precedence; scope tool code, tools.json, and docs; low risk and independent; Definition of Done: table tests cover precedence and parsing, go build and make lint test green with no coverage regression, all quality gates green with no new findings, peer review completed; verification by setting each env in isolation and observing effective timeout in a short mock call; rollback by reverting code, manifest, and docs edits.
* [ ] Pass through SEARXNG_ALLOW_LOCAL for searxng_search so local-only fixtures are allowed during development without relaxing the default SSRF guard; smallest change is to add SEARXNG_ALLOW_LOCAL to envPassthrough for searxng_search in tools.json and add a short note to docs/reference/searxng_search.md describing the opt-in; scope tools.json and docs; low risk and independent; Definition of Done includes verify-manifest-paths OK, go build and make lint test green with no coverage regression, all quality gates green with no new findings, peer review completed; verification by running the tool once with and once without SEARXNG_ALLOW_LOCAL=1 against 127.0.0.1 and observing allowed versus blocked; rollback by reverting the tools.json and docs edits.
* [ ] Pass through HTTP_FETCH_ALLOW_LOCAL for http_fetch to enable hermetic local fixtures when explicitly opted in; smallest change is to add HTTP_FETCH_ALLOW_LOCAL to envPassthrough in tools.json for http_fetch and update the manifest snippet in docs/reference/http_fetch.md to include it; scope tools.json and docs; low risk and independent; Definition of Done includes verify-manifest-paths OK, go build and make lint test green with no coverage regression, all quality gates green with no new findings, peer review completed; verification by calling http_fetch to 127.0.0.1 with and without HTTP_FETCH_ALLOW_LOCAL=1 and observing default block versus allowed; rollback by reverting the tools.json and docs edits.
* [ ] Standardize fs_move stderr to structured JSON errors only by replacing non-JSON close src and close dst prints in defers with JSON-formatted errors or omitting them when non-fatal to match other tools’ behavior; smallest change is editing tools/cmd/fs_move/fs_move.go only and updating tests if they assert on those lines; scope single tool; low risk and independent; Definition of Done includes go test for the tool and the repository passing, make lint green with no new findings, all quality gates green with no new findings, peer review completed; verification by provoking a close error and observing a single-line JSON error on stderr; rollback by reverting the edit.

## Security sandbox feature

* [ ] Preflight: implement a kernel and environment probe that confirms Linux ≥ 5.4, unprivileged user namespaces enabled, seccomp available, and whether CLONE\_NEWNET is permitted for unprivileged users; if any prerequisite is missing, print a precise remediation hint and refuse to run unless `--sandbox=permissive` is set, and record findings in an audit-ready struct; DoD: running `agentcli --sandbox-check` prints a single-line status with kernel version, userns=yes/no, seccomp=yes/no, newnet=yes/no, and exits nonzero only when mandatory features are absent without permissive override.
* [ ] Policy schema: define a deny-by-default sandbox policy (JSON/YAML + env/flag overrides) with fields `filesystem.bundle.binaries[]` (absolute host paths), `filesystem.inputs[]` (host→guest RO), `filesystem.outputs[]` (guest paths under /out), `env.allow[]` (names or key=value), `resources` (timeout, max\_output\_bytes, rlimits for NOFILE/NPROC/AS), and `network.mode` with values `off`, `allow_all`, or `proxy_allowlist` plus `network.allow[]` hostnames/IP\:ports; include `audit.redact[]` for secrets; DoD: policy loader merges defaults, file, and flags deterministically and `--sandbox-dry-run --explain` prints the effective policy in one block.
* [ ] Bundle assembly directory: create a secure per-run temp dir `<runtime>/agentcli-bundles/<run-id>` with `0700`, subdirs `bin`, `etc`, `in`, `out`, `tmp`, and copy exactly the allowlisted Go executables plus a copy of the current `agentcli` into `bin`; reject non-regular files and symlinks, verify ELF arch matches the running OS, and cap total bundle size; DoD: after assembly, `bin` contains only declared executables (including `agentcli`), `in/out/tmp/etc` exist, bundle size ≤ cap, and a manifest file lists each file with size and SHA-256.
* [ ] Dynamic dependency handling guard: detect dynamically linked binaries (cgo) by inspecting ELF headers and `INTERP`; if any are found and `policy.filesystem.allow_dynamic=false`, fail with a message suggesting a static build or enabling dynamic deps; if allowed, copy the interpreter and needed `.so` files into `etc/lib` and rewrite `ld.so.conf` minimally inside the bundle; DoD: dynamic binaries either run with their copied deps under the bundle or the run fails early with a clear diagnostic.
* [ ] Bundle manifest and cache: compute a content-addressed manifest hash over the policy hash and bundle file hashes, store the bundle under an LRU cache keyed by this hash, and when identical inputs are requested, materialize the bundle via hardlinks or reflinks if available; DoD: repeated runs with the same policy+binaries reuse the cached bundle and log a cache hit with the manifest hash.
* [ ] Sandbox process creation: spawn a child with new USER, MOUNT, PID, UTS, and IPC namespaces (and NEWNET only when `network.mode=off`), map uid/gid 0 inside to caller uid/gid outside, set `GidMappingsEnableSetgroups=false`, set `no_new_privs=1`, and ensure the child becomes PID 1 in its PID namespace; DoD: child sees itself as uid 0/PID 1, parent remains unaffected, and a test program confirms user mapping without requiring root.
* [ ] Mount plan (Linux 5.4-compatible): set mount propagation to private, bind-mount the bundle root read-only at `/bundle` with `nosuid,nodev,noatime`, bind-mount a minimal read-only `/dev` tree (`null`, `zero`, `urandom`), mount `proc` at `/proc`, create tmpfs at `/work` and `/tmp` with size caps, bind-mount declared inputs read-only to their guest paths, create `/out` as a directory on `/work` or bind a host output dir if requested, and mark all mounts `noexec` except `/bundle/bin`; DoD: inside the sandbox `mountinfo` shows the expected tree with `/bundle` ro and only `/bundle/bin` executable, `/proc` present, `/dev` minimal, and host paths outside declared inputs not visible.
* [ ] Root transition: chroot to `/` using the assembled mount tree with `/bundle` available at `/bundle`, set working dir to `/work`, and drop any residual mount permissions by remounting sensitive paths ro; DoD: `getcwd` returns `/work`, path traversal cannot escape the chroot, and attempts to write to `/bundle` fail with EROFS.
* [ ] Environment initialization: start from an empty environment, set `PATH=/bundle/bin` and `HOME=/work`, inject only allowlisted variables (support `NAME` passthrough and explicit `NAME=value` literals), and redact any keys listed under `audit.redact` when logging; DoD: a probe inside prints only the allowed keys, and execution of undeclared system binaries fails due to PATH isolation.
* [ ] Seccomp hardening: install a strict seccomp-bpf profile after mounts and before exec that allows basic file I/O, signals, time, and standard syscalls, denies `ptrace`, `keyctl`, `bpf`, module/sysctl, `reboot`, raw sockets, and new mounts; when `network.mode=off`, also deny all socket syscalls; when `network.mode=allow_all` or `proxy_allowlist`, allow stream sockets but continue to deny raw and packet sockets; DoD: adversarial test binaries attempting blocked syscalls receive EPERM and are logged in the audit trail.
* [ ] Rlimits baseline (no cgroups required): set RLIMIT\_NOFILE, RLIMIT\_NPROC, RLIMIT\_CORE=0, and an address-space or RSS cap to simulate memory limits; enforce a wall-clock timeout in the supervisor; DoD: fork-bomb test hits RLIMIT\_NPROC and is terminated, huge allocation triggers failure, and runs exceeding the timeout are cleanly killed with a clear timeout status.
* [ ] Network mode “off”: if selected, create a new net namespace, leave loopback down, and do not attach any interfaces so all outbound connects fail immediately; DoD: inside sandbox, `connect` to external addresses fails, while the tool continues to run without network access.
* [ ] Network mode “allow\_all”: if selected, do not create a new net namespace (or create one only if it would still have host connectivity, which is generally not possible rootless, so default to host netns), and keep seccomp blocking raw sockets; DoD: the tool can reach the network as it normally would, but attempts to create raw/packet sockets fail.
* [ ] Network mode “proxy\_allowlist” (best-effort user-space proxy): implement an in-process HTTP/HTTPS CONNECT and SOCKS5 proxy that listens on `127.0.0.1:<random>` and enforces an allowlist of hostnames/IP\:ports, start it only for this run, set `HTTP_PROXY`, `HTTPS_PROXY`, and `NO_PROXY` inside the sandbox to point at it, and log and deny connections to non-allowlisted destinations; document that programs ignoring proxy env vars will bypass this and recommend “off” mode for strict isolation; DoD: tools honoring proxy variables can only reach allowlisted destinations and denied attempts are logged with destination details; tools ignoring the proxy still run but are not counted as compliant in tests, and the mode is labeled best-effort.
* [ ] PID1 supervisor and signal/exit handling: run a tiny supervisor as PID 1 that execs the tool, forwards SIGTERM/SIGINT, reaps zombies, enforces the timeout, and on exit collects status and reasons (normal, timeout, rlimit), then performs teardown; DoD: killing the parent or sending SIGINT cleanly terminates the tool and all children, leaving no stray processes.
* [ ] Output collection and size enforcement: require all produced artifacts to be written under `/out`, enforce per-file and total size caps, compute SHA-256 for each file, and copy artifacts to a designated host directory atomically; DoD: runs producing files under `/out` are collected with hashes recorded, attempts to write outside `/out` are ignored and reported, and oversize outputs cause a clear failure with partial files discarded.
* [ ] Audit record: emit a single JSON line per run containing tool name, policy revision and hash, bundle manifest hash, kernel features detected, namespace flags, seccomp profile id, rlimits, start/stop timestamps, exit code, timeout/OOM flags, network mode and any contacted destinations (from the proxy when used), output file list with sizes and hashes, and redacted env keys as configured; DoD: audit records are produced for success and failure paths and pass JSON schema validation.
* [ ] CLI and DX: add `--sandbox` master switch (on/off/permissive), `--sandbox-policy=<file-or-json>`, `--sandbox-network=<off|allow_all|proxy_allowlist>`, `--sandbox-dry-run --explain`, and `--sandbox-check`; ensure helpful error messages and a deterministic “plan preview” that prints mounts, env, PATH contents, and network mode without executing the tool; DoD: flags are documented, parsed in any order, and `--sandbox-dry-run --explain` outputs a human-readable plan matching the effective policy.
* [ ] Teardown and hygiene: on normal exit or timeout, unmount in reverse order, close all inherited file descriptors except stdio, remove the per-run temp directory, and, unless `--sandbox-keep-bundle` is set, keep only cached bundles referenced by the LRU; DoD: after runs, no mounts or temp dirs remain, `ls -l /proc/<ppid>/fd` shows no leaked FDs, and cache size stays under the configured ceiling.
* [ ] Security regression tests: create adversarial fixtures that try file escape via symlinks, writing to `/bundle`, executing binaries from `/work`, opening raw sockets, using `ptrace`, and forking excessively; run them in each network mode and assert denials and logs match expectations; DoD: CI-like local test suite passes on Linux 5.4+ with userns enabled and no root privileges.
* [ ] Determinism and caching tests: verify that identical inputs produce the same manifest hash, the same audit fields except timestamps, and a cache hit on the second run; DoD: two consecutive runs log identical manifest hashes and report “cache: hit” on the second.
* [ ] Documentation: write a single developer-facing document describing Linux 5.4 compatibility constraints (no Landlock, no overlayfs-in-userns reliance), the three network modes with strictness caveats, how the bundle works (including inclusion of `agentcli`), how to author policies, and known limitations of rootless operation (optional cgroups only if delegated); DoD: the doc lives in the repo, is linked from `--help`, and contains copy-pastable policy examples and troubleshooting for common kernel settings.


* [ ] Bootstrap and preflight (once): ensure a clean workspace and gh auth; run: `git fetch --all --prune && git switch main || git checkout -b main && git pull --ff-only || true && git switch develop && git pull --ff-only && gh auth status`; set repo vars: `REPO=$(git remote get-url --push origin | sed -E 's#.*/([^/]+/[^/]+)(\.git)?$#\1#')`; verify tools: `make -n >/dev/null 2>&1 || true`; Definition of Done: main exists locally and remotely (or created), develop is up to date, gh is authenticated for $REPO.
* [ ] Create a machine-readable PR plan (once): generate docs/PR_PLAN.md enumerating PR order and branch names; sections in this exact order to minimize conflicts: (1) Repo scaffolding & hygiene, (2) Core CLI & client, (3) Tool manifest & runner, (4) Tool-call loop & validator, (5) Baseline docs/ADR/diagrams, (6) Each tool (one PR per tool), (7) Tests per component, (8) Makefile, scripts, and CI gates, (9) Security & runbooks, (10) Research tools (one PR per tool), (11) Remaining docs and examples; commit this plan on a short-lived planning branch: `git switch -c pr/plan && mkdir -p docs && printf "...ordered list with branch names..." > docs/PR_PLAN.md && git add docs/PR_PLAN.md && git commit -m "PR plan: ordered slicing from develop to main" && git push -u origin pr/plan && gh pr create --base main --head pr/plan --title "PR plan: ordered slicing" --body "Adds docs/PR_PLAN.md to drive small PR slicing" --draft`; Definition of Done: a draft PR to main exists containing docs/PR_PLAN.md with the full ordered plan.
* [ ] Slice PR #01 — repo scaffolding (only repo-level files, no code): start from main; `git switch -c pr/01-scaffold main`; restore the minimal set from develop using path-scoped restore: `git restore --source develop --staged --worktree LICENSE README.md .gitignore .gitattributes .editorconfig Makefile go.mod docs/README.md`; ensure Makefile builds without code: `make fmt || true`; commit and push: `git commit -m "Scaffold: LICENSE/README/.gitignore/.gitattributes/.editorconfig/Makefile/go.mod (+ docs index)" && git push -u origin pr/01-scaffold && gh pr create --base main --head pr/01-scaffold --title "Scaffold repository (no code)" --body "Adds legal, docs, Makefile, go.mod; no binaries or code."`; Definition of Done: PR shows only the listed files, CI (if any) passes or is out-of-scope, reviewers can merge without code review complexity.
* [ ] Slice PR #02 — minimal CLI entrypoint (compile-only, no HTTP/tools): `git switch -c pr/02-cli-main main && git restore --source develop --staged --worktree cmd/agentcli/main.go && git restore --source develop --staged --worktree cmd/agentcli/go.* || true && go build ./cmd/agentcli`; update README usage snippet minimally if referenced by main.go; commit/push/create PR; Definition of Done: `go build ./cmd/agentcli` succeeds on a clean checkout of the branch; PR contains only cmd/agentcli/* (and any edited README lines).
* [ ] Slice PR #03 — flags & help (no network): `git switch -c pr/03-flags-help main && git restore --source develop --staged --worktree cmd/agentcli/flags.go cmd/agentcli/usage_test.go docs/reference/cli-reference.md`; run `go test ./cmd/agentcli -run Help -v` (or the repo’s equivalent); commit/push/PR; Definition of Done: `agentcli --help` works locally (prints full usage), tests covering help/flags pass, only flags/help related files changed.
* [ ] Slice PR #04 — OpenAI-compatible HTTP client (types + client, no integration): `git switch -c pr/04-oai-client main && git restore --source develop --staged --worktree internal/oai/types.go internal/oai/client.go internal/oai/*_test.go`; `go test ./internal/oai -run Client -v`; commit/push/PR; Definition of Done: internal/oai unit tests pass and PR contains only internal/oai files (and go.mod/go.sum updates if needed).
* [ ] Slice PR #05 — model defaults & capability map (serialization only): `git switch -c pr/05-model-defaults main && git restore --source develop --staged --worktree internal/oai/capabilities.go internal/oai/capabilities_test.go docs/adr/0004-default-llm-policy.md`; `go test ./internal/oai -run Capabilities`; commit/push/PR; Definition of Done: capability tests green; ADR added; no unrelated changes.
* [ ] Slice PR #06 — tools manifest loader: `git switch -c pr/06-tools-manifest main && git restore --source develop --staged --worktree internal/tools/manifest.go internal/tools/manifest_test.go docs/reference/tools-manifest.md`; `go test ./internal/tools -run Manifest`; commit/push/PR; Definition of Done: manifest tests pass, docs reference added/linked, only manifest-related changes included.
* [ ] Slice PR #07 — secure tool runner (no sandbox yet, argv only): `git switch -c pr/07-tool-runner main && git restore --source develop --staged --worktree internal/tools/runner.go internal/tools/runner_test.go`; `go test ./internal/tools -run Runner`; commit/push/PR; Definition of Done: runner tests pass, env scrub + timeout behavior present, no changes outside internal/tools (except sums).
* [ ] Slice PR #08 — assistant tool-call loop and validator wiring: `git switch -c pr/08-tool-loop main && git restore --source develop --staged --worktree cmd/agentcli/tool_loop.go internal/oai/validator.go internal/oai/validator_test.go cmd/agentcli/tool_loop_test.go`; run tests; commit/push/PR; Definition of Done: message-sequence validator blocks stray tool messages, loop test green, only loop/validator files affected.
* [ ] Slice PR #09 — baseline docs & diagrams: `git switch -c pr/09-docs-diagrams main && git restore --source develop --staged --worktree docs/adr/0001-minimal-agent-cli.md docs/diagrams/agentcli-seq.md docs/diagrams/toolbelt-seq.md docs/security/threat-model.md docs/runbooks/troubleshooting.md README.md docs/README.md`; commit/push/PR; Definition of Done: docs render on GitHub (links valid), no code files in PR.
* [ ] Slice PR #10 — example tool get_time + tools.json + Makefile build-tools: `git switch -c pr/10-get-time main && git restore --source develop --staged --worktree tools/cmd/get_time/** tools/bin/.gitkeep tools/testutil/** tools.json Makefile README.md`; `make build-tools && ./tools/bin/get_time <<< '{"tz":"Europe/Helsinki"}'`; commit/push/PR; Definition of Done: get_time builds and runs, tools.json declares it with schema, Makefile emits tools/bin/get_time(.exe), only these paths changed.
* [ ] Slice PR #11 — quickstart README runnable: `git switch -c pr/11-quickstart main && git restore --source develop --staged --worktree README.md`; validate the quickstart end-to-end against current feature set; commit/push/PR; Definition of Done: quickstart commands copy-paste cleanly on a fresh clone for current branch scope.
* [ ] Slice PR #12 — minimal unit tests enabling (core only): `git switch -c pr/12-core-tests main && git restore --source develop --staged --worktree internal/oai/*_test.go internal/tools/*_test.go cmd/agentcli/*_test.go`; `go test ./...`; commit/push/PR; Definition of Done: tests that rely only on already-merged features pass; tests requiring future tools remain excluded.
* [ ] Slice each tool as its own PR (repeat this item once per tool, substituting NAME and the exact file set): `git switch -c pr/tool-NAME main && git restore --source develop --staged --worktree tools/cmd/NAME/** && git restore --source develop --staged --worktree docs/reference/NAME.md || true && jq '.tools[]|select(.name=="NAME")' tools.json >/dev/null 2>&1 || git restore --source develop --staged --worktree tools.json && make build-tools NAME=NAME && go test ./tools/cmd/NAME -run . && git commit -m "tool(NAME): add tool implementation, schema, tests, docs" && git push -u origin pr/tool-NAME && gh pr create --base main --head pr/tool-NAME --title "Tool: NAME" --body "Adds tools/cmd/NAME (+ tests), wires tools/bin/NAME in Makefile, updates tools.json, and adds docs/reference/NAME.md; contract: stdin/out + stderr JSON on error; includes examples and runbook notes."`; Definition of Done: branch builds `tools/bin/NAME(.exe)`, the tool’s focused tests pass, tools.json entry valid, docs page present; PR contains only NAME and the touched manifest/Makefile/docs; examples: get_time (already done), exec, fs_read_file, fs_write_file, fs_append_file, fs_rm, fs_move, fs_search, fs_mkdirp, fs_apply_patch, fs_read_lines, fs_edit_range, fs_listdir, fs_stat, img_create, http_fetch, searxng_search, robots_check, readability_extract, metadata_extract, pdf_extract, rss_fetch, wayback_lookup, wiki_query, openalex_search, crossref_search, github_search, dedupe_rank, citation_pack.
* [ ] Slice PR — tool error-contract standardization (one tool per PR for clarity): for each tool that needs the unified stderr JSON `{"error":"...","hint?":"..."}` behavior, branch from main, restore only that tool’s sources and tests from develop, run its negative-path tests, fix if needed, commit and PR titled `Tool NAME: standardize error contract`; Definition of Done: tool emits single-line stderr JSON on failure and exits non-zero, tests cover it, PR only touches that tool.
* [ ] Slice PR — Makefile wiring (TOOLS list, build-tools/clean, Windows .exe): `git switch -c pr/makefile-tools main && git restore --source develop --staged --worktree Makefile && make build-tools && make clean`; commit/push/PR; Definition of Done: `make build-tools` deterministically builds all already-merged tools to tools/bin, `make clean` removes them, no code beyond Makefile changed.
* [ ] Slice PR — scripts and gh utilities (no external deps beyond gh): `git switch -c pr/scripts main && git restore --source develop --staged --worktree scripts/**/* .github/** || true`; keep only scripts that don’t assume features not yet merged; `bash -n scripts/*.sh || true`; commit/push/PR; Definition of Done: scripts shellcheck clean (if configured) and runnable where applicable; PR limited to scripts/ and CI YAML.
* [ ] Slice PR — security & runbooks: `git switch -c pr/security-runbooks main && git restore --source develop --staged --worktree docs/security/** docs/runbooks/** README.md`; commit/push/PR; Definition of Done: security posture and troubleshooting render with valid links, no code in PR.
* [ ] Slice PR — ADRs (one ADR per PR unless trivial): for each ADR file under docs/adr not yet in main, `git switch -c pr/adr-XXXX main && git restore --source develop --staged --worktree docs/adr/XXXX-*.md docs/README.md README.md && git commit -m "ADR-XXXX: <title>" && git push && gh pr create ...`; Definition of Done: ADR renders, is linked from docs index and README, no code changes.
* [ ] Slice PR — diagrams (grouped if tightly related): `git switch -c pr/diagrams main && git restore --source develop --staged --worktree docs/diagrams/** README.md docs/README.md`; verify GitHub renders Mermaid; commit/push/PR; Definition of Done: diagrams render and links valid; no code files.
* [ ] Slice PR — CLI features: group the smallest cohesive increments (each as its own PR): (a) `--version`, (b) `--print-config`, (c) split http vs tool timeouts + retries/backoff, (d) length backoff + `max_tokens`, (e) message-sequence validator in pre-stage, (f) pre-stage enable/disable + flags; for each: new branch from main, restore only the minimal necessary files (cmd/agentcli/* + internal where needed + docs/tests), run `go test ./...`, commit/push/PR with focused title/body; Definition of Done: each PR compiles, has passing tests for the feature, and touches only the minimal feature scope.
* [ ] Slice PR — parallel tool calls (main loop) isolated: `git switch -c pr/parallel-tool-calls main && git restore --source develop --staged --worktree cmd/agentcli/*parallel* internal/*/validator* cmd/agentcli/*_test.go`; run the concurrency test; commit/push/PR; Definition of Done: tests proving concurrency semantics pass; PR limited to loop/validator/tests.
* [ ] Slice PR — audit logs and redaction (internal/tools runner + client): create two PRs: (1) HTTP timings/audit fields; (2) tool runner audit + redaction; for each: branch, restore minimal internal files + tests + docs/runbooks update, run tests, commit/push/PR; Definition of Done: NDJSON log lines present with expected fields, tests assert structure, docs mention redaction.
* [ ] Slice PR — research toolbelt (one PR per research tool): repeat the per-tool PR item for searxng_search, http_fetch, robots_check, readability_extract, metadata_extract, pdf_extract, rss_fetch, wayback_lookup, wiki_query, openalex_search, crossref_search, github_search, dedupe_rank, citation_pack, each including its doc page and tools.json entry, with SSRF guards and retries as already implemented in develop; Definition of Done: each PR builds its tool, tests green offline with httptest.Server fixtures, docs reference added; no coupling between tools across PRs.
* [ ] Slice PR — integration tests (minimal end-to-end): branch from main and add only the smallest deterministic integration test that exercises one already-merged tool (e.g., fs_write_file→fs_read_file) using a fake API; `git restore --source develop --staged --worktree cmd/agentcli/tools_integration_test.go tools/testutil/**`; run `go test ./cmd/agentcli -run AdvertisesSchemas`; commit/push/PR; Definition of Done: integration passes locally, PR contains only integration test files and helpers.
* [ ] Slice PR — README finalization and examples (grouped): branch, restore examples/ that match only merged tools, update README links; commit/push/PR; Definition of Done: examples run locally without network (or with documented mock), links valid.
* [ ] For every PR above, enforce the same PR hygiene (apply each time): before commit, run `go mod tidy && make fmt && make build && make build-tools && go test ./... && make lint || true` (keep gates as available on local machine); ensure commit message starts with a clear scope (`scaffold:`, `cli:`, `oai:`, `tool(NAME):`, `docs:`), and the PR body includes a short rationale, the contract (if a tool/API), and a verification section; create the PR with `gh pr create --base main --head <branch> --title "<scope>: <summary>" --body-file <auto-generated body> --draft` if any gate not yet green, otherwise without `--draft`; Definition of Done: PR shows only the intended diff (verify with `git diff --name-only origin/main...HEAD`), local tests for its scope are green, title/body meet reviewability standards.
* [ ] Merge discipline and sequencing (applies continuously): once a PR is approved and CI (if present) is green, merge with “squash and merge” to keep history clean; after merge, `git switch main && git pull --ff-only && git branch -D <feature-branch> || true`; before opening the next PR, re-create branches from updated main; Definition of Done: main advances one minimal feature at a time, no open PR depends on another unmerged PR (or if unavoidable, clearly state `--base <dependent-branch>` and retarget to main immediately after the base merges).
* [ ] Post-migration cleanup (final PR): when all features are merged, remove docs/PR_PLAN.md (or mark as historical), ensure tools/bin/* are gitignored only (no binaries tracked), run a last `make clean && make build build-tools && go test ./... && make lint`; commit any final doc link fixes; Definition of Done: main contains the full feature set, no legacy artifacts remain, and local gates pass end-to-end.

