* [ ] Pre-stage timeouts: inherit `-prep-http-timeout` from the existing `-http-timeout` (and `OAI_PREP_HTTP_TIMEOUT` env) instead of falling back to deprecated `-timeout`. Remove any mention of `-timeout` in pre-stage. DoD: unit tests show `-prep-http-timeout` > `OAI_PREP_HTTP_TIMEOUT` > `-http-timeout` > default; help/README updated.
* [ ] Pre-stage param knobs follow one-knob rule + capability map: add `-prep-top-p` and reuse the existing model capability map to omit `temperature` (or `top_p`) when unsupported; also reuse the 400 “parameter-recovery” retry once for the pre-stage. DoD: table tests cover presence/omission and the 400→retry flow; docs note parity with main call.
* [ ] Pre-stage uses the same message-sequence validator: run the existing validator that forbids stray `role:"tool"` and enforces `tool_call_id` matching during the pre-processing loop, too. DoD: failing test with a stray tool message in pre-stage; passing after wiring; troubleshooting doc mentions both stages.
* [ ] Parallel tool-calls in pre-stage: execute multiple `tool_calls[]` concurrently during pre-processing, just like the main loop. DoD: concurrency test with two pre-stage tool calls of different latency; transcript contains exactly one `tool` message per id.
* [ ] Restrict pre-stage tools to built-in read-only adapters (no external commands by default): expose only in-process tools `fs.read_file`, `fs.list_dir`, `fs.stat`, `env.get`, `os.info` under a separate pre-stage tool registry; ignore `-tools` for pre-stage unless explicitly overridden by `-prep-tools-allow-external`. DoD: attempting to write or exec in pre-stage deterministically returns an error; security doc updated.
* [ ] If `-prep-tools-allow-external` is enabled, reuse manifest rules: resolve the pre-stage manifest relative to its own file, require `./tools/bin/*` (Windows `.exe` honored), and enforce the existing escape/`..` rejection and cross-platform path normalization. DoD: unit tests mirror `internal/tools/manifest_*` for the pre-stage path.
* [ ] Audit + structured logs include `stage:"prep"` with HTTP timings and idempotency key: reuse your current NDJSON audit schema and emit the same timing fields and `Idempotency-Key` for the pre-stage call. DoD: test asserts one prep entry with `{stage:"prep", timings..., idempotency_key}` at repo root `.goagent/audit/`.
* [ ] Config dump shows pre-stage config: extend `-print-config` to include `prep` block (model, base URL, http timeout, retries/backoff, temperature/top\_p resolved and sources). Env precedence: `OAI_PREP_*` > main flag/env where applicable; API key fallback chain `OAI_PREP_API_KEY` → `OAI_API_KEY` → `OPENAI_API_KEY`. DoD: unit test snapshots config; README examples updated.
* [ ] Channel printing harmonized with current debug/quiet behavior: default print only `assistant{channel:"final"}` to stdout; `-verbose` prints `critic`/`confidence` to stderr without interleaving raw JSON; `-debug` continues to dump raw request/response JSON to stderr after any human-readable channel output; `-quiet` prints just the final text. DoD: formatter tests cover combinations and ordering; help/README table updated.
* [ ] Pre-stage cache key expanded to include knobs + tool spec: hash `(prompt/system/developer inputs, prep model/base, temp/top_p effective, retries/backoff, pre-stage tool set or external manifest content hash)`; honor `-prep-cache-bust`. DoD: tests for hit/miss/TTL; docs updated.
* [ ] ADR numbering + links: add ADR-0004 “Harmony pre-processing & channel-aware output” (to follow your ADR-0003), link from README and docs index; include sequence diagram that reflects parallel tool calls, validator, and audit stages. DoD: diagram renders on GitHub; links valid.
* [ ] Windows suffix + path normalization everywhere: ensure printing/examples show `./tools/bin/NAME.exe` where applicable and path normalization uses `filepath.ToSlash` before validation (already in repo—just reuse). DoD: docs and tests show at least one Windows example; cross-platform tests green.
* [ ] One-knob parity in docs and help: clarify that both stages obey “if `--top-p` is set, `temperature` is omitted” and defaults are 1.0 (main) and 1.0 (prep) unless the user selects a `--prep-profile deterministic` (sets temp 0.1 if supported). DoD: help text + docs reflect the rule; unit tests for profiles.
* [ ] Roles/precedence merge updated: when CLI provides `-developer`/`-developer-file`, those messages are prepended ahead of any pre-stage developer messages in the final array; system resolution is “CLI `-system` if present, else pre-stage system, else default string” (unchanged). DoD: merge tests for all permutations; README “Roles & precedence” examples updated.
* [ ] Pre-stage enable/disable switch and fail-open fallback. Add `-prep-enabled` (default true). On any pre-stage error (network, schema/validator, tool failure, invalid roles), log `WARN:` once to stderr, skip pre-stage, and proceed with original `{system,user}`. DoD: table tests for each failure → fallback; docs show behavior; `-print-config` reflects `prep.enabled`.
* [ ] Explicit pre-stage model/endpoint flags. Add `-prep-model`, `-prep-base-url`, `-prep-api-key`, `-prep-http-retries`, `-prep-http-retry-backoff`. Precedence: flag > `OAI_PREP_*` > main-call equivalents > defaults. DoD: unit tests for precedence; `-print-config` shows resolved prep block; README updated.
* [ ] Role input flags not yet in CLI. Implement `-developer` (repeatable), `-developer-file` (repeatable), plus `-prompt-file` and `-system-file` (each mutually exclusive with their string counterpart; `-` means STDIN). DoD: parser tests (mutual exclusion, repeats, STDIN), help text, examples; merge logic matches your “Roles/precedence” bullet.
* [ ] Pre-stage dry-run and message viewing. Add `-prep-dry-run` (run pre-stage only, print refined Harmony messages to stdout, exit 0) and `-print-messages` (pretty-print the final merged message array to stderr before the main call). DoD: snapshot tests; README examples.
* [ ] Streaming for assistant\[final]. If server supports streaming, stream only `assistant{channel:"final"}` to stdout; buffer other channels for `-verbose`. DoD: mock streaming test; docs “Streaming” section; `-quiet` still prints just the streamed final.
* [ ] Save/load refined messages. `-save-messages path` writes the final merged Harmony array to JSON; `-load-messages path` bypasses pre-stage and `-prompt` using that JSON verbatim (still validator-checked). DoD: round-trip tests; schema doc; conflict errors covered.
* [ ] Custom channel routing. `-channel-route name=stdout|stderr|omit` (repeatable) to override defaults (final→stdout, critic/confidence→stderr). Invalid channel/destination → exit 2 with message. DoD: routing matrix tests; help/README updated.
* [ ] Pre-stage tools manifest path. Add `-prep-tools path` to point to a (possibly different) manifest; honor all existing manifest validations (anchoring to manifest dir, `./tools/bin/*`, Windows `.exe`, `..` escapes). Works only with `-prep-tools-allow-external`. DoD: unit + integration tests with a nested manifest.
* [ ] Harmony normalizer. In pre-stage, normalize/validate roles (`system|developer|user|assistant|tool`) and assistant `channel` tokens (ASCII, short). Unknown roles → hard error (triggers fallback); unknown channels → pass through but not auto-printed unless routed. DoD: validator tests and clear errors.
* [ ] End-to-end acceptance test. One deterministic test that: (1) runs pre-stage using a mock server returning Harmony with two parallel tool calls (readonly), (2) validates channel routing and message merging, (3) runs the main call to completion. DoD: single test under `cmd/agentcli` green locally without network.
