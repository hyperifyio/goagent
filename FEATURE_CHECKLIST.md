* [x] Initialize repo with Go module and scaffolding: run `mkdir agentcli && cd agentcli && git init && go mod init github.com/<org>/agentcli`; add `LICENSE` (MIT), `README.md` (purpose, usage, examples), `.gitignore` (bin/, dist/, .DS_Store, go.work, .idea, .vscode); create directories `cmd/agentcli`, `internal/oai`, `internal/tools`, `docs/adr`, `docs/diagrams`; set default model id `oss-gpt-20b` and default OpenAI-compatible base URL `https://api.openai.com/v1` to be read from env or flags.
* [x] Implement `cmd/agentcli/main.go` non-interactive run loop: `package main` with `main()` reading flags, building initial messages `[system,user]`, calling the HTTP client, executing any returned tool calls, appending tool results as `role=tool` messages, repeating until the model returns a final assistant message with text, then printing to stdout and exiting 0; all failures print a concise error to stderr and exit non-zero (2 for CLI misuse like missing `-prompt`, 1 otherwise).
* [x] Implement full CLI flag set with defaults and env fallbacks: `-prompt (string, required)`, `-tools (path to tools.json, optional)`, `-system (string, default "You are a helpful, precise assistant. Use tools when strictly helpful.")`, `-base-url (string, default env OAI_BASE_URL or https://api.openai.com/v1)`, `-api-key (string, default env OAI_API_KEY)`, `-model (string, default env OAI_MODEL or oss-gpt-20b)`, `-max-steps (int, default 8)`, `-timeout (duration, default 30s, applies to HTTP and tool exec unless tool overrides)`, `-temp (float64, default 0.2)`, `-debug (bool, default false, dumps request/response JSON to stderr)`; precedence: flag > env > hard default; validate `-prompt` non-empty before running.
* [x] Implement OpenAI-compatible client (POST `/v1/chat/completions`): define request types `{model, messages[], tools[], tool_choice:"auto", temperature}` and response types `{choices[].message{role,content,tool_calls[]}, choices[].finish_reason}`; send `Authorization: Bearer <api-key>` if provided; `Content-Type: application/json`; use `http.Client{Timeout: <timeout>}`; treat any non-2xx as error with body included; support `finish_reason` but not required to stop if you already have final content; never stream in MVP.
* [x] Wire default config for oss-gpt-20b: honor `OAI_MODEL=oss-gpt-20b`, `OAI_BASE_URL=https://api.openai.com/v1`, and `OAI_API_KEY=<token>`; document that any OpenAI-compatible endpoint can be used by changing `-base-url` and `-model`; ensure no hard dependency on OpenAI SDKs (pure net/http).
* [x] Implement tool manifest loader `internal/tools/manifest.go`: load `tools.json`; schema per tool `{ "name": string (required, unique), "description": string, "schema": object (JSON Schema for params), "command": [string,...] (argv, required), "timeoutSec": int (optional per-call) }`; validate: name non-empty, command len>=1, names unique; build a registry `map[string]ToolSpec` and an OpenAI “tools” array `[{type:"function", function:{name,description,parameters}}]`; return both; on parse/validation error, fail fast with clear message including tool name.
* [x] Implement secure tool runner `internal/tools/runner.go`: execute tools via `exec.CommandContext(ctx, argv[0], argv[1:]...)`; pass function arguments string verbatim to tool stdin (JSON), capture stdout (string) and stderr; apply timeout: prefer per-tool `timeoutSec`, else global `-timeout`; scrub environment to a minimal allowlist (PATH and HOME only); never invoke a shell; return stdout as the tool result string; on timeout return error "tool timed out", on non-zero exit return error including stderr snippet.
* [x] Implement assistant tool-call loop in `main.go`: request includes `tool_choice:"auto"` and declared tools; when assistant message contains `tool_calls`, iterate each call with `type:"function"`, find spec by `function.name`; if unknown, synthesize a tool result `{"error":"unknown tool <name>"}`; for each executed call, append a message `{role:"tool", name:<function.name>, tool_call_id:<id>, content:<tool stdout or error JSON>}`; then immediately call the API again with the extended transcript; stop when assistant returns content and zero tool_calls; print content to stdout.
* [x] Map tool failures deterministically to JSON error content: on any runner error, set tool message content to a single-line JSON `{"error":"<sanitized message>"}` where message is JSON-escaped and truncated (e.g., to 1k chars) to avoid prompt bloat; do not exit on individual tool errors—let the model decide recovery; only exit non-zero if the overall run loop ends without producing final assistant text or if the HTTP call fails.
* [x] Provide example tool `tools/get_time.go` and build instructions: implements `stdin` JSON `{"tz":"Europe/Helsinki"}` (default `"UTC"` if omitted); outputs single-line JSON `{"tz":"...","iso":"RFC3339","unix":<seconds>}` to stdout; returns exit code 0 on success; build with `go build -o tools/get_time ./tools/get_time.go`; usage example prompt: “What’s the local time in Helsinki? If tools are available, call get_time.”; confirm tool respects `TZ` value strictly via `time.LoadLocation`.
* [x] Provide example `tools.json` colocated at repo root: `{ "tools":[ { "name":"get_time", "description":"Get current time for an IANA timezone", "schema":{ "type":"object", "properties":{ "tz":{"type":"string","description":"IANA timezone, e.g. Europe/Helsinki"} }, "required":["tz"], "additionalProperties":false }, "command":["./tools/get_time"], "timeoutSec":5 } ] }`; document that `command` is relative to the working directory of `agentcli`.
* [x] Add build targets: root `Makefile` with `build: go build -o bin/agentcli ./cmd/agentcli`, `build-tools: go build -o tools/get_time ./tools/get_time.go`, `lint`, `test`, `clean`; ensure `CGO_ENABLED=0` for reproducible static binaries; support `GOOS`/`GOARCH` overrides for cross-compilation; add `bin/` and built tools to `.gitignore`.
* [x] Write README quickstart that is fully runnable: prerequisites (Go 1.21+), `make build build-tools`, export `OAI_BASE_URL`, `OAI_MODEL=oss-gpt-20b`, `OAI_API_KEY` if required, then run `./bin/agentcli -prompt "What's the local time in Helsinki? Use get_time." -tools ./tools.json -debug`; explain expected behavior (model triggers function call, tool prints JSON, agent posts back, model replies with final text), and show sample output line and non-zero exit behavior on errors.
* [x] Add ADR-0001 documenting architecture and protocol: create `docs/adr/0001-minimal-agent-cli.md` containing context (non-interactive CLI agent with OpenAI-compatible API and local tools), options considered (Go vs Python vs local inference), decision (Go + Chat Completions tools + argv tools), rationale (static binary, process control, vendor-agnostic), consequences (no streaming in MVP, single-threaded tool calls), and a link to the canonical GitHub issue; include explicit contracts for CLI flags and tool I/O in the ADR.
* [x] Add Mermaid sequence diagram kept in repo: `docs/diagrams/agentcli-seq.md` with a `sequenceDiagram` that shows CLI → API → tool → API → final response; reference this file from both `README.md` and ADR-0001; require updates to diagram in any PR that changes the loop or message flow.
* [x] Implement unit tests (deterministic) for manifest, runner, and client: `internal/tools/manifest_test.go` verifies invalid/missing fields and uniqueness errors; `internal/tools/runner_test.go` includes a helper tool binary that sleeps to trigger timeout and asserts `"tool timed out"` mapping; `internal/oai/client_test.go` uses `httptest.Server` to return 500 and asserts error includes status and body; tests must run offline and pass on `go test ./...`.
* [x] Implement conversation-loop test using `httptest.Server` and a fake tool: server step 1 responds with assistant message containing `tool_calls=[{id:"1",type:"function",function:{name:"echo",arguments:"{\"text\":\"hi\"}"}}]`; fake tool reads stdin `{"text":"hi"}` and prints `{"echo":"hi"}`; server step 2 returns final assistant message `"done"`; run `agentcli` main via a small wrapper (or extract loop into testable function) and assert stdout equals `"done\n"` and exit code 0.
* [x] Document security posture and trust boundaries in README: tools are an explicit allowlist (`tools.json`); no shell invocation (argv only); stdin/stdout JSON contract; per-call timeouts; minimal environment; recommend running untrusted tools under containment (container/jail/user namespace) and setting a working directory with restricted permissions; clarify that the model is untrusted input—never pass its arguments to a shell; state that secrets must be supplied via env/CI secrets and never committed.
* [x] Output an error if any configured tool is missing and unavailable
* [x] Improve .cursor/rules/work-on-features.mdc to instruct that files must be deleted using `git rm ...` command
* [x] Implement `tools/exec.go` (unrestricted command exec) — stdin `{"cmd":"string","args":["..."],"cwd?:string,"env?:{K:V},"stdin?:string,"timeoutSec?:int}`; run via `exec.CommandContext` (no shell), full network allowed; stdout single-line JSON `{"exitCode":int,"stdout":"string","stderr":"string","durationMs":int}`; DoD: TDD unit + integ tests (success, non-zero, timeout, cwd/env, stdin), README example, traced to issue, CI green with coverage unchanged.
* [x] Implement `tools/fs_read_file.go` — stdin `{"path":"string","offsetBytes?:int,"maxBytes?:int}` (repo-relative); outputs `{"contentBase64":"string","sizeBytes":int,"eof":bool}`; DoD: tests (text, binary round-trip, ranges, NOT_FOUND), docs example, link to issue, CI green.
* [x] Implement `tools/fs_write_file.go` (atomic write) — stdin `{"path":"string","contentBase64":"string","createModeOctal?":"0644"}`; write via temp+rename; outputs `{"bytesWritten":int}`; DoD: tests (create, overwrite, binary, missing parent error), docs example, CI green.
* [x] Implement `tools/fs_append_file.go` — stdin `{"path":"string","contentBase64":"string"}`; append (create if missing) with advisory file lock; outputs `{"bytesAppended":int}`; DoD: tests (double append, concurrent writers), docs example, CI green.
  - [x] [S01] stub types and argument validation for fs_append_file (repo-relative path, base64 decode)
  - [x] [S02] failing contract test for double append (create-if-missing, then append)
  - [x] [S03] minimal passing implementation for single-writer append with advisory lock (no concurrency test yet)
  - [x] [S04] add concurrent writers test (two goroutines append deterministically; order-agnostic content length assertion)
  - [x] [S05] strengthen implementation to pass concurrency test and add README docs example
* [x] Implement `tools/fs_mkdirp.go` — stdin `{"path":"string","modeOctal?":"0755"}`; recursively create; outputs `{"created":bool}`; DoD: tests (deep path, idempotence), docs example, CI green.
  - [x] [S01] implement minimal mkdirp behavior and docs example; tests pass offline
* [x] Implement `tools/fs_rm.go` — stdin `{"path":"string","recursive?:bool,"force?:bool}`; remove file/dir; outputs `{"removed":bool}`; DoD: tests (file, dir tree, force on missing), docs example, CI green.
  - [x] [S01:rm-delete-file-test] failing unit test for deleting a regular file
  - [x] [S02:rm-delete-file-impl] minimal implementation to delete a regular file and pass S01
  - [x] [S03:rm-force-on-missing-test] unit test for force=true on missing path (expects exit 0 and removed=false)
  - [x] [S04:rm-readme-example] README example and Makefile build rule for fs_rm; tests pass
* [x] Implement `tools/fs_move.go` — stdin `{"from":"string","to":"string","overwrite?:bool}`; rename or copy+remove across devices; outputs `{"moved":bool}`; DoD: tests (rename, overwrite=false blocks, cross-device), docs example, CI green.
  - [x] [S03:move-overwrite-true] unit test for overwrite=true replacing existing destination; ensure implementation passes
* [x] Add docs/README.md as a short index and navigation for the docs tree with cross links to docs/adr/0001-minimal-agent-cli.md and docs/diagrams/agentcli-seq.md, smallest change is creating the index and adding links from the top level README and ADR, scope limited to documentation, low risk and independent, DoD includes tests unchanged and green with no coverage regression, build reproducible, static analysis type checks formatting linting security scanning and secret detection all green, backward compatibility unaffected, docs updated in the same change, at least one peer review completed and linked, verification by rendering links on GitHub, rollback by reverting the file and cross links, traceability 
  - [x] [S01:docs-index] create `docs/README.md` index with links to ADR-0001 and sequence diagram
  - [x] [S02:cross-links] add links from top-level `README.md` and ADR-0001 back to `docs/README.md`
* [x] Write docs/architecture/module-boundaries.md to define allowed imports and layering between cmd internal/oai internal/tools and tools binaries, include a simple Mermaid diagram and guidance for adding new packages, smallest change is adding this single document and linking it from docs/README.md and README, scope documentation, low risk, DoD includes tests unchanged and green with no coverage regression all quality gates green backward compatibility preserved docs and changelog updated as needed peer review completed verification by rendering diagram on GitHub and checking links rollback by reverting the doc and links, traceability 
  - [x] [S01:module-boundaries-doc] add module-boundaries doc and cross‑links from `README.md` and `docs/README.md`
* [x] Keep Makefile clean target symmetrical with build-tools by also removing tools/fs_search (currently omitted) so stale tool binaries are not left behind; smallest change is adding tools/fs_search to the clean recipe; scope Makefile; low risk; DoD includes running make build-tools then make clean leaves no built tool binaries (git status clean), tests unchanged and green, all quality gates green, peer review completed, verification by the described commands, rollback by reverting the Makefile change.
* [x] Reconcile minimum Go version by setting a single supported floor across go.mod and README.md (go.mod currently declares go 1.24.6 while README states Go 1.21+); smallest change is either lowering the go directive in go.mod to 1.21 to match docs or updating README (and future CI matrix) to 1.24+; scope limited to go.mod, docs, and CI config when added; low risk; DoD includes tests unchanged and green with no coverage regression, reproducible build, all quality gates green (vet/format/lint/security/secret detection) with no new findings, backward compatibility preserved, at least one peer review completed, verification by building on the declared floor version locally and in CI, rollback by reverting the version/doc change.
* [x] Update README.md fs_mkdirp example to remove the outdated note “until aggregated in Makefile” and use the existing make build-tools step consistently; smallest change is editing that section only; scope documentation; low risk; DoD includes tests unchanged and green, all quality gates green, README renders correctly on GitHub, peer review completed, verification by running the example from a clean clone after make build build-tools, rollback by reverting the edit.
* [ ] Align the get_time tool contract across tools/timecli (expects {"timezone":"..."} and outputs {"timezone","iso8601"}), README.md (describes tz and unix seconds), and tools.json (declares required tz) by choosing one canonical schema (prefer timezone with optional alias tz) and updating code, tests, and docs accordingly; smallest change is adding a backward-compatible alias in code and adjusting docs/manifest; scope limited to this tool; low risk; DoD includes unit test covering both inputs and output fields, README quick start and tools.json updated, all quality gates green with no coverage regression, peer review completed, verification by running the quick start end-to-end, rollback by reverting the edits.
* [ ] Normalize API key environment variable naming across the repo to OAI_API_KEY (scripts like scripts/smoke-test.sh currently reference OPENAI_API_KEY) and document the canonical variable in README.md while keeping the old name as a fallback for compatibility; smallest change is updating the script to prefer OAI_API_KEY with OPENAI_API_KEY fallback and adjusting docs; scope small; low risk; DoD includes tests unchanged and green, all gates green, verification by running the script with only OAI_API_KEY set and observing successful auth header injection, rollback by reverting the script and doc changes.
* [ ] Create docs/reference/tools-manifest.md that precisely documents the tools.json schema required and optional fields validation rules examples and common mistakes and how schemas are exposed to the model, smallest change is a focused reference page and links from README usage and ADR-0001, scope documentation, low risk, DoD includes examples runnable locally tests unchanged and green all quality gates green backward compatibility unaffected peer review completed verification by running example commands and rendering on GitHub rollback by removing the doc and links, traceability 
  - [ ] [S01:manifest-doc] create `docs/reference/tools-manifest.md` reference page
  - [ ] [S02:manifest-links] add links from `README.md`, `docs/README.md`, and ADR-0001
* [ ] Author docs/security/threat-model.md expanding on trust boundaries untrusted model output handling tool containment recommendations secrets handling logging and redaction expectations and audit considerations, smallest change is adding this page and linking it from README Security model, scope documentation, low risk, DoD includes tests unchanged and green all quality gates green backward compatibility unaffected peer review completed verification by reviewing content accuracy and link rendering rollback by reverting the doc and links, traceability 
* [ ] Provide docs/runbooks/troubleshooting.md covering common errors and fixes including missing tool binaries repo relative path violations tool timeouts HTTP errors and golangci-lint installation path with copy paste commands, smallest change is adding this runbook and linking from README Troubleshooting, scope documentation, low risk, DoD includes steps verified on a clean clone tests unchanged and green all quality gates green peer review completed verification by following steps locally rollback by reverting the doc and links, traceability 
* [ ] Fix tools/timecli error contract to write errors to stderr and exit non-zero instead of printing error JSON to stdout so the runner maps failures to {"error":"..."} deterministically; smallest change is adjusting error paths in tools/timecli/main.go and adding focused unit tests; scope limited to timecli and tests; low risk; DoD includes failing test first then passing after change, README examples still work, tests elsewhere unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by piping invalid input and observing non-zero exit with stderr JSON, rollback by reverting the edits.
* [ ] Reconcile model identifier in README quick start with default OAI_MODEL by choosing one canonical value (currently README uses openai/gpt-oss-20b while defaults use oss-gpt-20b) and updating docs accordingly; smallest change is editing README only; scope documentation; low risk; DoD includes docs render correctly, examples runnable from a clean clone, tests unchanged and green, all quality gates green, peer review completed, verification by running the quick start with the documented model, rollback by reverting the edit.
* [ ] Stop tracking generated tool binaries under tools/ by adding .gitignore entries and removing existing binaries from version control with git rm --cached while keeping them in the working tree, and ensure Makefile clean target removes them; smallest change is updating .gitignore and running git rm --cached on tools/get_time tools/exec tools/fs_* tools/fs_search; scope repository hygiene; low risk; DoD includes running make build-tools then git status shows no modified or untracked binary artifacts, tests unchanged and green, all quality gates green, peer review completed, verification by the described commands, rollback by reverting the ignore change and re-adding binaries if necessary.
* [ ] Implement `tools/fs_search.go` — stdin `{"query":"string","regex?:bool,"globs?:["**/*.go"],"maxResults?:int}`; returns `{"matches":[{"path":"string","line":int,"col":int,"preview":"string"}],"truncated":bool}`; DoD: tests (literal, regex, glob filter, truncation), docs example, CI green.
  - [x] [S01:search-failing-literal-test] add failing unit test for literal search on a small fixture file (no regex, no globs)
  - [x] [S02:search-skeleton] scaffold minimal `tools/fs_search` program with argument parsing/types
  - [x] [S03:search-impl-literal] minimal implementation to pass literal search test
  - [x] [S04:search-regex-glob-tests] add tests for regex and glob filtering
  - [ ] [S05:search-truncation] implement maxResults truncation and test
* [ ] Update scripts/smoke-test.sh to remove goresearch and SearxNG checks and make it goagent-specific retaining only the OpenAI-compatible LLM health check and clarifying messages; smallest change is editing the script header and deleting the Searx section; scope scripts; low risk; DoD includes script runs locally and reports PASS/FAIL for LLM reachability without Docker or Searx, tests unchanged and green, all quality gates green, peer review completed, verification by executing the script on a clean clone, rollback by reverting the script change.
* [ ] Implement `tools/fs_apply_patch.go` (unified diff) — stdin `{"unifiedDiff":"string"}`; strict apply (no fuzz), pre-validate with dry-run; outputs `{"filesChanged":int}`; DoD: tests (clean apply, conflict, idempotence, CRLF), docs example + cautions, CI green.
* [ ] Extend `tools.json` with new tools — add entries (name, description, JSON Schema, `command`, `timeoutSec`); loader must validate and surface schemas to OpenAI tools; DoD: manifest unit test (schema validity, names unique), sample `tools.json` updated, CI green.
* [ ] Add Makefile build rules for all new tools — `build-tools` compiles each `./tools/*.go` to deterministic static binaries; DoD: `make build build-tools` passes locally and CI, artifacts gitignored, docs updated.
* [ ] Integrate tools into agent loop — ensure `agentcli` advertises schemas and executes tool calls end-to-end; DoD: integration test with fake API that triggers `fs_write_file` → `fs_read_file` → final message, README cross-referenced, CI green.
* [ ] Standardize JSON error contract for all tools — on failure, write single-line stderr `{"error":"<escaped>","hint?":"<opt>"}` and exit non-zero; runner maps to tool message; DoD: negative-path tests per tool, docs snippet, CI green.
* [ ] Add execution audit log in runner — append ndjson `{ts,tool,argv,cwd,exit,ms,stdoutBytes,stderrBytes,truncated}` to `.goagent/audit/YYYYMMDD.log`; DoD: unit test writes/rotates, redaction respected (see next), docs, CI green.
* [ ] Implement log redaction — configurable patterns/keys in runner (mask env and output: e.g., tokens); DoD: tests proving masking for env and stdout/stderr, README config section, CI green.
* [ ] Provide “capabilities” CLI (`agentcli -capabilities`) — prints enabled tools from `tools.json` and explicit warning that enabled tools allow arbitrary command execution and network access; DoD: unit test, README usage, CI green.
* [ ] Update README with “unrestricted tools” warning + examples — clear risk note, copy-paste examples for each fs/* and exec tool, troubleshooting; DoD: docs lint passes, examples exercised in CI script, CI green.
* [ ] Add ADR-0002 “Unrestricted toolbelt (files+network)” — context, options, decision, consequences, JSON contracts, link to issue; DoD: ADR committed, referenced from README, peer-reviewed, CI doc checks green.
* [ ] Add Mermaid diagram `docs/diagrams/toolbelt-seq.md` — sequence of CLI → API → tools → API → final; DoD: diagram renders on GitHub, referenced from README/ADR, updated test ensuring file exists, CI green.
* [ ] CI smoke job for tools — workflow builds tools, runs each binary with sample stdin, and runs an agent loop against a fake API; no external network dependence; DoD: green in PRs, artifacts attached, linked to issue.
* [ ] Example prompts `examples/unrestricted.md` — prompts demonstrating `exec` + fs tools to write, build, and run code; DoD: examples validated by CI script, README link, CI green.
* [ ] Implement tools/fs_edit_range.go — stdin {"path":"string","startByte":int,"endByte":int,"replacementBase64":"string","expectedSha256?":"string"}; atomically rewrite by splicing the range; output {"bytesReplaced":int,"newSha256":"string"}; DoD: TDD for mid-file edits, boundary cases (start=0, end=size), binary content, concurrent calls serialized, docs + CI green.
* [ ] Implement tools/fs_read_lines.go — stdin {"path":"string","startLine":int,"endLine":int,"maxBytes?":int}; output {"content":"string","startLine":int,"endLine":int,"eof":bool}; DoD: TDD for LF/CRLF, UTF-8 multibyte safety, large files, docs + CI green.
* [ ] Implement `tools/fs_listdir.go` — stdin `{"path":"string","recursive?:bool,"globs?:["**/*"],"includeHidden?:bool,"maxResults?:int}`; outputs `{"entries":[{"path":"string","type":"file|dir|symlink","sizeBytes":int,"modeOctal":"string","modTime":"RFC3339"}],"truncated":bool}`; paths repo-relative, stable ordering (dirs first, then files, lexicographic); DoD: TDD (empty dir, files+dirs, hidden on/off, glob filters, recursion, truncation, symlink entry), README example, linked issue, CI green with coverage unchanged.
* [ ] Implement `tools/fs_stat.go` — stdin `{"path":"string","followSymlinks?:bool,"hash?: "none"|"sha256"}`; outputs `{"exists":bool,"type":"file|dir|symlink|other","sizeBytes":int,"modeOctal":"string","modTime":"RFC3339","sha256?":"string"}`; error on paths outside repo; DoD: TDD (file/dir/symlink, missing path, follow vs no-follow, optional hash), README example, linked issue, CI green.
