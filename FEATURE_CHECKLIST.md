* [ ] Initialize repo with Go module and scaffolding: run `mkdir agentcli && cd agentcli && git init && go mod init github.com/<org>/agentcli`; add `LICENSE` (MIT), `README.md` (purpose, usage, examples), `.gitignore` (bin/, dist/, .DS_Store, go.work, .idea, .vscode); create directories `cmd/agentcli`, `internal/oai`, `internal/tools`, `docs/adr`, `docs/diagrams`; set default model id `oss-gpt-20b` and default OpenAI-compatible base URL `https://api.openai.com/v1` to be read from env or flags.
* [x] Implement `cmd/agentcli/main.go` non-interactive run loop: `package main` with `main()` reading flags, building initial messages `[system,user]`, calling the HTTP client, executing any returned tool calls, appending tool results as `role=tool` messages, repeating until the model returns a final assistant message with text, then printing to stdout and exiting 0; all failures print a concise error to stderr and exit non-zero (2 for CLI misuse like missing `-prompt`, 1 otherwise).
* [x] Implement full CLI flag set with defaults and env fallbacks: `-prompt (string, required)`, `-tools (path to tools.json, optional)`, `-system (string, default "You are a helpful, precise assistant. Use tools when strictly helpful.")`, `-base-url (string, default env OAI_BASE_URL or https://api.openai.com/v1)`, `-api-key (string, default env OAI_API_KEY)`, `-model (string, default env OAI_MODEL or oss-gpt-20b)`, `-max-steps (int, default 8)`, `-timeout (duration, default 30s, applies to HTTP and tool exec unless tool overrides)`, `-temp (float64, default 0.2)`, `-debug (bool, default false, dumps request/response JSON to stderr)`; precedence: flag > env > hard default; validate `-prompt` non-empty before running.
* [x] Implement OpenAI-compatible client (POST `/v1/chat/completions`): define request types `{model, messages[], tools[], tool_choice:"auto", temperature}` and response types `{choices[].message{role,content,tool_calls[]}, choices[].finish_reason}`; send `Authorization: Bearer <api-key>` if provided; `Content-Type: application/json`; use `http.Client{Timeout: <timeout>}`; treat any non-2xx as error with body included; support `finish_reason` but not required to stop if you already have final content; never stream in MVP.
* [x] Wire default config for oss-gpt-20b: honor `OAI_MODEL=oss-gpt-20b`, `OAI_BASE_URL=https://api.openai.com/v1`, and `OAI_API_KEY=<token>`; document that any OpenAI-compatible endpoint can be used by changing `-base-url` and `-model`; ensure no hard dependency on OpenAI SDKs (pure net/http).
* [x] Implement tool manifest loader `internal/tools/manifest.go`: load `tools.json`; schema per tool `{ "name": string (required, unique), "description": string, "schema": object (JSON Schema for params), "command": [string,...] (argv, required), "timeoutSec": int (optional per-call) }`; validate: name non-empty, command len>=1, names unique; build a registry `map[string]ToolSpec` and an OpenAI “tools” array `[{type:"function", function:{name,description,parameters}}]`; return both; on parse/validation error, fail fast with clear message including tool name.
* [x] Implement secure tool runner `internal/tools/runner.go`: execute tools via `exec.CommandContext(ctx, argv[0], argv[1:]...)`; pass function arguments string verbatim to tool stdin (JSON), capture stdout (string) and stderr; apply timeout: prefer per-tool `timeoutSec`, else global `-timeout`; scrub environment to a minimal allowlist (PATH and HOME only); never invoke a shell; return stdout as the tool result string; on timeout return error "tool timed out", on non-zero exit return error including stderr snippet.
* [x] Implement assistant tool-call loop in `main.go`: request includes `tool_choice:"auto"` and declared tools; when assistant message contains `tool_calls`, iterate each call with `type:"function"`, find spec by `function.name`; if unknown, synthesize a tool result `{"error":"unknown tool <name>"}`; for each executed call, append a message `{role:"tool", name:<function.name>, tool_call_id:<id>, content:<tool stdout or error JSON>}`; then immediately call the API again with the extended transcript; stop when assistant returns content and zero tool_calls; print content to stdout.
* [x] Map tool failures deterministically to JSON error content: on any runner error, set tool message content to a single-line JSON `{"error":"<sanitized message>"}` where message is JSON-escaped and truncated (e.g., to 1k chars) to avoid prompt bloat; do not exit on individual tool errors—let the model decide recovery; only exit non-zero if the overall run loop ends without producing final assistant text or if the HTTP call fails.
* [x] Provide example tool `tools/get_time.go` and build instructions: implements `stdin` JSON `{"tz":"Europe/Helsinki"}` (default `"UTC"` if omitted); outputs single-line JSON `{"tz":"...","iso":"RFC3339","unix":<seconds>}` to stdout; returns exit code 0 on success; build with `go build -o tools/get_time ./tools/get_time.go`; usage example prompt: “What’s the local time in Helsinki? If tools are available, call get_time.”; confirm tool respects `TZ` value strictly via `time.LoadLocation`.
* [x] Provide example `tools.json` colocated at repo root: `{ "tools":[ { "name":"get_time", "description":"Get current time for an IANA timezone", "schema":{ "type":"object", "properties":{ "tz":{"type":"string","description":"IANA timezone, e.g. Europe/Helsinki"} }, "required":["tz"], "additionalProperties":false }, "command":["./tools/get_time"], "timeoutSec":5 } ] }`; document that `command` is relative to the working directory of `agentcli`.
* [ ] Add build targets: root `Makefile` with `build: go build -o bin/agentcli ./cmd/agentcli`, `build-tools: go build -o tools/get_time ./tools/get_time.go`, `lint`, `test`, `clean`; ensure `CGO_ENABLED=0` for reproducible static binaries; support `GOOS`/`GOARCH` overrides for cross-compilation; add `bin/` and built tools to `.gitignore`.
* [x] Write README quickstart that is fully runnable: prerequisites (Go 1.21+), `make build build-tools`, export `OAI_BASE_URL`, `OAI_MODEL=oss-gpt-20b`, `OAI_API_KEY` if required, then run `./bin/agentcli -prompt "What's the local time in Helsinki? Use get_time." -tools ./tools.json -debug`; explain expected behavior (model triggers function call, tool prints JSON, agent posts back, model replies with final text), and show sample output line and non-zero exit behavior on errors.
* [x] Add ADR-0001 documenting architecture and protocol: create `docs/adr/0001-minimal-agent-cli.md` containing context (non-interactive CLI agent with OpenAI-compatible API and local tools), options considered (Go vs Python vs local inference), decision (Go + Chat Completions tools + argv tools), rationale (static binary, process control, vendor-agnostic), consequences (no streaming in MVP, single-threaded tool calls), and a link to the canonical GitHub issue; include explicit contracts for CLI flags and tool I/O in the ADR.
* [x] Add Mermaid sequence diagram kept in repo: `docs/diagrams/agentcli-seq.md` with a `sequenceDiagram` that shows CLI → API → tool → API → final response; reference this file from both `README.md` and ADR-0001; require updates to diagram in any PR that changes the loop or message flow.
* [ ] Implement unit tests (deterministic) for manifest, runner, and client: `internal/tools/manifest_test.go` verifies invalid/missing fields and uniqueness errors; `internal/tools/runner_test.go` includes a helper tool binary that sleeps to trigger timeout and asserts `"tool timed out"` mapping; `internal/oai/client_test.go` uses `httptest.Server` to return 500 and asserts error includes status and body; tests must run offline and pass on `go test ./...`.
* [ ] Implement conversation-loop test using `httptest.Server` and a fake tool: server step 1 responds with assistant message containing `tool_calls=[{id:"1",type:"function",function:{name:"echo",arguments:"{\"text\":\"hi\"}"}}]`; fake tool reads stdin `{"text":"hi"}` and prints `{"echo":"hi"}`; server step 2 returns final assistant message `"done"`; run `agentcli` main via a small wrapper (or extract loop into testable function) and assert stdout equals `"done\n"` and exit code 0.
* [ ] Add lint/type checks and formatting gates: include `.golangci.yml` enabling `govet`, `gofmt`, `errcheck`, `staticcheck`, `gocyclo` (with reasonable thresholds), `gosimple`; add `make lint` that installs `golangci-lint` if missing and runs it; ensure `go vet ./...` and `gofmt -s -l` produce no output; fail CI if any lints fail.
* [ ] Configure GitHub Actions CI to enforce quality gates: `.github/workflows/ci.yml` with jobs on push/PR that set up Go 1.21+, cache modules, run `make lint`, `go test -race -cover ./...`, and `make build build-tools`; upload `bin/agentcli` as an artifact; set `permissions: contents: read` and fail the build on any non-zero step; matrix over `os: [ubuntu-latest, macos-latest, windows-latest]`.
* [ ] Add release workflow for static binaries and checksums: `.github/workflows/release.yml` triggered on tags like `v*`; build `agentcli` for `linux,darwin,windows` × `amd64,arm64` with `CGO_ENABLED=0`; name outputs `agentcli_<os>_<arch>` (Windows `.exe`); generate `SHA256SUMS` and `SHA256SUMS.sig` (optional GPG); create GitHub Release and upload artifacts and checksums; document in README how to download and verify.
* [x] Document security posture and trust boundaries in README: tools are an explicit allowlist (`tools.json`); no shell invocation (argv only); stdin/stdout JSON contract; per-call timeouts; minimal environment; recommend running untrusted tools under containment (container/jail/user namespace) and setting a working directory with restricted permissions; clarify that the model is untrusted input—never pass its arguments to a shell; state that secrets must be supplied via env/CI secrets and never committed.
* [ ] Tag and publish `v0.1.0` once CI is green and docs/tests are complete: ensure `README.md` has usage, examples, and limitations (no streaming, sequential tool calls only); ADR-0001 and sequence diagram present; unit and integration tests passing; create annotated tag `git tag -a v0.1.0 -m "MVP non-interactive agent CLI with OpenAI-compatible tools"` and `git push --tags`.
