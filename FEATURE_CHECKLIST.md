* [x] Pre-stage timeouts: inherit `-prep-http-timeout` from the existing `-http-timeout` (and `OAI_PREP_HTTP_TIMEOUT` env) instead of falling back to deprecated `-timeout`. Remove any mention of `-timeout` in pre-stage. DoD: unit tests show `-prep-http-timeout` > `OAI_PREP_HTTP_TIMEOUT` > `-http-timeout` > default; help/README updated.
* [x] Pre-stage param knobs follow one-knob rule + capability map: add `-prep-top-p` and reuse the existing model capability map to omit `temperature` (or `top_p`) when unsupported; also reuse the 400 “parameter-recovery” retry once for the pre-stage. DoD: table tests cover presence/omission and the 400→retry flow; docs note parity with main call.
  - [x] Introduce a minimal pre-stage HTTP call before the main loop that builds an `oai.ChatCompletionsRequest` using `cfg.prepHTTPTimeout`, applies one‑knob logic (`-prep-top-p` vs temperature), and reuses the existing client (for 400 temperature recovery); return messages unchanged to keep behavior stable.
* [x] Pre-stage uses the same message-sequence validator: run the existing validator that forbids stray `role:"tool"` and enforces `tool_call_id` matching during the pre-processing loop, too. DoD: failing test with a stray tool message in pre-stage; passing after wiring; troubleshooting doc mentions both stages.
* [x] Parallel tool-calls in pre-stage: execute multiple `tool_calls[]` concurrently during pre-processing, just like the main loop. DoD: concurrency test with two pre-stage tool calls of different latency; transcript contains exactly one `tool` message per id.
* [x] Restrict pre-stage tools to built-in read-only adapters (no external commands by default): expose only in-process tools `fs.read_file`, `fs.list_dir`, `fs.stat`, `env.get`, `os.info` under a separate pre-stage tool registry; ignore `-tools` for pre-stage unless explicitly overridden by `-prep-tools-allow-external`. DoD: attempting to write or exec in pre-stage deterministically returns an error; security doc updated.
* [x] If `-prep-tools-allow-external` is enabled, reuse manifest rules: resolve the pre-stage manifest relative to its own file, require `./tools/bin/*` (Windows `.exe` honored), and enforce the existing escape/`..` rejection and cross-platform path normalization. DoD: unit tests mirror `internal/tools/manifest_*` for the pre-stage path.
* [x] Audit + structured logs include `stage:"prep"` with HTTP timings and idempotency key: reuse your current NDJSON audit schema and emit the same timing fields and `Idempotency-Key` for the pre-stage call. DoD: test asserts one prep entry with `{stage:"prep", timings..., idempotency_key}` at repo root `.goagent/audit/`.
* [x] Config dump shows pre-stage config: extend `-print-config` to include `prep` block (model, base URL, http timeout, retries/backoff, temperature/top_p resolved and sources). Env precedence: `OAI_PREP_*` > main flag/env where applicable; API key fallback chain `OAI_PREP_API_KEY` → `OAI_API_KEY` → `OPENAI_API_KEY`. DoD: unit test snapshots config; README examples updated.
* [x] Channel printing harmonized with current debug/quiet behavior: default print only `assistant{channel:"final"}` to stdout; `-verbose` prints `critic`/`confidence` to stderr without interleaving raw JSON; `-debug` continues to dump raw request/response JSON to stderr after any human-readable channel output; `-quiet` prints just the final text. DoD: formatter tests cover combinations and ordering; help/README table updated.
* [x] Pre-stage cache key expanded to include knobs + tool spec: hash `(prompt/system/developer inputs, prep model/base, temp/top_p effective, retries/backoff, pre-stage tool set or external manifest content hash)`; honor `-prep-cache-bust`. DoD: tests for hit/miss/TTL; docs updated.
BLOCKED: * [ ] ADR numbering + links: add ADR-0004 “Harmony pre-processing & channel-aware output” (to follow your ADR-0003), link from README and docs index; include sequence diagram that reflects parallel tool calls, validator, and audit stages. Reason: ADR-0004 is already used by `docs/adr/0004-default-llm-policy.md`.
  - Next: Use ADR-0005 for “Harmony pre-processing & channel-aware output”, link from README and docs index, and include the sequence diagram.
* [x] Windows suffix + path normalization everywhere: ensure printing/examples show `./tools/bin/NAME.exe` where applicable and path normalization uses `filepath.ToSlash` before validation (already in repo—just reuse). DoD: docs and tests show at least one Windows example; cross-platform tests green.
* [x] One-knob parity in docs and help: clarify that both stages obey “if `--top-p` is set, `temperature` is omitted” and defaults are 1.0 (main) and 1.0 (prep) unless the user selects a `--prep-profile deterministic` (sets temp 0.1 if supported). DoD: help text + docs reflect the rule; unit tests for profiles.
  - [x] Added `-prep-profile` flag with profile→temperature mapping (uses `internal/oai/profile.go`), reflected in help/README/CLI docs; tests added for deterministic profile and one‑knob precedence over profile.
* [x] Roles/precedence merge updated: when CLI provides `-developer`/`-developer-file`, those messages are prepended ahead of any pre-stage developer messages in the final array; system resolution is “CLI `-system` if present, else pre-stage system, else default string” (unchanged). DoD: merge tests for all permutations; README “Roles & precedence” examples updated.
* [x] Pre-stage enable/disable switch and fail-open fallback. Add `-prep-enabled` (default true). On any pre-stage error (network, schema/validator, tool failure, invalid roles), log `WARN:` once to stderr, skip pre-stage, and proceed with original `{system,user}`. DoD: table tests for each failure → fallback; docs show behavior; `-print-config` reflects `prep.enabled`.
* [x] Explicit pre-stage model/endpoint flags. Add `-prep-model`, `-prep-base-url`, `-prep-api-key`, `-prep-http-retries`, `-prep-http-retry-backoff`. Precedence: flag > `OAI_PREP_*` > main-call equivalents > defaults. DoD: unit tests for precedence; `-print-config` shows resolved prep block; README updated.
* [x] Role input flags not yet in CLI. Implement `-developer` (repeatable), `-developer-file` (repeatable), plus `-prompt-file` and `-system-file` (each mutually exclusive with their string counterpart; `-` means STDIN). DoD: parser tests (mutual exclusion, repeats, STDIN), help text, examples; merge logic matches your “Roles/precedence” bullet.
* [x] Pre-stage dry-run and message viewing. Add `-prep-dry-run` (run pre-stage only, print refined Harmony messages to stdout, exit 0) and `-print-messages` (pretty-print the final merged message array to stderr before the main call). DoD: snapshot tests; README examples.
* [x] Streaming for assistant\[final]. If server supports streaming, stream only `assistant{channel:"final"}` to stdout; buffer other channels for `-verbose`. DoD: mock streaming test; docs “Streaming” section; `-quiet` still prints just the streamed final.
* [x] Save/load refined messages. `-save-messages path` writes the final merged Harmony array to JSON; `-load-messages path` bypasses pre-stage and `-prompt` using that JSON verbatim (still validator-checked). DoD: round-trip tests; schema doc; conflict errors covered.
* [x] Custom channel routing. `-channel-route name=stdout|stderr|omit` (repeatable) to override defaults (final→stdout, critic/confidence→stderr). Invalid channel/destination → exit 2 with message. DoD: routing matrix tests; help/README updated.
* [x] Pre-stage tools manifest path. Add `-prep-tools path` to point to a (possibly different) manifest; honor all existing manifest validations (anchoring to manifest dir, `./tools/bin/*`, Windows `.exe`, `..` escapes). Works only with `-prep-tools-allow-external`. DoD: unit + integration tests with a nested manifest.
  - Implemented flag parsing, help/CLI docs, cache key preference, and pre-stage manifest selection with `-prep-tools` overriding `-tools` when external tools are allowed. Added unit test `TestPrep_UsesPrepToolsWhenProvided`. Added integration test `TestPrep_Integration_NestedManifestResolution` exercising nested manifest resolution under pre-stage using `httptest.Server`.
* [x] Harmony normalizer. In pre-stage, normalize/validate roles (`system|developer|user|assistant|tool`) and assistant `channel` tokens (ASCII, short). Unknown roles → hard error (triggers fallback); unknown channels → pass through but not auto-printed unless routed. DoD: validator tests and clear errors.
* [x] End-to-end acceptance test. One deterministic test that: (1) runs pre-stage using a mock server returning Harmony with two parallel tool calls (readonly), (2) validates channel routing and message merging, (3) runs the main call to completion. DoD: single test under `cmd/agentcli` green locally without network.
* [x] Implement `tools/cmd/img_create/img_create.go` binary: read stdin JSON `{"prompt":string,"n?:int(1..4 default 1)","size?:string(default \"1024x1024\", pattern ^\\d{3,4}x\\d{3,4}$)","model?:string(default \"gpt-image-1\")","return_b64?:bool(default false)","save?:{"dir":string(repo-relative, required when return_b64=false),"basename?:string(default \"img\"),"ext?:\"png\"}}`; POST `{"model","prompt","n","size","response_format":"b64_json"}` to `${OAI_IMAGE_BASE_URL:-$OAI_BASE_URL}/v1/images/generations` with `Authorization: Bearer $OAI_API_KEY`, `Content-Type: application/json`; on success, if `return_b64` true output `{"images":[{"b64":"..."},...]}` (truncate each b64 to 0 and include `{"hint":"b64 elided"}` unless `-debug-b64` env true), else decode each image, write as `save.dir/save.basename_{001..}.png` atomically and output `{"saved":[{"path":"...","bytes":int,"sha256":"..."}], "n":int,"size":"...","model":"..."}`; on error, write single-line stderr JSON `{"error":"<escaped>","hint?":"<opt>"}` and exit non-zero; strict repo-relative path enforcement, no shell exec; HTTP timeout from `OAI_HTTP_TIMEOUT` (default 120s) and 429/5xx/timeout backoff 2 attempts; DoD: unit tests (happy path with 1×1 PNG b64, missing prompt, invalid dir, API 400, timeout+retry), golden stdout schema, works offline via `httptest.Server` mocking Images API, docs example runnable, `make build-tools` emits `tools/bin/img_create`, lint/tests green.
* [x] Extend tool manifest schema to allow secrets safely: add optional `envPassthrough: ["OAI_API_KEY","OAI_BASE_URL","OAI_IMAGE_BASE_URL","OAI_HTTP_TIMEOUT"]` in `tools.json` per tool; update `internal/tools/manifest.go` to validate string array, normalize keys, and expose it; update `docs/reference/tools-manifest.md` with examples and security cautions (only explicit allowlist is passed to child process); DoD: unit tests for validation and JSON round-trip, docs updated, grep guard in `make verify-manifest-paths` remains green.
* [x] Wire runner to honor `envPassthrough`: in `internal/tools/runner.go` build child env as `PATH,HOME` + `envPassthrough` values from the parent process; add redaction in audit log so values are never logged; DoD: unit test asserts child sees allowed vars and not others, audit NDJSON shows keys but not values, race tests green, docs/security updated.
* [x] Add `img_create` to `tools.json` with JSON Schema: "name":"img_create","description":"Generate image(s) with OpenAI Images API and save to repo or return base64","schema":{"type":"object","required":["prompt"],"properties":{"prompt":{"type":"string"},"n":{"type":"integer","minimum":1,"maximum":4,"default":1},"size":{"type":"string","pattern":"^\\d{3,4}x\\d{3,4}$","default":"1024x1024"},"model":{"type":"string","default":"gpt-image-1"},"return_b64":{"type":"boolean","default":false},"save":{"type":"object","required":["dir"],"properties":{"dir":{"type":"string"},"basename":{"type":"string","default":"img"},"ext":{"type":"string","enum":["png"],"default":"png"}},"additionalProperties":false}},"additionalProperties":false}`, `"command":["./tools/bin/img_create"]`, `"timeoutSec":120`, `"envPassthrough":["OAI_API_KEY","OAI_BASE_URL","OAI_IMAGE_BASE_URL","OAI_HTTP_TIMEOUT"]`; DoD: manifest loads, `agentcli -capabilities` lists tool, reference doc updated, integration test uses this entry.
* [x] Add end-to-end agent integration test: in `cmd/agentcli/tools_integration_test.go`, spin an `httptest.Server` that expects POST `/v1/images/generations` with `{"model":"gpt-image-1","prompt":"tiny-pixel","n":1,"size":"1024x1024","response_format":"b64_json"}` and returns a valid 1×1 PNG `b64_json`; run agent in temp repo with tools.json (envPassthrough wired, fake base URL/key), script the model mock to first return `tool_calls:[{function:{name:"img_create",arguments:"{...save:{dir:\"out\"}}"}}]` then a final assistant text summarizing the saved path; assert: one PNG written under `out/`, stdout == final message, exit 0; DoD: deterministic, no network, Windows/macOS/Linux all green.
* [x] Add README section “Image generation tool (img_create)”: quickstart with `make build-tools`, sample `tools.json` entry, example prompt that instructs the assistant to call `img_create` and save under `assets/`, note on avoiding b64 in transcripts by default, pointer to troubleshooting; DoD: docs render on GitHub, copy-paste works on clean clone.
* [x] Author `docs/reference/img_create.md`: define stdin/out contracts, examples for saving files vs returning b64, parameter table (prompt, n, size, model), HTTP behavior (timeouts/retries), and safety notes; include a cURL of the underlying API for transparency, and link to OpenAI “Images & vision” and “gpt-image-1” docs; DoD: links render, schema matches tools.json, reviewed, CI docs gates green.
BLOCKED: * [ ] Create ADR-0004 “Add minimal OpenAI image generation tool”: Reason: ADR-0004 already exists; ADR-0005 is reserved by line 12. DoD: ADR committed, diagram renders, cross-linked from docs index.
  - Next: Use ADR-0006 for “Add minimal OpenAI image generation tool”; cross-link from docs index and README.
* [x] Update `docs/diagrams/toolbelt-seq.md` (or add `docs/diagrams/img-create-seq.md`) to show: CLI → assistant(tool_calls: img_create) → img_create (HTTP to Images API) → files saved → assistant final; DoD: diagram renders on GitHub, referenced from README and ADR, test asserts file exists.
* [x] Makefile: add `img_create` to `TOOLS` variable so `make build-tools` emits `tools/bin/img_create` (with `.exe` on Windows) and `make clean` removes it; DoD: reproducible builds with `-trimpath`, shasums stable across two runs, CI matrix green.
* [x] Runner troubleshooting entry: add `docs/runbooks/troubleshooting.md` section for image errors (invalid API key, 429 with `Retry-After`, moderation refusal/body 400 mapping, timeout), with concrete remediation (export OAI_API_KEY, raise OAI_HTTP_TIMEOUT, reduce `n`/size); DoD: content verified via tests/mocks, docs links intact.
* [x] Security doc update: expand `docs/security/threat-model.md` with envPassthrough rationale, explicit list of whitelisted vars, note that `img_create` never logs prompts or base64 by default and writes only under repo-relative `save.dir`; DoD: doc renders, threat boundaries diagram updated if present.
* [ ] Add example repo script `examples/image-gen/README.md` + small Go/Makefile snippet to invoke `img_create` directly for manual testing (no agent), storing under `assets/` and printing paths; DoD: copy-paste works, ignored by Git via existing patterns, no CI dependence.
* [ ] Add negative-path contract tests for `img_create`: (a) `return_b64=false` and no `save.dir` ⇒ stderr JSON and exit≠0, (b) non-matching `size` pattern ⇒ stderr JSON, (c) API returns 400 with JSON error ⇒ tool maps to stderr JSON; DoD: tests green, coverage unchanged.
* [ ] Optional pass-through extras (forward-compat): support optional `extras?:object` that is shallow-merged into the API body for known unsafe-to-omit keys (e.g., `"background":"transparent"` if/when supported); validate `extras` is a simple map of string→primitive, strip anything else; DoD: unit tests for include/strip behavior, docs note that extras are best-effort and may be ignored by the API.
* [ ] `agentcli -capabilities` output: ensure `img_create` appears with its description and an explicit warning that it makes outbound network calls and can save files; DoD: unit test asserting printed line contains `img_create` and warning, README snippet updated.
* [ ] Enforce transcript hygiene: add a pre-flight validator in `cmd/agentcli` that, when `-debug` is off, truncates any tool message content over 8KB (e.g., if a future config sets `return_b64=true`), replacing with `{"truncated":true,"reason":"large-tool-output"}` before sending to the API; DoD: unit test for truncation, docs mention safeguard.
* [ ] Add Windows/macOS/Linux path tests for `save.dir` correctness and SHA-256 reporting (use `tools/testutil/MakeRepoRelTempDir`), and verify image bytes are identical to decoded b64; DoD: platform-agnostic tests green across CI matrix.
