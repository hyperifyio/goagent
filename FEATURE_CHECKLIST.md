* [x] Fix errcheck warnings by handling or asserting error returns in tests currently flagged by golangci-lint (e.g., internal/oai/client_test.go writes and cmd/agentcli/main_test.go json Encode/Setenv/Unsetenv), smallest change is editing only those tests to check errors or add narrowly justified nolint comments, scope lint hygiene (tests only), low risk, DoD includes `make lint` passing with errcheck clean and tests unchanged and green with no coverage regression, all quality gates green, peer review completed, verification by running `make lint` and observing no errcheck diagnostics in those files, rollback by reverting the test edits.
* [x] Remove the inadvertently committed root-level `agentcli` binary and prevent reintroduction by adding `agentcli` (and Windows `agentcli.exe`) to `.gitignore`; smallest change is `git rm agentcli` and appending two ignore entries; scope repository hygiene; low risk; DoD includes `git ls-files --error-unmatch agentcli` failing, `make build` producing `bin/agentcli` as documented, `git status` clean after builds across OSes, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verification by running those commands; rollback by reverting the `.gitignore` edit and restoring the file if necessary.
* [x] Remove tracked lint artifacts `lint.err` and `lint_verify.err` and add ignore entries for them in `.gitignore` to keep the working tree clean after lint runs; smallest change is `git rm` those files and append two ignore lines; scope repository hygiene; low risk; DoD includes `git status` clean after `make lint`, tests unchanged and green with no coverage regression, all quality gates green, peer review completed; verification by running `make lint` and observing no new tracked `*.err` files; rollback by reverting the `.gitignore` edit and re-adding the files if required.
* [x] Fix errcheck warnings in production code by handling or asserting error returns currently flagged in non-test packages (e.g., cmd/agentcli/main.go writePrepCache calls, internal/oai/client.go resp.Body.Close/io.ReadAll, tools/cmd/img_create/*.go Encode/Close/Remove); smallest change is adding error checks or narrowly justified ignores where safe; scope limited to non-test packages and tool binaries; low risk and independent; DoD includes make lint passing with no errcheck diagnostics in these files, tests unchanged and green with no coverage regression, all quality gates green; verify by running make lint and confirming errcheck clean; rollback by reverting the edits.
* [x] Reduce cyclomatic complexity of tools/cmd/img_create/img_create.go function run (gocyclo=54) by extracting small helpers for input parse/validate, API request/response handling, file writes, and stdout JSON; no behavior change; scope single tool; low–moderate effort; DoD includes golangci-lint gocyclo no longer flagging run (>20), make lint and tests passing, coverage unchanged, peer review completed; verify via golangci-lint output and go test; rollback by reverting the refactor.
* [x] Reduce cyclomatic complexity of internal/tools/runner.RunToolWithJSON (gocyclo=21) by extracting environment construction and process execution into focused helpers without changing semantics; scope internal/tools only; low effort and independent; DoD includes golangci-lint gocyclo clean for this function, make lint and tests passing, coverage unchanged; verify via golangci-lint and go test; rollback by reverting the refactor.
* [x] Remove the staticcheck SA9003 empty branch in cmd/agentcli/main.go around the pre-stage block (~line 673) by deleting the no-op branch or consolidating logic; scope single file; low risk and independent; DoD includes make lint passing with no SA9003 warning, tests green with no coverage regression, all quality gates green; verify by rerunning make lint and confirming staticcheck clean; rollback by reverting the line-level change.
* [x] Ignore editor swap files and remove the stray .FEATURE_CHECKLIST.md.swp: append a *.swp entry to .gitignore (minimal change) and delete the existing file; scope repository hygiene; low risk and independent; DoD includes git status clean after editing with Vim (no new tracked *.swp), git ls-files --error-unmatch .FEATURE_CHECKLIST.md.swp fails, tests and lint unchanged and green with no coverage regression, all quality gates green; verify by creating and saving a file in Vim and observing no tracked swap file; rollback by reverting the .gitignore edit and restoring the file if necessary.
* [x] Correct the README fs_search example to match the tool schema: replace invalid keys (path, pattern, glob, caseInsensitive) with query (string), globs (array of file globs), and regex (boolean), and remove path since fs_search scans the repository root; smallest change is editing README only; scope documentation; low risk and independent; DoD includes the updated example running successfully on a clean clone (producing expected matches), tests and lint unchanged and green with no coverage regression, all quality gates green; verify by running the example exactly as shown; rollback by reverting the README edit.
* [x] **Tool: http_fetch (safe HTTP/HTTPS fetcher)** — File `tools/cmd/http_fetch/http_fetch.go`; **stdin** `{"url":string,"method?":"GET|HEAD","max_bytes?":1048576,"timeout_ms?":10000,"decompress?":true}`, **stdout** `{"status":int,"headers":object,"body_base64?":string,"truncated":bool}`; allow only http/https, stream with hard **byte cap**, ≤5 redirects, preserve `ETag/Last-Modified`, **SSRF guard** as above, UA `agentcli-http-fetch/0.1`; **env** optional `HTTP_TIMEOUT_MS`; **errors** stderr JSON; **audit** `{tool:"http_fetch",url_host,status,bytes,truncated,ms}`; **manifest** add entry with schema and `envPassthrough:["HTTP_TIMEOUT_MS"]`; **Makefile** add to `TOOLS`; **tests** redirects, gzip body, truncation, SSRF block, HEAD; **docs** ref page; **DoD:** build, tests, lint, capabilities OK, docs render.
* [x] **ADR-0010: Adopt SearXNG & network research toolbelt (CLI-only)** — Add `docs/adr/0010-research-tools-searxng.md` describing context (need credible web discovery + provenance), options (direct engine APIs vs meta-search vs scraping), **decision** (SearXNG + small CLI subtools), consequences (operate with SSRF guard, robots respect, retries), and a Mermaid flow (agentcli→tool_calls→fetch/parse→citation); link from `README.md` and `docs/README.md`; **DoD:** file renders on GitHub with diagram, links resolve, no code changes, `make lint test` green.
* [x] **Tool: searxng_search (meta search over the web)** — We have SarxNG running at http://localhost:8888. Create `tools/cmd/searxng_search/searxng_search.go` → `tools/bin/searxng_search(.exe)`; **stdin** `{"q":string,"time_range?":"day|week|month|year","categories?":[string],"engines?":[string],"language?":string,"page?":int,"size?":int<=50}`, **stdout** `{"query":string,"results":[{"title":string,"url":string,"snippet":string,"engine":string,"published_at?":string}]}`; GET `${SEARXNG_BASE_URL}/search?format=json&q=...` with 10s timeout, ≤5 redirects, **retries** 2 on timeout/429/5xx (respect `Retry-After`), **SSRF guard** (block loopback/RFC1918/link-local/IPv6 ::1 & DNS-rebinding), UA `agentcli-searxng/0.1`; **env** required `SEARXNG_BASE_URL`, optional `HTTP_TIMEOUT_MS`; **errors**: single-line stderr JSON `{"error":"...","hint?":"..."}` + exit≠0; **audit** append NDJSON `{ts,tool:"searxng_search",url_host,query,status,ms,retries}` under `.goagent/audit/YYYYMMDD.log` (redact query if >256 chars → `query_truncated:true`); **manifest**: append to root `tools.json` `"name":"searxng_search","description":"Meta search via SearXNG","schema":<stdin JSON Schema>,"command":["./tools/bin/searxng_search"],"timeoutSec":15,"envPassthrough":["SEARXNG_BASE_URL","HTTP_TIMEOUT_MS"]` (Windows uses `.exe`); **Makefile**: add to `TOOLS += searxng_search`; **tests**: offline using `httptest.Server` fixtures for success, 429 with `Retry-After`, 5xx then success, SSRF blocked, bad base URL; **docs**: `docs/reference/searxng_search.md` with examples; **DoD:** `make build-tools` produces binary, `go test ./...` & `make lint` green, `agentcli -capabilities` lists tool, docs render.
* [x] **Tool: robots_check (robots.txt evaluator)** — `tools/cmd/robots_check/robots_check.go`; **stdin** `{"url":string,"user_agent?":"agentcli"}`, **stdout** `{"allowed":bool,"crawl_delay_ms?":int,"group_rules":[string]}`; fetch `<origin>/robots.txt` with internal safe GET (5s), RFC 9309 precedence (UA-specific then `*`), no redirects to non-origin, cache in-process for test, **SSRF guard** applies; **env** none; **errors** stderr JSON; **audit** `{tool:"robots_check",origin,allowed,ms}`; **manifest** add entry; **Makefile** add; **tests** fixtures covering allow/deny precedence, UA match, Crawl-delay; **docs** page with examples; **DoD:** build/tests/lint green, doc render.
* [x] **Tool: readability_extract (article extraction)** — `tools/cmd/readability_extract/readability_extract.go`; **stdin** `{"html":string,"base_url":string}` (≤5 MiB), **stdout** `{"title":string,"byline?":string,"text":string,"content_html":string,"length":int}` using `github.com/go-shiori/go-readability`; **env** none; **errors** stderr JSON; **audit** `{tool:"readability_extract",length,ms}`; **manifest** add entry; **Makefile** add; **tests** article vs nav-heavy fixtures, large HTML rejected; **docs** page; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: metadata_extract (OG/Twitter/JSON-LD)** — `tools/cmd/metadata_extract/metadata_extract.go`; **stdin** `{"html":string,"base_url":string}`, **stdout** `{"opengraph":object,"twitter":object,"jsonld":[any]}`; **errors/audit/manifest/Makefile/docs/tests** similar pattern; **tests** cover all three metadata types; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: pdf_extract (PDF text, optional OCR)** — `tools/cmd/pdf_extract/pdf_extract.go`; **stdin** `{"pdf_base64":string,"pages?":[int]}` (≤20 MiB), **stdout** `{"page_count":int,"pages":[{"index":int,"text":string}]}` via `github.com/ledongthuc/pdf`; if `ENABLE_OCR=true` and page is image-only, shell to `tesseract` (if absent emit stderr JSON `"OCR_UNAVAILABLE"`), 10s/page cap; **SSRF** N/A; **audit** `{tool:"pdf_extract",page_count,ms}`; **manifest** include `envPassthrough:["ENABLE_OCR"]`; **Makefile** add; **tests** normal text PDF, image-only PDF without OCR, with OCR (mock), oversize rejects; **docs**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: rss_fetch (RSS/Atom)** — `tools/cmd/rss_fetch/rss_fetch.go`; **stdin** `{"url":string,"if_modified_since?":string}`, **stdout** `{"feed":{"title":string,"link":string},"items":[{"title":string,"url":string,"published_at?":string,"summary?":string}]}`; conditional GET (pass If-Modified-Since), 5s timeout, **SSRF guard**; **errors/audit/manifest/Makefile/docs/tests**; **tests** RSS, Atom, 304 path; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: wayback_lookup (Internet Archive)** — `tools/cmd/wayback_lookup/wayback_lookup.go`; **stdin** `{"url":string,"save?":false}`, **stdout** `{"closest_url?":string,"timestamp?":string,"saved?":bool}`; call `https://web.archive.org/save/` when `save=true` and `.../available?url=...` for lookup, 3s timeout, 1 retry w/ jitter on 5xx; **audit** `{tool:"wayback_lookup",saved:boolean,ms}`; **manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: wiki_query (MediaWiki summaries/search)** — `tools/cmd/wiki_query/wiki_query.go`; **stdin** `{"titles?":string,"search?":string,"language?":"en"}`, **stdout** `{"pages":[{"title":string,"url":string,"extract":string}]}`; call MediaWiki action API extracts/opensearch per input, 5s timeout, language fallback to `"en"` if miss; **errors/audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green, docs render.
* [x] **Tool: openalex_search (scholarly works)** — `tools/cmd/openalex_search/openalex_search.go`; **stdin** `{"q":string,"from?":string,"to?":string,"per_page?":10}`, **stdout** `{"results":[{"title":string,"doi?":string,"publication_year":int,"open_access_url?":string,"authorships":[...],"cited_by_count":int}],"next_cursor?":string}`; GET `https://api.openalex.org/works?...` (no key), 8s timeout, retries 1; **audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] **Tool: crossref_search (DOI metadata)** — `tools/cmd/crossref_search/crossref_search.go`; **stdin** `{"q":string,"rows?":10}`, **stdout** `{"results":[{"title":string,"doi":string,"issued":string,"container":string,"title_short?":string}]}`; require `CROSSREF_MAILTO` (send polite header), 8s timeout; **audit/manifest (envPassthrough:["CROSSREF_MAILTO"])/Makefile/docs/tests** including quota handling; **DoD:** build/tests/lint green.
* [x] **Tool: github_search (repos/code/issues/commits)** — `tools/cmd/github_search/github_search.go`; **stdin** `{"q":string,"type":"repositories|code|issues|commits","per_page?":10}`, **stdout** `{"results":[...minimal per type...],"rate":{"remaining":int,"reset":int}}`; optional `GITHUB_TOKEN` (bearer), inspect `X-RateLimit-Remaining`, map 0 to stderr JSON `{"error":"RATE_LIMITED","hint":"use GITHUB_TOKEN"}`; 8s timeout, 1 retry on 5xx; **audit/manifest (envPassthrough:["GITHUB_TOKEN"])/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] **Tool: dedupe_rank (near-duplicate detector)** — `tools/cmd/dedupe_rank/dedupe_rank.go`; **stdin** `{"docs":[{"id":string,"url?":string,"title?":string,"text?":string,"published_at?":string}]}`, **stdout** `{"groups":[{"representative_id":string,"members":[string],"score":number}]}`; MinHash (3-shingles) + TF-IDF tie-break; optional `AUTHORITY_HINTS_JSON` to bias ranking; **errors/audit/manifest/Makefile/docs/tests** with deterministic golden; **DoD:** build/tests/lint green.
* [x] **Tool: citation_pack (normalize + archive)** — `tools/cmd/citation_pack/citation_pack.go`; **stdin** `{"doc":{"title?":string,"url":string,"published_at?":string},"archive?":{"wayback?":bool}}`, **stdout** `{"title?":string,"url":string,"host":string,"accessed_at":string,"archive_url?":string}`; if `archive.wayback`, call Wayback lookup (3s), otherwise skip network; **errors/audit/manifest/Makefile/docs/tests**; **DoD:** build/tests/lint green.
* [x] Update `wiki_query` tool schema in `./tools.json` to remove the top-level `oneOf` (OpenAI requires the root to be `{ "type": "object" }` with no `oneOf/anyOf/allOf/enum/not` at the top); set `parameters` **exactly** to `{ "type":"object", "additionalProperties": false, "properties": { "titles": { "type":"string", "description":"Exact page title to fetch summary for (mutually exclusive with 'search')" }, "search": { "type":"string", "description":"Full-text search term to find pages (mutually exclusive with 'titles')" }, "language": { "type":"string", "default":"en", "description":"MediaWiki language code, e.g. en, fi" } } }` and remove the previous `oneOf`; if your tool handlers require mutual exclusivity, enforce it **at runtime** in the `wiki_query` executor (reject when both/neither provided with a clear error string returned as the tool result); verify the JSON with `jq -e '.tools[] | select(.function.name=="wiki_query") | .function.parameters as $p | ($p.type=="object") and (has("oneOf")|not) and (has("anyOf")|not) and (has("allOf")|not) and (has("not")|not) and (has("enum")|not)' ./tools.json >/dev/null`; DoD: running `./bin/agentcli -prompt "ping" -base-url http://api.openai.com.hg.fi/v1 -model gpt-5 -tools ./tools.json -max-steps 1` no longer returns `invalid_function_parameters` and the chat request is accepted (HTTP 200), and the `jq` check passes.
* [x] **Reference & contracts (single page for all research tools)** — Add `docs/reference/research-tools.md` enumerating **each tool’s** stdin/out JSON, required envs, exit codes (0 ok; non-zero with stderr JSON), SSRF/timeout/retry rules, and copy-paste examples; link from main README; **DoD:** page renders with anchors to all tools; `make lint` green.
* [x] **Security posture for research tools** — Add `docs/security/research-tools.md` detailing SSRF allowlist/denylist (block loopback, RFC1918/4193, link-local, `.onion`), robots compliance expectations, outbound UA strings, audit NDJSON fields and **redaction policy**, and guidance for sandboxing tools when used with untrusted prompts; link from `docs/security/threat-model.md`; **DoD:** page renders, links resolve, `make lint` green.
* [x] **Research pipeline diagram** — Add `docs/diagrams/research-pipeline.md` (Mermaid `flowchart`) showing `agentcli → tool_calls → (searxng_search → http_fetch → readability/metadata/pdf/rss) → dedupe_rank → citation_pack → assistant(final)`; link from ADR-0010 and `docs/README.md`; **DoD:** diagram renders on GitHub; links resolve.
* [x] **Runbook: troubleshooting research tools** — Extend `docs/runbooks/troubleshooting.md` with a new section covering: missing envs (`SEARXNG_BASE_URL`, `CROSSREF_MAILTO`), SSRF block messages, 429 with `Retry-After` handling, robots disallow, response truncation (`max_bytes`), and network timeouts (raising `HTTP_TIMEOUT_MS`); **DoD:** content renders; `rg` finds section header; lint green.
* [x] **Examples (manual, no agent)** — Add `examples/research/README.md` with commands like `echo '{"q":"golang"}' | ./tools/bin/searxng_search` and `echo '{"url":"https://..." }' | ./tools/bin/http_fetch | jq .status`, plus a **fixtures-only** test command pinned to `httptest.Server` scripts (commented to avoid network in CI); **DoD:** examples render; no CI network usage.
* [x] **Makefile wiring per tool** — For each tool you implement, append its name to `TOOLS += ...`, ensure `make build-tools` emits `tools/bin/<name>(.exe)` with `-trimpath` and deterministic flags, ensure `make clean` removes it; **DoD:** running `make build-tools clean` leaves `git status` clean, build repeatable (same shasum across two builds).
* [x] Add a link to the main README.md about following the project by following the author at Linkedin (https://www.linkedin.com/in/jheusala/)
* [x] Add global HTTP retry knobs: implement `-http-retries int` (env `OAI_HTTP_RETRIES`, default `2`) and `-http-retry-backoff duration` (env `OAI_HTTP_RETRY_BACKOFF`, default `500ms`) in `cmd/agentcli/flags.go`; wire into the main OpenAI client in `internal/oai/client.go` so all chat/completions use these values; keep precedence `flag > env > default`; update `--help` text in `cmd/agentcli/main.go`; DoD: `go run ./cmd/agentcli --help` shows both flags with precedence notes and defaults, unit test `cmd/agentcli/flags_test.go` table-driven verifies precedence and defaulting.
* [x] Add image API endpoint flags: implement `-image-base-url string` (env `OAI_IMAGE_BASE_URL`, default inherit `-base-url`) and `-image-api-key string` (env `OAI_IMAGE_API_KEY`, default inherit `-api-key` with fallback to `OPENAI_API_KEY`) in `cmd/agentcli/flags.go`; define a new `ImageConfig` struct in `internal/oai/config.go` with resolved values; ensure `-print-config` redacts keys (show last 4 chars only); DoD: `--help` lists both flags and inheritance, `-print-config` prints redacted `image.api_key`, test `internal/oai/config_test.go` verifies inheritance and redaction.
* [x] Add image HTTP behavior flags: implement `-image-http-timeout duration` (env `OAI_IMAGE_HTTP_TIMEOUT`, default inherit `-http-timeout`), `-image-http-retries int` (env `OAI_IMAGE_HTTP_RETRIES`, default inherit `-http-retries`), and `-image-http-retry-backoff duration` (env `OAI_IMAGE_HTTP_RETRY_BACKOFF`, default inherit `-http-retry-backoff`) in `cmd/agentcli/flags.go`; ensure `internal/tools/image/client.go` (or HTTP wrapper) uses these resolved values; DoD: `--help` shows three flags and inheritance, unit tests verify inheritance chain and concrete values applied to HTTP client.
* [x] Expose common Images API parameters as flags (pass-through): add `-image-n int` (env `OAI_IMAGE_N`, default `1`), `-image-size string` (env `OAI_IMAGE_SIZE`, default `1024x1024`), `-image-quality string` (env `OAI_IMAGE_QUALITY`, enum `standard|hd`, default `standard`), `-image-style string` (env `OAI_IMAGE_STYLE`, enum `natural|vivid`, default `natural`), `-image-response-format string` (env `OAI_IMAGE_RESPONSE_FORMAT`, enum `url|b64_json`, default `url`), `-image-transparent-background` (env `OAI_IMAGE_TRANSPARENT_BACKGROUND`, default `false`); map 1:1 to request payload in the image driver; DoD: `--help` lists all with defaults/enums, unit tests assert payload fields equal CLI/env values.
BLOCKED: * [ ] Add image model flag: implement `-image-model string` (env `OAI_IMAGE_MODEL`, default `"gpt-image-1"`) in `cmd/agentcli/flags.go`; plumb to `internal/tools/image/driver_openai.go` (or analogous file invoking the Images API) so requests use this model; DoD: `--help` shows flag, unit test stubs the image driver and asserts received model equals CLI value and equals default when unset. Reason: `cmd/agentcli` and `internal/tools/image` do not exist in this repository.
* [x] [S01:image-model-flag-parse] In `cmd/agentcli/main.go::{cliConfig,parseFlags,printUsage}` add `-image-model string` (env `OAI_IMAGE_MODEL`, default `"gpt-image-1"`) stored as `cliConfig.imageModel` and documented in help; DoD: precedence `flag > env > default` is enforced, `agentcli --help` includes the flag line, `make lint && go test ./cmd/agentcli -run TestImageModelFlagPrecedence` green.
BLOCKED: * [ ] [S02:print-config-image-model] Extend `printResolvedConfig` in `cmd/agentcli/main.go` to include `"model"` under the existing `image` section (value from `cliConfig.imageModel`); DoD: `./bin/agentcli -print-config | jq -e '.image.model=="gpt-image-1"'` passes by default and shows the overridden value when `-image-model` or `OAI_IMAGE_MODEL` is set; tests and lint green. Reason: `cmd/agentcli/main.go` does not exist in this repository.
  - Next: Create a minimal `cmd/agentcli` skeleton exposing `-print-config` and `cliConfig.imageModel` with a basic `printResolvedConfig`, or locate and restore the missing CLI; then implement S02 once the scaffold compiles.
* [x] [S03:image-options-scaffold] Create `internal/tools/image/options.go` with `package image` and `type Options struct { Model string }` plus `func NewOptions(model string) Options`; add `internal/tools/image/options_test.go` verifying `NewOptions("foo").Model=="foo"`; DoD: `go test ./internal/tools/image` green and no new linter findings.
BLOCKED: * [ ] [S04:plumb-model-to-options] Add helper `imageOptionsFromConfig(cfg cliConfig) image.Options` in `cmd/agentcli/main.go` returning `image.NewOptions(cfg.imageModel)`; add `cmd/agentcli/main_test.go::TestImageOptionsFromConfig_Model` asserting pass-through; DoD: build/test/lint green; no behavior change beyond availability of options. Reason: `cmd/agentcli` does not exist in this repository.
  - Next: Locate or restore the missing `cmd/agentcli` CLI and image driver code in this repo or adjust the checklist to target existing `tools/cmd/img_create`; proceed once code is present.
BLOCKED: * [ ] Add image prompt file support (repeatable): implement `-image-prompt string` and `-image-prompt-file string` (repeatable; `'-'` for STDIN) in `cmd/agentcli/flags.go` with mutual exclusivity per source (a single invocation can combine multiple `-image-prompt-file` values but not mix with `-image-prompt`); concatenate in order with `\n\n` to form the final prompt stored in `ImageConfig.Prompt`; DoD: `--help` documents repeatability and `'-'`, unit tests cover (a) multi file order preservation, (b) stdin read, (c) exclusivity error. Reason: `cmd/agentcli` does not exist in this repository.
  - Next: Create a minimal `cmd/agentcli` skeleton with `flags.go` to host image flags so this item can proceed.
BLOCKED: * [ ] Add per-phase tools configuration for image flows: implement `-image-tools string` (path to `tools.json`, optional) and `-image-tools-allow-external` (default `false`) in `cmd/agentcli/flags.go`; when executing the “image” tool call, if `-image-tools-allow-external` and `-image-tools` set, load those tool specs instead of `-tools`; otherwise fall back to `-tools`; DoD: `--help` documents behavior, integration test uses a tiny image tool registry file to prove override occurs only for image calls. Reason: `cmd/agentcli` does not exist in this repository.
  - Next: Create a minimal `cmd/agentcli` skeleton with `flags.go` to host `-image-tools` and `-image-tools-allow-external`, then implement the override behavior.
BLOCKED: * [ ] Ensure `-print-config` includes resolved image and prep sections: extend config printer `cmd/agentcli/print_config.go` to show `chat`, `prep`, and `image` subsections with all resolved knobs (timeouts, retries, backoff, base_url, model, and parameter pass-throughs), redacting any `*_api_key`; DoD: running `-print-config` prints three sections with redactions and inherited values shown concretely. Reason: `cmd/agentcli` does not exist in this repository.
  - Next: Create a minimal `cmd/agentcli` skeleton including `print_config.go` that prints resolved chat/prep/image sections with API keys redacted, then revisit this item.
* [x] Add missing pre-stage sampling knobs for parity: implement `-prep-temp float` (env `OAI_PREP_TEMP`, default inherit `-temp`) and `-prep-top-p float` (env `OAI_PREP_TOP_P`, conflicts with `-prep-temp`; default unset); reuse the existing capability map to omit unsupported params; reuse the 400 “parameter-recovery” one-time retry path for pre-stage when server rejects an unsupported knob; DoD: `--help` shows both with conflict note, unit tests verify omission logic per capability map and retry path invoked on 400.
* [x] Normalize precedence/inheritance rules across chat/prep/image: centralize resolution in `internal/oai/resolve.go` with helpers `ResolveString`, `ResolveDuration`, `ResolveInt`, `ResolveBool` supporting chains like `flag → env → inheritFrom → default`; refactor chat and prep to use the same helpers; DoD: unit tests achieve 100% branch coverage for all helper functions and representative fields across three phases.
* [x] Update the Harmony messages saver/loader to carry image prompts: when `-save-messages` is used and an image prompt is present, embed an auxiliary `"image_prompt"` field; when `-load-messages` is used, if `"image_prompt"` exists and `-image-prompt*` flags are unset, populate `ImageConfig.Prompt`; DoD: round-trip test saves then loads and preserves image prompt verbatim.
BLOCKED: * [ ] Redact API keys consistently in logs and debug dumps: update `-debug` JSON dump path so any `api_key` under chat/prep/image is masked except last 4 characters; include unit tests on the pretty-printed JSON; DoD: enabling `-debug` shows masked keys in stderr and tests assert masking. Reason: `cmd/agentcli` is missing in this repository; the `-debug` JSON dump path does not exist to modify.
  - Next: Create or restore a minimal `cmd/agentcli` that implements the `-debug` JSON dump path, then mask any `api_key` fields using `internal/oai.MaskAPIKeyLast4` and add unit tests for the pretty-printed JSON.
BLOCKED: * [ ] Extend `--capabilities` output to show phase-specific backends: print whether chat/prep/image are targeting the same or different `base_url`/`model` pairs; DoD: running `-capabilities` with divergent `-image-base-url` or `-image-model` shows a distinct “image backend” line. Reason: `cmd/agentcli` CLI is not present in this repository to host the `--capabilities` output.
  - Next: Create or restore a minimal `cmd/agentcli` with `--capabilities` output to host this change, then implement the backend summary line.
* [x] Documentation update: edit `README.md` and the CLI usage section to document all new flags, environment variables, inheritance and precedence, conflict rules (`-temp` vs `-top-p`, `-prep-temp` vs `-prep-top-p`, prompt vs prompt-file), and examples (e.g., separate image backend via `-image-*` while chat goes to another); include copy-paste examples; DoD: README contains a dedicated “Image generation flags” table and an “Inheritance and precedence” matrix; `markdownlint` passes.
* [x] Add deterministic tests for `--help` output: snapshot test `cmd/agentcli/help_test.go` that renders `--help` and asserts presence of all new flags and key phrases (inheritance, conflicts, defaults) to prevent regressions; DoD: test green locally and fails if any flag doc is removed/changed unexpectedly.
* [x] Backward compatibility and error messages: ensure that existing invocations without new flags behave identically (no behavior change); add explicit error messages for conflicting flags and mixed prompt sources; DoD: a small suite in `cmd/agentcli/compat_test.go` runs legacy invocations (no `-image-*`, no `-http-retries`) and asserts identical resolved config vs pre-change baselines; conflict tests assert precise error strings.
* [x] Example configs and smoke scripts: add `examples/image/README.md` with two working commands demonstrating (1) same backend for chat+image and (2) split backends (e.g., OSS chat + OpenAI images); include a `make smoke-image` target that runs the CLI with `-image-response-format b64_json` and verifies a non-empty output stub from the image driver (use a stubbed driver in tests); DoD: `make smoke-image` exits 0 locally and examples copy-paste work with a valid key.
BLOCKED: * [ ] Add flags for pre-stage prompt override: implement `-prep-prompt string` (repeatable) and `-prep-file string` (repeatable; `'-'` for STDIN) in `cmd/agentcli/flags.go`; enforce mutual exclusivity between `-prep-prompt` and `-prep-file`; add env vars `OAI_PREP_PROMPT` and `OAI_PREP_PROMPT_FILE` (comma-separated file list, `-` allowed); precedence is `flag > env > default`; DoD: `agentcli --help` shows both flags and envs incl. exclusivity and precedence, table tests in `cmd/agentcli/flags_test.go` cover (a) multi-file ordering, (b) STDIN read, (c) exclusivity error text, (d) precedence. Reason: `cmd/agentcli` does not exist in this repository.
  - Next: Create a minimal `cmd/agentcli` skeleton with `flags.go` to host pre-stage flags and tests; then implement this item once the CLI scaffold exists.
* [x] Concatenation and normalization of pre-stage prompt: if multiple `-prep-file` or `-prep-prompt` are provided, concatenate in the order seen with `\n\n` separators; trim trailing whitespace; store as `PrepConfig.Prompt` in `internal/oai/config.go`; DoD: unit test `internal/oai/config_test.go::TestPrepPromptConcat` verifies exact joined content and whitespace rules.
* [x] Embed a default “smart prep” prompt: create `assets/prompts/prep_default.md` (content describes goals: derive system prompt, optional developer prompts, tool hints including image generation guidance, and examples; output must be Harmony messages JSON); use `//go:embed assets/prompts/prep_default.md` into `internal/oai/prompts.go`; DoD: file exists with ≥150 lines of clear instructions and one minimal example; unit test asserts non-empty default is loaded when no overrides.
* [x] Resolution logic for pre-stage source: implement `ResolvePrepPrompt()` in `internal/oai/resolve.go` that returns (source: `override|default`, text string); order: (1) `-prep-prompt` joined, (2) `-prep-file` joined, (3) embedded default; DoD: unit tests cover all three branches and verify deterministic results.
* [x] Wire pre-stage prompt into execution: modify `internal/oai/prestage/runner.go` to send `ResolvePrepPrompt()` text as the user message to the pre-stage call (keeping the existing pre-stage system message empty unless capability map requires one); keep existing knobs `-prep-profile`, `-prep-temp`, `-prep-top-p`, `-prep-model`, timeouts, retries; DoD: integration test stubs HTTP and asserts the first pre-stage request’s user content equals resolved prompt.
* [x] Define pre-stage output contract (Harmony): in `docs/harmony-prestage.md`, specify the model must return valid Harmony messages array with optional `system`, zero-or-more `developer`, and optional `tool_config` (names and basic params), and optional `image_instructions`; validator rejects tool calls or `role:"tool"`; DoD: doc committed, validator updated to enforce roles and schema; tests include positive/negative examples.
* [x] Merge pre-stage results into main-call configuration: implement `internal/oai/prestage/merge.go` to (a) replace system prompt if present, (b) append developer prompts, (c) register tool enable/disable hints (respect `-prep-tools-allow-external` safety), (d) capture optional `image_instructions` to pass into image tool as defaults unless overridden by `-image-*`; DoD: unit tests verify each merge behavior and that CLI flags still override merged hints.
* [x] Honor `-prep-dry-run` with new overrides: when `-prep-dry-run` is set, print to stdout the final Harmony messages array that would feed the main call after merging (not just the raw pre-stage output); DoD: golden snapshot test verifies structure and that it reflects overrides and merge rules.
* [x] Extend `-print-messages` and `-save-messages` metadata: include a `"prestage":{"source":"override|default","bytes":N}` field (no prompt text) in the printed/saved JSON; ensure API keys remain redacted; DoD: running with `-print-messages` shows the metadata, tests assert presence and redaction.
* [x] Add `-prep-system` and `-prep-system-file` (optional) for advanced users: allow providing a system message specifically for the pre-stage (repeatable files allowed; exclusivity with `-prep-system` same as prompt/file); precedence `flag > env(OAI_PREP_SYSTEM / OAI_PREP_SYSTEM_FILE) > empty`; DoD: help/docs updated, tests verify precedence and exclusivity; if unset, pre-stage runs without system message (relying on the embedded prompt).
* [x] Capability-map enforcement for pre-stage: reuse main capability map to omit unsupported sampling params (`temperature`/`top_p`) and to opt into `response_format` if server supports JSON mode; DoD: unit tests simulate capability sets and assert omitted/kept fields.
BLOCKED: * [ ] Error handling and user feedback: on invalid pre-stage output (malformed JSON, wrong roles), print a concise error to stderr with a one-line remediation hint and exit code 2 (unless `-prep-enabled=false`); DoD: tests feed bad payloads and assert error text and exit code behavior. Reason: `cmd/agentcli` CLI is missing in this repository, so exit code handling and stderr printing cannot be implemented or tested.
  - Next: Create a minimal `cmd/agentcli` scaffold that executes the pre-stage flow, validates output via `internal/oai/ValidatePrestageHarmony`, and exits with code 2 on invalid payload (with a concise stderr hint); then add tests to assert error text and exit behavior.
BLOCKED: * [ ] Config printer coverage: update `-print-config` to show a `prep` section including `model`, `base_url`, `timeouts/retries/backoff`, `profile`, `source: override|default`, and booleans for `tools_allow_external`; redact any API keys; DoD: manual run shows fields, unit test checks redaction and source flag. Reason: `cmd/agentcli` CLI is missing in this repository to host `-print-config`.
  - Next: Create a minimal `cmd/agentcli` skeleton including `print_config.go` with a `-print-config` handler so the `prep` section can be printed; then implement this item once the scaffold compiles.
BLOCKED: * [ ] README updates and examples: add a “Pre-stage prompt overrides” section with examples: (1) use embedded default only, (2) override via `-prep-file` (multiple files), (3) override via `-prep-prompt`, (4) combine with `-prep-dry-run` for inspection; include an end-to-end example that generates image instructions which the main call then uses; DoD: README builds cleanly and examples copy/paste work with a stub server. Reason: CLI flags `-prep-prompt` and `-prep-file` are not present in this repo's CLI/help; cannot produce working examples.
  - Next: Implement L61 (pre-stage prompt override flags) or confirm flags exist in the shipped CLI, then add the README section and examples as specified.
BLOCKED: * [ ] Backward compatibility guard: add a regression test suite `cmd/agentcli/compat_prestage_test.go` ensuring that when no new flags are passed, behavior matches pre-change baselines (same messages to main call given the same pre-stage answers); DoD: tests green and snapshot differences limited to new metadata fields only. Reason: `cmd/agentcli` CLI is missing in this repository to host tests.
  - Next: Create a minimal `cmd/agentcli` skeleton to host tests, then implement this backward compatibility suite.
BLOCKED: * [ ] Telemetry/verbosity alignment: ensure `-verbose` prints pre-stage validator warnings (if any) and `-quiet` suppresses non-final pre-stage logs; DoD: tests assert routing consistent with existing channel routing (`final→stdout`, others→stderr unless `-quiet`). Reason: `cmd/agentcli` CLI is missing in this repository to host the `-verbose`/`-quiet` flags and output routing.
  - Next: Create or restore a minimal `cmd/agentcli` with flag parsing for `-verbose` and `-quiet`, wire pre-stage logger to route non-final logs to stderr (suppressed when `-quiet`) and warnings when `-verbose`; then implement this item once the scaffold compiles.
* [x] ADR: add `docs/adr/ADR-00XX-prestage-overrides.md` documenting context, options (no override vs files vs flags), decision (flags + embedded default), rationale (maintain simplicity, reproducibility, and DX), and migration (no breaking changes); link to canonical issue; DoD: ADR merged with diagram of flow.
* [x] Mermaid diagram of execution flow: add `docs/diagrams/prestage_flow.md` with a GitHub-compatible Mermaid sequence diagram showing: CLI parse → ResolvePrepPrompt → Pre-stage call → Validate/merge → Main call → Optional image tool usage; DoD: diagram renders in GitHub and matches implementation.
* [x] Help/snapshot tests: update `cmd/agentcli/help_test.go` snapshot to include new flags and key phrases (repeatable, `'-'` for STDIN, exclusivity, precedence); DoD: test fails on doc drift.
* [x] Implement tool and handler for `code.sandbox.js.run`: create `internal/tools/jsrun/handler.go` to accept `{source:string,input:string,limits:{wall_ms:int,output_kb:int}}`; embed Goja VM, `vm.Set("read_input", func() string {…})`, `vm.Set("emit", func(s string){…})`, run via `vm.RunString(source)`; cap output with a bounded buffer; DoD: unit test shows `emit(read_input())` returns input and output > limit is truncated with error. 
* [x] Timeouts with interruption: implement wall-time cancel by running the VM in a goroutine and stopping it via Goja’s interrupt mechanism (set `vm.Interrupt` / supported pattern) or cooperative check wrapper; ensure an interrupt yields a standardized `TIMEOUT`; DoD: test with `for(;;){}` halts within configured `wall_ms` and returns `TIMEOUT`.
* [x] Deny-by-default capability model: do not bind `require`, `console`, timers, or any FS/net; expose only `emit` and `read_input`; add negative tests proving absent globals; DoD: tests verify `typeof require === 'undefined'`, `typeof console === 'undefined'`.
* [x] Structured errors & schema parity with Starlark: map Goja exceptions to `{code:"EVAL_ERROR",message}`; preserve `TIMEOUT` and `OUTPUT_LIMIT` semantics; DoD: tests assert identical error shapes to Starlark tool for analogous failures.
* [x] Docs & examples: add `docs/interfaces/code.sandbox.js.run.md` with usage, security notes, and pitfalls (no timers/Promise unless explicitly added); DoD: doc linked from README; example works via CLI.
* [x] Observability: add logs and span attributes (tool name, wall_ms, bytes_out); DoD: local run shows structured logs and a span `tools.js.run`.
BLOCKED: * [ ] Implement tool and handler for `code.sandbox.wasm.run`: create `internal/tools/wasmrun/handler.go` to accept `{module_b64:string,entry?:string,input:string,limits:{wall_ms:int,mem_pages:int,output_kb:int}}`; decode base64 to bytes, create a wazero runtime, instantiate a minimal host module `env.emit(ptr:uint32,len:uint32)` that reads guest memory and appends to a bounded buffer; instantiate guest with `NewModuleConfig()` and set memory limit pages; call exported function `entry||"main"` under `context.WithTimeout`; DoD: unit test invokes a tiny embedded `.wasm` that writes “ok” via `emit` and returns success; timeout returns `TIMEOUT`; output limit enforced. Reason: No embedded test `.wasm` module available in-repo and no external toolchain; need a precompiled minimal module to satisfy DoD deterministically.
  - Next: Embed a known-good minimal module as base64 in `internal/tools/wasmrun/handler_test.go` that exports `main(ptr,len)` and calls `env.emit` with "ok", then implement wazero execution and tests.
  - [x] [S01:wasmrun-validate-limits] Validate that `limits.output_kb`, `limits.wall_ms`, and `limits.mem_pages` are strictly > 0 with structured `INVALID_INPUT` errors; add table tests.
* [x] Deny WASI by default: do not instantiate WASI; provide only `env.emit` as host import; add negative test that a WASI-dependent module fails with a clear error (`MISSING_IMPORT`); DoD: test passes and error is documented.
BLOCKED: * [ ] Memory safety & limits: configure module to a maximum of `limits.mem_pages` (e.g., 16 MiB = 256 pages) and assert growth beyond limit errors; add test that attempts `memory.grow` over cap → standardized `MEMORY_LIMIT`; DoD: test passes and limit is documented in the interface. Reason: wasm execution engine not implemented; `internal/tools/wasmrun/Run` currently returns UNIMPLEMENTED.
  - Next: Introduce wazero-based execution in `internal/tools/wasmrun/handler.go` with enforced `limits.mem_pages`, and embed a minimal base64 `.wasm` in tests to attempt `memory.grow` beyond the cap and expect `MEMORY_LIMIT`.
* [x] Host memory read correctness: implement helper to locate the guest memory (`api.Module.Memory()`), bounds-check `[ptr:ptr+len)` before reading, and error on OOB; add unit tests for valid and OOB reads; DoD: tests pass and OOB returns standardized `OOB_MEMORY`.
* [ ] Structured errors & schema: map wazero traps (e.g., unreachable) and context cancels to `{code:"TRAP"|"TIMEOUT"|...}`; include `details.trap` when available; DoD: table tests cover trap, timeout, missing import, memory limit, OOB read.
* [ ] Embed a known-good sample module for tests: add a tiny `.wasm` (precompiled and stored as base64 in test file) that exports `main(ptr,len)` and calls `env.emit`; document how it was produced (e.g., TinyGo/Rust, but not built at test time); DoD: tests never hit filesystem or external toolchain and run offline.
* [ ] Observability: log and span attributes (module size bytes, wall_ms, mem_pages_used, bytes_out); DoD: local run shows structured logs and span `tools.wasm.run`.
* [ ] Shared limits & sanitizer: create `internal/sandbox/limits.go` with `BoundedBuffer(maxKB) io.Writer`, wall-time helper, and standard error helpers; vendor (or copy) per tool so each task is independent; DoD: each tool compiles with its own copy and tests verify size/time caps.
* [ ] Security notes & examples: for each tool, add a “Security Model” section to its interface doc stating deny-by-default capabilities and no ambient FS/net/clock; include a minimal example and a malicious loop example that times out; DoD: docs exist and examples execute locally with the respective tool CLI invocation.
* [ ] Introduce `-state-dir` flag (and `AGENTCLI_STATE_DIR` env) to persist and restore generated execution state (prompts, prep_settings, context notes, tool capability decisions); precedence: CLI > env > empty (=disabled); expand `~`, normalize path, create directory with 0700 (respect `umask 077`); update `cmd/agentcli/main.go` flag parsing, config struct, and `-h` help to describe “stores/loads generated execution state across runs”; DoD: `agentcli -h` shows the flag, table-driven test verifies precedence, empty disables persistence, and directory is created with 0700.
* [ ] Define a versioned on-disk “state bundle” schema and filenames; single JSON file per snapshot named `state-<RFC3339UTC>-<8charSHA>.json` containing `{version:"1", created_at, tool_version, model_id, base_url, toolset_hash, scope_key, prompts:{system,developer}, prep_settings:any, context:any, tool_caps:any, custom:any, source_hash}`; maintain atomic pointer file `latest.json` with `{version:"1", path:"state-*.json", sha256}`; permissions 0600 for files; DoD: `internal/state/schema.go` with `StateBundle` type + validation helpers committed and ADR drafted describing schema.
* [ ] Implement atomic save `SaveStateBundle(dir, bundle)`; steps: ensure dir 0700; write temp file in same FS, fsync file, `os.Rename` to final `state-*.json`, write `latest.json` to temp + fsync + rename, fsync directory; never log bundle contents at info level; DoD: unit test using tmpfs/tmdir asserts two files exist, perms are 0600, directory fsync path used, and rename pattern prevents torn writes.
* [ ] Implement safe load `LoadLatestStateBundle(dir)`; read `latest.json`, verify `version=="1"`, open referenced snapshot, validate schema, return `*StateBundle`; on missing/corrupt/unknown-version or permission errors, return `(nil, ErrStateInvalid)` and log at debug; DoD: table tests for ok/missing/corrupt/unknown-version/EPERM with zero panics and clear error values.
* [ ] Add optional `-state-scope` flag (and `AGENTCLI_STATE_SCOPE`) to partition state; compute default `scope_key = sha256(model_id + "|" + base_url + "|" + toolset_hash)`; on save/load only consider bundles whose `scope_key` matches; DoD: unit test shows different model/base or toolset hash yields different scopes and prevents cross-contamination.
* [ ] Wire restore-before-prep behavior; if `-state-dir` is set, load latest matching bundle by `scope_key`; when loaded and `-state-refine` is not set, reuse `prompts.*`, `prep_settings`, `context`, and `tool_caps` instead of calling pre-stage LLM; explicit CLI `-prep-prompt/-prep-file` still override reused prompts; DoD: integration test with a fake LLM shows second run performs zero pre-stage calls and uses restored values.
* [ ] Introduce refinement controls: `-state-refine` (bool), `-state-refine-text` (string), and `-state-refine-file` (path; wins over text if both provided); when set, call pre-stage LLM with deterministic instruction to refine the loaded bundle using the refine input and current user prompt; on success, write a new snapshot and update `latest.json`; mutual exclusivity is enforced between refine-file/text and empty `-state-dir`; DoD: flags visible in help, invalid combos error with exit code 2 and message, unit tests cover matrix.
* [ ] Implement `RefineStateBundle(prev *StateBundle, refineInput string, userPrompt string) (*StateBundle, error)`; requirements: preserve unspecified fields, update `created_at`, recompute `source_hash`, and record `prev_sha`; return new bundle; DoD: unit test with fake LLM verifies prompts/settings changed predictably, fields preserved, `prev_sha` set, and a new file written.
* [ ] Enforce effective-source precedence; compute final values with strict order: explicit CLI (`-prep-prompt/-prep-file`) > refined/restored bundle > built-in defaults; if CLI fully overrides prompts while `-state-refine` is set, warn and proceed (no hard error); DoD: table tests verify resulting source for each field and that warnings are logged once.
* [ ] Security hardening; reject world-writable `-state-dir` and non-owned directories on Unix; apply lightweight redaction before save (strip `Authorization:` header values, 64+ char base64-like tokens, common API key patterns), and never store raw request/response bodies unless `-debug` and `-state-allow-raw` are explicitly set; DoD: unit tests simulate dir perms (0707) causing refusal, and redaction removes secrets from serialized bundles.
* [ ] UX & logging polish; add concise debug logs on save/restore/refine including basename and 8-char SHA; add `--dry-run` to print intended actions (restore/refine/save decisions) without touching disk; DoD: `agentcli --dry-run -debug -state-dir=$TMP` outputs plan and leaves directory empty.
* [ ] E2E scenario test (local, deterministic); 1) Run with `-state-dir=$TMP -state-scope=testscope` to generate and save; 2) Run again with same args to confirm restore (no pre-stage calls); 3) Run with `-state-refine -state-refine-text="tighten temperature to 0.2"` to confirm refinement and new snapshot; assert `latest.json` points to newest, file count increments, and effective prompts follow precedence; DoD: a single `go test ./...` passes and prints no secrets.
* [ ] Backpressure & corruption handling; when `latest.json` points to a missing file or JSON is partially written, auto-quarantine bad files by renaming to `*.quarantined` and continue with regeneration; never delete originals; DoD: unit test seeds corrupt files and verifies quarantine + successful regeneration path.
* [ ] Concurrency & locking; implement coarse-grained advisory file lock (`state.lock`) during save/load to avoid concurrent writers; on lock contention, wait up to 2s with jitter then proceed without crashing; DoD: race test spawns two writers, only one succeeds per snapshot and no partial files are observed.
* [ ] Public docs & ADR; write ADR “Persist and refine execution state via `-state-dir`” with context (need reproducible runs and continuity), options (no persistence vs file store vs DB), decision (file-based JSON bundles with scopes), and rationale (simplicity, testability); include a Mermaid sequence diagram for first-run/restore/refine and copy-pastable CLI examples; update README with usage and security notes; DoD: ADR and README committed, diagram renders on GitHub.

